# IAMç³»ç»Ÿæ¦‚è¦è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
- **åˆ›å»ºæ—¥æœŸ**: 2024å¹´12æœˆ
- **æœ€åæ›´æ–°**: 2024å¹´12æœˆ
- **æ–‡æ¡£çŠ¶æ€**: æ¦‚è¦è®¾è®¡
- **è´Ÿè´£äºº**: æ¶æ„è®¾è®¡å›¢é˜Ÿ

---

## ğŸ¯ æ–‡æ¡£ç›®çš„

æœ¬æ–‡æ¡£æè¿°äº†IAMï¼ˆèº«ä»½ä¸è®¿é—®ç®¡ç†ï¼‰ç³»ç»Ÿçš„æ¦‚è¦è®¾è®¡ï¼ŒåŒ…æ‹¬ç³»ç»Ÿæ¦‚è¿°ã€ä¸šåŠ¡éœ€æ±‚åˆ†æã€é¢†åŸŸåˆ’åˆ†ã€æ¶æ„è®¾è®¡ã€æ ¸å¿ƒå®ä½“å®šä¹‰ç­‰å†…å®¹ã€‚æœ¬æ–‡æ¡£ä¸ºåç»­çš„è¯¦ç»†è®¾è®¡å’Œå¼€å‘å®ç°æä¾›æŒ‡å¯¼ã€‚

**æ ¸å¿ƒæ¶æ„ç†å¿µ**ï¼š
æœ¬ç³»ç»Ÿä¸¥æ ¼éµå¾ª**DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰**å’Œ**Clean Architectureï¼ˆæ•´æ´æ¶æ„ï¼‰**çš„è®¾è®¡åŸåˆ™ï¼Œç¡®ä¿ï¼š
- ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°çš„å®Œå…¨è§£è€¦
- é¢†åŸŸæ¨¡å‹çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§
- ç³»ç»Ÿæ¶æ„çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§
- å¼€å‘å›¢é˜Ÿä¸ä¸šåŠ¡å›¢é˜Ÿçš„ç»Ÿä¸€è¯­è¨€
- é«˜è´¨é‡ã€å¯æµ‹è¯•çš„ä»£ç ç»“æ„

---

## ğŸ“– ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [ä¸šåŠ¡éœ€æ±‚åˆ†æ](#ä¸šåŠ¡éœ€æ±‚åˆ†æ)
3. [é¢†åŸŸåˆ’åˆ†è®¾è®¡](#é¢†åŸŸåˆ’åˆ†è®¾è®¡)
4. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
   4.1 [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
   4.2 [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
   4.3 [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
   4.4 [äº‹ä»¶æº¯æºæ¶æ„](#äº‹ä»¶æº¯æºæ¶æ„-event-sourcing-architecture)
   4.5 [ç¼“å­˜æ¶æ„è®¾è®¡](#ç¼“å­˜æ¶æ„è®¾è®¡-caching-architecture)
   4.6 [è¯·æ±‚è¿½è¸ªä¸ç§Ÿæˆ·ä¸Šä¸‹æ–‡æ¶æ„](#è¯·æ±‚è¿½è¸ªä¸ç§Ÿæˆ·ä¸Šä¸‹æ–‡æ¶æ„-request-tracing--tenant-context-architecture)
   4.7 [MikroORMå¤šæ•°æ®åº“é€‚é…æ¶æ„](#mikroormå¤šæ•°æ®åº“é€‚é…æ¶æ„-mikroorm-multi-database-architecture)
   4.8 [é…ç½®ç®¡ç†æ¶æ„](#é…ç½®ç®¡ç†æ¶æ„-configuration-management-architecture)
   4.9 [Pinoæ—¥å¿—æ¶æ„è®¾è®¡](#pinoæ—¥å¿—æ¶æ„è®¾è®¡-pino-logging-architecture)
5. [æ ¸å¿ƒå®ä½“è®¾è®¡](#æ ¸å¿ƒå®ä½“è®¾è®¡)
6. [ä¸šåŠ¡æµç¨‹è®¾è®¡](#ä¸šåŠ¡æµç¨‹è®¾è®¡)
   6.1 [ç§Ÿæˆ·ç®¡ç†æµç¨‹](#ç§Ÿæˆ·ç®¡ç†æµç¨‹)
   6.2 [ç”¨æˆ·ç®¡ç†æµç¨‹](#ç”¨æˆ·ç®¡ç†æµç¨‹)
   6.3 [æƒé™ç®¡ç†æµç¨‹](#æƒé™ç®¡ç†æµç¨‹)
   6.4 [ç»„ç»‡ç®¡ç†æµç¨‹](#ç»„ç»‡ç®¡ç†æµç¨‹)
   6.5 [ç”³è¯·å®¡æ ¸æµç¨‹](#ç”³è¯·å®¡æ ¸æµç¨‹)
   6.6 [äº‹ä»¶æº¯æºæµç¨‹](#äº‹ä»¶æº¯æºæµç¨‹)
   6.7 [ç¼“å­˜ç®¡ç†æµç¨‹](#ç¼“å­˜ç®¡ç†æµç¨‹)
   6.8 [è¯·æ±‚è¿½è¸ªä¸ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†æµç¨‹](#è¯·æ±‚è¿½è¸ªä¸ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†æµç¨‹)
   6.9 [æ•°æ®åº“é€‚é…ç®¡ç†æµç¨‹](#æ•°æ®åº“é€‚é…ç®¡ç†æµç¨‹)
   6.10 [é…ç½®ç®¡ç†æµç¨‹](#é…ç½®ç®¡ç†æµç¨‹)
   6.11 [æ—¥å¿—ç®¡ç†æµç¨‹](#æ—¥å¿—ç®¡ç†æµç¨‹)
7. [DDDä¸Clean Architectureå®æ–½æŒ‡å—](#dddä¸clean-architectureå®æ–½æŒ‡å—)
8. [æŠ€æœ¯é€‰å‹](#æŠ€æœ¯é€‰å‹)
9. [éåŠŸèƒ½æ€§éœ€æ±‚](#éåŠŸèƒ½æ€§éœ€æ±‚)
10. [é£é™©è¯„ä¼°](#é£é™©è¯„ä¼°)
11. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)

---

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

### 1.1 ç³»ç»Ÿå®šä½

æœ¬ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäº**DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰**å’Œ**Clean Architectureï¼ˆæ•´æ´æ¶æ„ï¼‰**çš„å¤šç§Ÿæˆ·SaaSå¹³å°ï¼Œä¸“æ³¨äºä¼ä¸šçº§èº«ä»½ä¸è®¿é—®ç®¡ç†ï¼ˆIAMï¼‰ã€‚ç³»ç»Ÿé‡‡ç”¨ç§Ÿæˆ·ç®¡ç†æ¨¡å¼ï¼Œæ¯ä¸ªç§Ÿæˆ·æ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®ç©ºé—´å’Œç”¨æˆ·ä½“ç³»ï¼Œç¡®ä¿æ•°æ®éš”ç¦»å’Œå®‰å…¨æ€§ã€‚

**æ ¸å¿ƒæ¶æ„ç†å¿µ**ï¼š
- **DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰**ï¼šä»¥ä¸šåŠ¡é¢†åŸŸä¸ºæ ¸å¿ƒï¼Œé€šè¿‡é¢†åŸŸæ¨¡å‹ã€èšåˆæ ¹ã€é¢†åŸŸæœåŠ¡ç­‰æ¦‚å¿µï¼Œç¡®ä¿ä¸šåŠ¡é€»è¾‘çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§
- **Clean Architectureï¼ˆæ•´æ´æ¶æ„ï¼‰**ï¼šé€šè¿‡åˆ†å±‚æ¶æ„å’Œä¾èµ–å€’ç½®åŸåˆ™ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°çš„è§£è€¦ï¼Œæé«˜ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§

### 1.2 æ ¸å¿ƒä»·å€¼

1. **å¤šç§Ÿæˆ·éš”ç¦»**: ç¡®ä¿ä¸åŒç§Ÿæˆ·æ•°æ®å®Œå…¨éš”ç¦»ï¼Œæ”¯æŒä¼ä¸šçº§æ•°æ®å®‰å…¨
2. **ç»„ç»‡æ¶æ„ç®¡ç†**: æ”¯æŒç§Ÿæˆ·å†…å¤æ‚ç»„ç»‡æ¶æ„ï¼Œæ»¡è¶³å¤§å‹ä¼ä¸šéœ€æ±‚
3. **çµæ´»çš„ç”¨æˆ·ç®¡ç†**: æ”¯æŒç”¨æˆ·å¤šç»„ç»‡å½’å±ï¼Œé€‚åº”å¤æ‚ç»„ç»‡å…³ç³»
4. **ç»†ç²’åº¦æƒé™æ§åˆ¶**: åŸºäºè§’è‰²å’Œç»„ç»‡çš„åŒé‡æƒé™æ§åˆ¶
5. **å®Œæ•´å®¡è®¡è¿½è¸ª**: é€šè¿‡äº‹ä»¶æº¯æºå®ç°å®Œæ•´çš„ä¸šåŠ¡æ“ä½œè¿½è¸ª
6. **è‡ªåŠ¨åŒ–æµç¨‹**: ç®€åŒ–ç§Ÿæˆ·ç”³è¯·å’Œç”¨æˆ·ç®¡ç†æµç¨‹ï¼Œæå‡ç®¡ç†æ•ˆç‡
7. **å®‰å…¨å¯é **: ç¡®ä¿æ•°æ®å®‰å…¨å’Œæ“ä½œå®¡è®¡ï¼Œç¬¦åˆä¼ä¸šå®‰å…¨æ ‡å‡†
8. **ç”¨æˆ·ç§Ÿæˆ·ç®¡ç†**: æ”¯æŒç”¨æˆ·ç§Ÿæˆ·å˜æ›´å’Œè®°å½•è¿½è¸ªï¼Œä¾¿äºç»„ç»‡æ¶æ„è°ƒæ•´

**æ¶æ„ä»·å€¼**ï¼š
9. **ä¸šåŠ¡é©±åŠ¨è®¾è®¡**: é€šè¿‡DDDç¡®ä¿ä¸šåŠ¡é€»è¾‘çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ï¼Œä¸šåŠ¡å˜æ›´æ—¶ç³»ç»Ÿæ¶æ„èƒ½å¤Ÿå¿«é€Ÿå“åº”
10. **æŠ€æœ¯è§£è€¦**: é€šè¿‡Clean Architectureå®ç°ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°çš„è§£è€¦ï¼Œæé«˜ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§
11. **é¢†åŸŸå†…èš**: æ¯ä¸ªé¢†åŸŸæ¨¡å—é«˜åº¦å†…èšï¼ŒèŒè´£æ¸…æ™°ï¼Œä¾¿äºå›¢é˜Ÿåä½œå’ŒåŠŸèƒ½æ‰©å±•
12. **ä¾èµ–å€’ç½®**: é€šè¿‡ä¾èµ–å€’ç½®åŸåˆ™ï¼Œé«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—ï¼ŒæŠ½è±¡ä¸ä¾èµ–å…·ä½“å®ç°

### 1.3 ç³»ç»Ÿç‰¹æ€§

- **å¤šç§Ÿæˆ·æ¶æ„**: æ”¯æŒå¤šç§Ÿæˆ·æ•°æ®éš”ç¦»å’Œç®¡ç†
- **ç»„ç»‡æ¶æ„ç®¡ç†**: æ”¯æŒç§Ÿæˆ·å†…ç»„ç»‡æ¶æ„å»ºç«‹å’Œç®¡ç†
- **å¤šç»„ç»‡ç”¨æˆ·å½’å±**: æ”¯æŒç”¨æˆ·å¤šç»„ç»‡å½’å±å’Œä¸»è¦ç»„ç»‡è®¾ç½®
- **è§’è‰²æƒé™ç®¡ç†**: åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
- **ç»„ç»‡æƒé™ç®¡ç†**: åŸºäºç»„ç»‡çš„æƒé™æ§åˆ¶ï¼ˆOBACï¼‰
- **æƒé™ç»§æ‰¿æœºåˆ¶**: æ”¯æŒç»„ç»‡æƒé™ç»§æ‰¿å’Œè¦†ç›–
- **äº‹ä»¶æº¯æº**: å®Œæ•´çš„ä¸šåŠ¡æ“ä½œäº‹ä»¶è®°å½•å’ŒçŠ¶æ€é‡å»º
- **ç”³è¯·å®¡æ ¸æµç¨‹**: å®Œæ•´çš„ç”³è¯·å’Œå®¡æ ¸æœºåˆ¶
- **å®¡è®¡æ—¥å¿—**: å®Œæ•´çš„æ“ä½œå®¡è®¡å’Œåˆè§„æ€§æ”¯æŒ
- **é«˜å¯ç”¨æ€§**: æ”¯æŒé«˜å¹¶å‘å’Œæ•…éšœæ¢å¤
- **å¯æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³æ‰©å±•å’ŒåŠŸèƒ½æ‰©å±•
- **å¤šæ•°æ®åº“é€‚é…**: æ”¯æŒå¤šç§æ•°æ®åº“å’ŒORMï¼Œé»˜è®¤PostgreSQL+MikroORMï¼Œå¯æ‰©å±•MongoDBç­‰
- **é…ç½®ç®¡ç†**: ç»Ÿä¸€çš„é…ç½®ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒå¤šç¯å¢ƒã€å¤šç§Ÿæˆ·é…ç½®

**æ¶æ„ç‰¹æ€§**ï¼š
- **é¢†åŸŸé©±åŠ¨è®¾è®¡**: åŸºäºä¸šåŠ¡é¢†åŸŸè¿›è¡Œç³»ç»Ÿè®¾è®¡ï¼Œç¡®ä¿ä¸šåŠ¡é€»è¾‘çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§
- **åˆ†å±‚æ¶æ„**: æ¸…æ™°çš„å±‚æ¬¡ç»“æ„ï¼Œæ¯å±‚èŒè´£æ˜ç¡®ï¼Œä¾èµ–å…³ç³»æ¸…æ™°
- **æ¨¡å—åŒ–è®¾è®¡**: æ¯ä¸ªä¸šåŠ¡æ¨¡å—ç‹¬ç«‹ï¼ŒåŒ…å«å®Œæ•´çš„å››å±‚æ¶æ„
- **ä¾èµ–å€’ç½®**: é€šè¿‡æ¥å£å’ŒæŠ½è±¡å®ç°ä¾èµ–å€’ç½®ï¼Œæé«˜ç³»ç»Ÿçš„çµæ´»æ€§
- **äº‹ä»¶é©±åŠ¨**: é€šè¿‡é¢†åŸŸäº‹ä»¶å®ç°æ¨¡å—é—´çš„æ¾è€¦åˆé€šä¿¡
- **èšåˆæ ¹è®¾è®¡**: é€šè¿‡èšåˆæ ¹ç¡®ä¿ä¸šåŠ¡ä¸€è‡´æ€§å’Œæ•°æ®å®Œæ•´æ€§
- **è¯·æ±‚è¿½è¸ª**: æ¯ä¸ªHTTPè¯·æ±‚å…·æœ‰å”¯ä¸€IDï¼Œæ”¯æŒå…¨é“¾è·¯è¿½è¸ª
- **ç§Ÿæˆ·ä¸Šä¸‹æ–‡**: è‡ªåŠ¨è¯†åˆ«å’Œç¼“å­˜ç§Ÿæˆ·IDï¼Œæ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»
- **å¤šæ•°æ®åº“é€‚é…**: æ”¯æŒå¤šç§æ•°æ®åº“å’ŒORMï¼Œé»˜è®¤PostgreSQL+MikroORMï¼Œå¯æ‰©å±•MongoDBç­‰
- **é…ç½®ç®¡ç†**: ç»Ÿä¸€çš„é…ç½®ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒå¤šç¯å¢ƒã€å¤šç§Ÿæˆ·é…ç½®

---

##  ä¸šåŠ¡éœ€æ±‚åˆ†æ

### 2.1 ä¸šåŠ¡åœºæ™¯åˆ†æ

#### 2.1.1 ç§Ÿæˆ·ç®¡ç†åœºæ™¯

**æ ¸å¿ƒä¸šåŠ¡åœºæ™¯**ï¼š
- ç³»ç»Ÿåˆå§‹åŒ–æ—¶è‡ªåŠ¨åˆ›å»ºé»˜è®¤ç³»ç»Ÿç§Ÿæˆ·
- ç”¨æˆ·ç”³è¯·åˆ›å»ºæ–°ç§Ÿæˆ·ç»„ç»‡
- ç§Ÿæˆ·ä¿¡æ¯ç®¡ç†å’Œé…ç½®
- ç§Ÿæˆ·ç®¡ç†å‘˜æ›´æ¢
- ç§Ÿæˆ·åŸŸåç®¡ç†

**å…³é”®ä¸šåŠ¡è§„åˆ™**ï¼š
- åªæœ‰é»˜è®¤ç³»ç»Ÿç§Ÿæˆ·ç”¨æˆ·æ‰èƒ½ç”³è¯·åˆ›å»ºç§Ÿæˆ·
- ç§Ÿæˆ·ä»£ç å’Œåç§°å¿…é¡»å…¨å±€å”¯ä¸€
- æ¯ä¸ªç§Ÿæˆ·æœ‰ä¸”åªèƒ½æœ‰ä¸€ä¸ªç®¡ç†å‘˜
- é»˜è®¤ç³»ç»Ÿç§Ÿæˆ·ä¸èƒ½è¢«åˆ é™¤æˆ–åœç”¨

#### 2.1.2 ç”¨æˆ·ç®¡ç†åœºæ™¯

**æ ¸å¿ƒä¸šåŠ¡åœºæ™¯**ï¼š
- ç”¨æˆ·æ³¨å†Œå’Œæ¿€æ´»
- ç”¨æˆ·ä¸ªäººä¿¡æ¯ç®¡ç†
- ç”¨æˆ·çŠ¶æ€ç®¡ç†
- ç”¨æˆ·ç§Ÿæˆ·å˜æ›´
- å¯†ç ç®¡ç†

**å…³é”®ä¸šåŠ¡è§„åˆ™**ï¼š
- é‚®ç®±åœ°å€å¿…é¡»å…¨å±€å”¯ä¸€
- ç”¨æˆ·åªèƒ½å½’å±ä¸€ä¸ªç§Ÿæˆ·
- ç§Ÿæˆ·ç®¡ç†å‘˜ä¸èƒ½ç”³è¯·ç§Ÿæˆ·å˜æ›´
- å¯†ç å¿…é¡»ç¬¦åˆå®‰å…¨è¦æ±‚

#### 2.1.3 æƒé™ç®¡ç†åœºæ™¯

**æ ¸å¿ƒä¸šåŠ¡åœºæ™¯**ï¼š
- è§’è‰²å®šä¹‰å’Œç®¡ç†
- æƒé™åˆ†é…å’ŒéªŒè¯
- ç”¨æˆ·è§’è‰²ç®¡ç†
- æƒé™ç­–ç•¥ç®¡ç†

**å…³é”®ä¸šåŠ¡è§„åˆ™**ï¼š
- ç³»ç»Ÿç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
- ç§Ÿæˆ·ç®¡ç†å‘˜æ‹¥æœ‰æœ¬ç§Ÿæˆ·æ‰€æœ‰æƒé™
- æƒé™åŸºäºè§’è‰²åˆ†é…
- æƒé™å˜æ›´ç«‹å³ç”Ÿæ•ˆ

#### 2.1.4 ç»„ç»‡ç®¡ç†åœºæ™¯

**æ ¸å¿ƒä¸šåŠ¡åœºæ™¯**ï¼š
- ç§Ÿæˆ·å»ºç«‹å’Œç®¡ç†è‡ªå·±çš„ç»„ç»‡æ¶æ„
- ç»„ç»‡å±‚çº§å…³ç³»ç®¡ç†
- ç”¨æˆ·ç»„ç»‡å½’å±ç®¡ç†
- ç»„ç»‡æƒé™é…ç½®
- ç»„ç»‡æ•°æ®éš”ç¦»

**å…³é”®ä¸šåŠ¡è§„åˆ™**ï¼š
- æ¯ä¸ªç§Ÿæˆ·å¯ä»¥å»ºç«‹è‡ªå·±çš„ç»„ç»‡æ¶æ„
- ç»„ç»‡æ¶æ„æ”¯æŒå¤šå±‚çº§çˆ¶å­å…³ç³»
- ç”¨æˆ·å¿…é¡»è‡³å°‘å½’å±ä¸€ä¸ªç»„ç»‡
- ç”¨æˆ·å¯ä»¥åŒæ—¶å½’å±å¤šä¸ªç»„ç»‡
- æƒé™ç®¡ç†æ”¯æŒåŸºäºç»„ç»‡çš„æƒé™æ§åˆ¶
- ç»„ç»‡é—´æ•°æ®é»˜è®¤éš”ç¦»

### 2.2 ç”¨æˆ·è§’è‰²å®šä¹‰

#### 2.2.1 ç³»ç»Ÿç®¡ç†å‘˜ (System Administrator)
- **èŒè´£**: æ‹¥æœ‰ç³»ç»Ÿæœ€é«˜æƒé™ï¼Œè´Ÿè´£æ•´ä¸ªç³»ç»Ÿçš„ç®¡ç†å’Œç»´æŠ¤
- **æƒé™**: å®¡æ ¸ç§Ÿæˆ·ç”³è¯·ã€ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·å’Œç”¨æˆ·ã€ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€
- **ç‰¹ç‚¹**: å…¨å±€æƒé™ï¼Œä¸å—ç§Ÿæˆ·é™åˆ¶

#### 2.2.2 ç§Ÿæˆ·ç®¡ç†å‘˜ (Tenant Administrator)
- **èŒè´£**: ç‰¹å®šç§Ÿæˆ·çš„ç®¡ç†å‘˜ï¼Œè´Ÿè´£è¯¥ç§Ÿæˆ·å†…éƒ¨çš„ç®¡ç†å·¥ä½œ
- **æƒé™**: ç®¡ç†æœ¬ç§Ÿæˆ·ç”¨æˆ·ã€åˆ†é…ç”¨æˆ·è§’è‰²ã€ç®¡ç†ç§Ÿæˆ·é…ç½®
- **ç‰¹ç‚¹**: ç§Ÿæˆ·çº§æƒé™ï¼Œä»…é™æœ¬ç§Ÿæˆ·

#### 2.2.3 ç»„ç»‡ç®¡ç†å‘˜ (Organization Administrator)
- **èŒè´£**: ç‰¹å®šç»„ç»‡çš„ç®¡ç†å‘˜ï¼Œè´Ÿè´£è¯¥ç»„ç»‡å†…éƒ¨çš„ç®¡ç†å·¥ä½œ
- **æƒé™**: ç®¡ç†æœ¬ç»„ç»‡ç”¨æˆ·ã€é…ç½®ç»„ç»‡æƒé™ã€ç®¡ç†ç»„ç»‡æ•°æ®
- **ç‰¹ç‚¹**: ç»„ç»‡çº§æƒé™ï¼Œä»…é™æœ¬ç»„ç»‡åŠå­ç»„ç»‡

#### 2.2.4 æ™®é€šç”¨æˆ· (Regular User)
- **èŒè´£**: ç³»ç»Ÿçš„åŸºç¡€ç”¨æˆ·ï¼Œä½¿ç”¨ç³»ç»Ÿæä¾›çš„ä¸šåŠ¡åŠŸèƒ½
- **æƒé™**: ä½¿ç”¨ç³»ç»ŸåŠŸèƒ½ã€ç®¡ç†ä¸ªäººä¿¡æ¯ã€ç”³è¯·ç§Ÿæˆ·å˜æ›´
- **ç‰¹ç‚¹**: åŸºç¡€æƒé™ï¼Œå—è§’è‰²ã€ç§Ÿæˆ·å’Œç»„ç»‡é™åˆ¶

---

## ğŸ—ï¸ é¢†åŸŸåˆ’åˆ†è®¾è®¡

### 3.1 é¢†åŸŸåˆ’åˆ†åŸåˆ™

åŸºäº**DDDæ ¸å¿ƒåŸåˆ™**è¿›è¡Œé¢†åŸŸåˆ’åˆ†ï¼Œç¡®ä¿ä¸šåŠ¡é€»è¾‘çš„å®Œæ•´æ€§å’Œç³»ç»Ÿæ¶æ„çš„åˆç†æ€§ï¼š

1. **ä¸šåŠ¡å†…èšæ€§**: ç›¸å…³ä¸šåŠ¡åŠŸèƒ½èšé›†åœ¨åŒä¸€é¢†åŸŸï¼Œç¡®ä¿é¢†åŸŸå†…åŠŸèƒ½çš„é«˜åº¦å†…èš
2. **èŒè´£å•ä¸€æ€§**: æ¯ä¸ªé¢†åŸŸæœ‰æ˜ç¡®çš„èŒè´£è¾¹ç•Œï¼Œé¿å…èŒè´£æ··æ·†å’ŒåŠŸèƒ½é‡å¤
3. **ä½è€¦åˆé«˜å†…èš**: é¢†åŸŸé—´ä¾èµ–æœ€å°åŒ–ï¼Œé¢†åŸŸå†…åŠŸèƒ½é«˜åº¦å†…èš
4. **ä¸šåŠ¡å˜åŒ–ä¸€è‡´æ€§**: åŒä¸€é¢†åŸŸå†…çš„ä¸šåŠ¡å˜åŒ–é¢‘ç‡ç›¸è¿‘ï¼Œä¾¿äºç»Ÿä¸€ç®¡ç†å’Œç»´æŠ¤
5. **å›¢é˜Ÿç»„ç»‡è¾¹ç•Œ**: ä¾¿äºå›¢é˜Ÿåä½œå’ŒèŒè´£åˆ†å·¥ï¼Œæ”¯æŒæ•æ·å¼€å‘æ¨¡å¼
6. **èšåˆæ ¹è®¾è®¡**: æ¯ä¸ªé¢†åŸŸéƒ½æœ‰æ˜ç¡®çš„èšåˆæ ¹ï¼Œç¡®ä¿ä¸šåŠ¡ä¸€è‡´æ€§å’Œæ•°æ®å®Œæ•´æ€§
7. **é¢†åŸŸäº‹ä»¶é©±åŠ¨**: é€šè¿‡é¢†åŸŸäº‹ä»¶å®ç°é¢†åŸŸé—´çš„æ¾è€¦åˆé€šä¿¡
8. **è¾¹ç•Œä¸Šä¸‹æ–‡**: æ˜ç¡®å®šä¹‰é¢†åŸŸè¾¹ç•Œï¼Œé¿å…é¢†åŸŸé—´çš„æ¦‚å¿µæ··æ·†

### 3.2 æ ¸å¿ƒé¢†åŸŸåˆ’åˆ†

#### 3.2.1 ç§Ÿæˆ·é¢†åŸŸ (Tenants Domain)

**é¢†åŸŸèŒè´£**ï¼š
- ç§Ÿæˆ·ç”Ÿå‘½å‘¨æœŸç®¡ç†
- ç§Ÿæˆ·ç”³è¯·å’Œå®¡æ ¸æµç¨‹
- ç§Ÿæˆ·é…ç½®å’ŒåŸŸåç®¡ç†
- ç§Ÿæˆ·çŠ¶æ€ç®¡ç†
- ç§Ÿæˆ·äº‹ä»¶æº¯æº

**å­é¢†åŸŸåˆ’åˆ†**ï¼š
- **management**: ç§Ÿæˆ·çš„ CRUD æ“ä½œã€çŠ¶æ€ç®¡ç†
- **billing**: ç§Ÿæˆ·è®¡è´¹ã€å¥—é¤ç®¡ç†ã€æ”¯ä»˜å¤„ç†
- **settings**: ç§Ÿæˆ·é…ç½®ã€ä¸ªæ€§åŒ–è®¾ç½®
- **applications**: ç§Ÿæˆ·ç”³è¯·ç®¡ç† â­ æ–°å¢
- **tenant-change**: ç§Ÿæˆ·å˜æ›´ç®¡ç† â­ æ–°å¢

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **èšåˆæ ¹**: Tenantã€TenantApplicationã€TenantDomainChangeApplication
- **å®ä½“**: TenantConfigã€TenantDomain
- **å€¼å¯¹è±¡**: TenantIdã€TenantCodeã€TenantNameã€TenantStatus
- **é¢†åŸŸæœåŠ¡**: TenantDomainServiceã€TenantApplicationDomainService
- **é¢†åŸŸäº‹ä»¶**: TenantCreatedEventã€TenantRenamedEventã€TenantStatusChangedEventã€TenantApplicationSubmittedEventã€TenantApplicationReviewedEventã€TenantDomainChangedEvent
- **äº‹ä»¶æº¯æº**: EventSourcedTenantã€TenantEventStoreã€TenantSnapshotManager

**ä¸šåŠ¡è§„åˆ™**ï¼š
- ç§Ÿæˆ·ä»£ç å’Œåç§°å¿…é¡»å…¨å±€å”¯ä¸€
- æ¯ä¸ªç§Ÿæˆ·æœ‰ä¸”åªèƒ½æœ‰ä¸€ä¸ªç®¡ç†å‘˜
- é»˜è®¤ç³»ç»Ÿç§Ÿæˆ·ä¸èƒ½è¢«åˆ é™¤æˆ–åœç”¨
- ç§Ÿæˆ·åˆ›å»ºå¿…é¡»é€šè¿‡ç”³è¯·å®¡æ ¸æµç¨‹
- æ‰€æœ‰ç§Ÿæˆ·æ“ä½œéƒ½é€šè¿‡äº‹ä»¶è®°å½•
- æ”¯æŒç§Ÿæˆ·çŠ¶æ€å†å²è¿½è¸ª

#### 3.2.2 ç”¨æˆ·é¢†åŸŸ (Users Domain)

**é¢†åŸŸèŒè´£**ï¼š
- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ç®¡ç†
- ç”¨æˆ·æ¡£æ¡ˆç®¡ç†
- ç”¨æˆ·åå¥½è®¾ç½®
- ç”¨æˆ·äº‹ä»¶æº¯æº

**å­é¢†åŸŸåˆ’åˆ†**ï¼š
- **management**: ç”¨æˆ·çš„ CRUD æ“ä½œã€çŠ¶æ€ç®¡ç†
- **profiles**: ç”¨æˆ·æ¡£æ¡ˆã€ä¸ªäººä¿¡æ¯
- **preferences**: ç”¨æˆ·åå¥½è®¾ç½®ã€ä¸ªæ€§åŒ–é…ç½®
- **registration**: ç”¨æˆ·æ³¨å†Œã€è´¦æˆ·åˆ›å»º â­ æ–°å¢
- **tenant-change**: ç”¨æˆ·ç§Ÿæˆ·å˜æ›´ç®¡ç† â­ æ–°å¢

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **èšåˆæ ¹**: User
- **å®ä½“**: UserProfileã€UserSettingsã€UserPreferences
- **å€¼å¯¹è±¡**: UserIdã€Emailã€Usernameã€Nicknameã€UserStatus
- **é¢†åŸŸæœåŠ¡**: UserDomainServiceã€UserProfileDomainService
- **é¢†åŸŸäº‹ä»¶**: UserCreatedEventã€UserProfileUpdatedEventã€UserPreferencesChangedEventã€UserStatusChangedEvent
- **äº‹ä»¶æº¯æº**: EventSourcedUserã€UserEventStoreã€UserSnapshotManager

**ä¸šåŠ¡è§„åˆ™**ï¼š
- é‚®ç®±åœ°å€å¿…é¡»å…¨å±€å”¯ä¸€
- æ˜µç§°å¿…é¡»å…¨å±€å”¯ä¸€
- ç”¨æˆ·åªèƒ½å½’å±ä¸€ä¸ªç§Ÿæˆ·
- ç”¨æˆ·å¿…é¡»è‡³å°‘å½’å±ä¸€ä¸ªç»„ç»‡
- ç”¨æˆ·å¯ä»¥åŒæ—¶å½’å±å¤šä¸ªç»„ç»‡
- ä¸»è¦ç»„ç»‡å¿…é¡»ä»å½’å±ç»„ç»‡ä¸­é€‰æ‹©
- æ‰€æœ‰ç”¨æˆ·æ“ä½œéƒ½é€šè¿‡äº‹ä»¶è®°å½•
- æ”¯æŒç”¨æˆ·çŠ¶æ€å†å²è¿½è¸ª

#### 3.2.3 è®¤è¯é¢†åŸŸ (Authentication Domain)

**é¢†åŸŸèŒè´£**ï¼š
- ç”¨æˆ·èº«ä»½éªŒè¯
- ç™»å½•æµç¨‹ç®¡ç†
- ä¼šè¯ç®¡ç†
- å¤šå› å­è®¤è¯
- å¯†ç ç®¡ç†
- è®¤è¯äº‹ä»¶æº¯æº

**å­é¢†åŸŸåˆ’åˆ†**ï¼š
- **login**: ç™»å½•æµç¨‹ã€è®¤è¯ç­–ç•¥
- **password**: å¯†ç ç®¡ç†ã€é‡ç½®ã€éªŒè¯
- **mfa**: å¤šå› å­è®¤è¯ã€OTPã€ç”Ÿç‰©è¯†åˆ«
- **sessions**: ä¼šè¯ç®¡ç†ã€ä»¤ç‰Œç®¡ç†

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **èšåˆæ ¹**: LoginSessionã€MfaDeviceã€PasswordReset
- **å®ä½“**: LoginAttemptã€SecurityPolicyã€MfaToken
- **å€¼å¯¹è±¡**: SessionIdã€TokenIdã€LoginStatusã€MfaType
- **é¢†åŸŸæœåŠ¡**: AuthenticationDomainServiceã€SessionDomainServiceã€MfaDomainService
- **é¢†åŸŸäº‹ä»¶**: UserLoggedInEventã€UserLoggedOutEventã€SessionCreatedEventã€SessionExpiredEventã€MfaEnabledEventã€PasswordChangedEvent
- **äº‹ä»¶æº¯æº**: EventSourcedSessionã€AuthenticationEventStoreã€AuthenticationSnapshotManager

**ä¸šåŠ¡è§„åˆ™**ï¼š
- æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼ˆç”¨æˆ·å/å¯†ç ã€é‚®ç®±/å¯†ç ã€æ‰‹æœºå·/éªŒè¯ç ï¼‰
- ä¼šè¯è¶…æ—¶è‡ªåŠ¨å¤±æ•ˆ
- æ”¯æŒå¤šå› å­è®¤è¯
- å¯†ç å¿…é¡»ç¬¦åˆå®‰å…¨è¦æ±‚
- å¼‚å¸¸ç™»å½•è¡Œä¸ºç›‘æ§
- æ‰€æœ‰è®¤è¯æ“ä½œéƒ½é€šè¿‡äº‹ä»¶è®°å½•
- æ”¯æŒå®‰å…¨äº‹ä»¶å†å²è¿½è¸ª

#### 3.2.4 æˆæƒé¢†åŸŸ (Authorization Domain)

**é¢†åŸŸèŒè´£**ï¼š
- æƒé™æ§åˆ¶ç®¡ç†
- è§’è‰²ç®¡ç†
- è®¿é—®ç­–ç•¥ç®¡ç†
- CASLæƒé™è§„åˆ™ç®¡ç†
- åŸºäºç»„ç»‡çš„è®¿é—®æ§åˆ¶ï¼ˆOBACï¼‰
- æˆæƒäº‹ä»¶æº¯æº

**å­é¢†åŸŸåˆ’åˆ†**ï¼š
- **permissions**: æƒé™å®šä¹‰ã€æƒé™ç®¡ç†
- **roles**: è§’è‰²ç®¡ç†ã€è§’è‰²åˆ†é…
- **policies**: è®¿é—®ç­–ç•¥ã€ç­–ç•¥å¼•æ“
- **casl**: CASL æƒé™åº“é›†æˆ
- **obac**: åŸºäºç»„ç»‡çš„è®¿é—®æ§åˆ¶

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **èšåˆæ ¹**: Roleã€Permissionã€OrganizationPermissionã€CaslRule
- **å®ä½“**: UserRoleã€RolePermissionã€PermissionPolicyã€CaslAbility
- **å€¼å¯¹è±¡**: RoleIdã€RoleNameã€RoleCodeã€PermissionIdã€PermissionNameã€CaslActionã€CaslSubject
- **é¢†åŸŸæœåŠ¡**: RoleDomainServiceã€PermissionDomainServiceã€AuthorizationDomainServiceã€CaslPermissionDomainService
- **é¢†åŸŸäº‹ä»¶**: RoleCreatedEventã€PermissionAssignedEventã€UserRoleChangedEventã€CaslRuleUpdatedEventã€OrganizationPermissionChangedEvent
- **äº‹ä»¶æº¯æº**: EventSourcedRoleã€EventSourcedPermissionã€PermissionEventStoreã€PermissionSnapshotManager

**ä¸šåŠ¡è§„åˆ™**ï¼š
- ç³»ç»Ÿç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
- ç§Ÿæˆ·ç®¡ç†å‘˜æ‹¥æœ‰æœ¬ç§Ÿæˆ·æ‰€æœ‰æƒé™
- ç»„ç»‡ç®¡ç†å‘˜æ‹¥æœ‰æœ¬ç»„ç»‡åŠå­ç»„ç»‡æƒé™
- æƒé™åŸºäºè§’è‰²å’Œç»„ç»‡åˆ†é…
- ç”¨æˆ·æƒé™ = è§’è‰²æƒé™ + æ‰€æœ‰ç»„ç»‡æƒé™çš„å¹¶é›†
- æƒé™å˜æ›´ç«‹å³ç”Ÿæ•ˆ
- ç»„ç»‡æƒé™å¯ä»¥ç»§æ‰¿çˆ¶ç»„ç»‡æƒé™
- ä½¿ç”¨CASLå£°æ˜å¼æƒé™è§„åˆ™
- æ”¯æŒå¤æ‚çš„æƒé™é€»è¾‘ç»„åˆ
- æ‰€æœ‰æƒé™æ“ä½œéƒ½é€šè¿‡äº‹ä»¶è®°å½•
- æ”¯æŒæƒé™å˜æ›´å†å²è¿½è¸ª

#### 3.2.5 ç§Ÿæˆ·å˜æ›´é¢†åŸŸ (Tenant Change Domain)

**é¢†åŸŸèŒè´£**ï¼š
- ç”¨æˆ·ç§Ÿæˆ·å˜æ›´ç”³è¯·ç®¡ç†
- ç§Ÿæˆ·å˜æ›´å®¡æ ¸æµç¨‹
- ç§Ÿæˆ·å˜æ›´å†å²è®°å½•
- ç§Ÿæˆ·ç®¡ç†å‘˜æ›´æ¢
- ç§Ÿæˆ·å˜æ›´äº‹ä»¶æº¯æº

**å­é¢†åŸŸåˆ’åˆ†**ï¼š
- **applications**: ç§Ÿæˆ·å˜æ›´ç”³è¯·ç®¡ç†
- **approval**: ç§Ÿæˆ·å˜æ›´å®¡æ ¸æµç¨‹
- **history**: ç§Ÿæˆ·å˜æ›´å†å²è®°å½•

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **èšåˆæ ¹**: UserTenantChangeApplicationã€UserTenantChangeRecord
- **å®ä½“**: TenantChangeRequestã€TenantChangeApproval
- **å€¼å¯¹è±¡**: ApplicationIdã€ApplicationStatusã€TenantChangeType
- **é¢†åŸŸæœåŠ¡**: UserTenantChangeDomainServiceã€TenantChangeApprovalDomainService
- **é¢†åŸŸäº‹ä»¶**: UserTenantChangeRequestedEventã€UserTenantChangedEventã€TenantChangeApplicationSubmittedEventã€TenantChangeApplicationReviewedEventã€TenantAdminChangedEvent
- **äº‹ä»¶æº¯æº**: EventSourcedUserTenantChangeã€TenantChangeEventStoreã€TenantChangeSnapshotManager

**ä¸šåŠ¡è§„åˆ™**ï¼š
- ç§Ÿæˆ·ç®¡ç†å‘˜ä¸èƒ½ç”³è¯·ç§Ÿæˆ·å˜æ›´
- ç”¨æˆ·ä¸èƒ½åŒæ—¶å½’å±å¤šä¸ªç§Ÿæˆ·
- æœ‰æœªå¤„ç†ç”³è¯·æ—¶ä¸èƒ½æäº¤æ–°ç”³è¯·
- ç§Ÿæˆ·å˜æ›´å¿…é¡»é€šè¿‡å®¡æ ¸æµç¨‹
- æ‰€æœ‰ç§Ÿæˆ·å˜æ›´æ“ä½œéƒ½é€šè¿‡äº‹ä»¶è®°å½•
- æ”¯æŒå®Œæ•´çš„å˜æ›´å†å²è¿½è¸ª



#### 3.2.6 ç”³è¯·å®¡æ ¸é¢†åŸŸ (Application Review Domain)

**é¢†åŸŸèŒè´£**ï¼š
- ç»Ÿä¸€ç”³è¯·ç®¡ç†
- å®¡æ ¸æµç¨‹åè°ƒ
- å®¡æ ¸è§„åˆ™ç®¡ç†
- å®¡æ ¸å†å²è®°å½•
- ç”³è¯·å®¡æ ¸äº‹ä»¶æº¯æº

**å­é¢†åŸŸåˆ’åˆ†**ï¼š
- **management**: ç”³è¯·ç®¡ç†ã€æµç¨‹åè°ƒ
- **rules**: å®¡æ ¸è§„åˆ™ç®¡ç†
- **history**: å®¡æ ¸å†å²è®°å½•

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **èšåˆæ ¹**: Applicationã€ReviewProcess
- **å®ä½“**: ReviewTaskã€ReviewRuleã€ReviewHistory
- **å€¼å¯¹è±¡**: ApplicationTypeã€ReviewStatusã€ReviewResult
- **é¢†åŸŸæœåŠ¡**: ApplicationReviewDomainServiceã€ReviewProcessDomainService
- **é¢†åŸŸäº‹ä»¶**: ApplicationSubmittedEventã€ApplicationReviewedEventã€ReviewProcessCompletedEventã€ReviewTaskAssignedEventã€ReviewTaskCompletedEventã€ReviewRuleUpdatedEvent
- **äº‹ä»¶æº¯æº**: EventSourcedApplicationã€EventSourcedReviewProcessã€ApplicationEventStoreã€ApplicationSnapshotManager

**ä¸šåŠ¡è§„åˆ™**ï¼š
- ç”³è¯·å¿…é¡»é€šè¿‡å®¡æ ¸æµç¨‹
- å®¡æ ¸æ“ä½œå¿…é¡»è®°å½•
- å®¡æ ¸æ‹’ç»å¿…é¡»æä¾›åŸå› 
- å®¡æ ¸ç»“æœå¿…é¡»é€šçŸ¥ç”³è¯·äºº
- æ‰€æœ‰ç”³è¯·å®¡æ ¸æ“ä½œéƒ½é€šè¿‡äº‹ä»¶è®°å½•
- æ”¯æŒå®Œæ•´çš„å®¡æ ¸æµç¨‹è¿½è¸ª

#### 3.2.7 å®¡è®¡é¢†åŸŸ (Audit Domain)

**é¢†åŸŸèŒè´£**ï¼š
- æ“ä½œæ—¥å¿—è®°å½•
- å®‰å…¨äº‹ä»¶ç›‘æ§
- å®¡è®¡æŠ¥å‘Šç”Ÿæˆ
- åˆè§„æ€§æ£€æŸ¥
- äº‹ä»¶æº¯æºç®¡ç†

**å­é¢†åŸŸåˆ’åˆ†**ï¼š
- **logging**: å®¡è®¡æ—¥å¿—è®°å½•
- **compliance**: åˆè§„æ€§æ£€æŸ¥
- **reporting**: å®¡è®¡æŠ¥å‘Šç”Ÿæˆ

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **èšåˆæ ¹**: OperationLogã€SecurityEventã€AuditReport
- **å®ä½“**: LogEntryã€EventRuleã€ComplianceCheck
- **å€¼å¯¹è±¡**: LogIdã€EventTypeã€SeverityLevel
- **é¢†åŸŸæœåŠ¡**: AuditDomainServiceã€MonitoringDomainServiceã€ComplianceDomainService
- **é¢†åŸŸäº‹ä»¶**: OperationLoggedEventã€SecurityEventDetectedEventã€ComplianceViolationEventã€AuditReportGeneratedEventã€EventReplayCompletedEvent
- **äº‹ä»¶æº¯æº**: EventSourcedOperationLogã€EventSourcedSecurityEventã€AuditEventStoreã€AuditSnapshotManager

**ä¸šåŠ¡è§„åˆ™**ï¼š
- æ‰€æœ‰æ“ä½œå¿…é¡»è®°å½•æ—¥å¿—
- æ—¥å¿—ä¸å¯ç¯¡æ”¹
- å®‰å…¨äº‹ä»¶å®æ—¶ç›‘æ§
- å®šæœŸç”Ÿæˆå®¡è®¡æŠ¥å‘Š
- æ‰€æœ‰å®¡è®¡ç›‘æ§æ“ä½œéƒ½é€šè¿‡äº‹ä»¶è®°å½•
- æ”¯æŒå®Œæ•´çš„äº‹ä»¶æº¯æºå’Œé‡æ”¾

#### 3.2.8 ç»„ç»‡é¢†åŸŸ (Organizations Domain)

**é¢†åŸŸèŒè´£**ï¼š
- ç»„ç»‡æ¶æ„ç®¡ç†
- ç»„ç»‡å±‚çº§å…³ç³»ç®¡ç†
- ç”¨æˆ·ç»„ç»‡å½’å±ç®¡ç†
- ç»„ç»‡æƒé™é…ç½®
- ç»„ç»‡æ•°æ®éš”ç¦»
- ç»„ç»‡äº‹ä»¶æº¯æº

**å­é¢†åŸŸåˆ’åˆ†**ï¼š
- **management**: ç»„ç»‡ç®¡ç†ã€CRUDæ“ä½œ
- **hierarchy**: ç»„ç»‡å±‚çº§å…³ç³»ç®¡ç†
- **structure**: ç»„ç»‡ç»“æ„ç®¡ç†
- **user-assignment**: ç”¨æˆ·ç»„ç»‡åˆ†é…ç®¡ç† â­ æ–°å¢
- **permissions**: ç»„ç»‡æƒé™ç®¡ç† â­ æ–°å¢

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **èšåˆæ ¹**: Organizationã€UserOrganization
- **å®ä½“**: OrganizationConfigã€OrganizationPermission
- **å€¼å¯¹è±¡**: OrganizationIdã€OrganizationCodeã€OrganizationNameã€OrganizationStatus
- **é¢†åŸŸæœåŠ¡**: OrganizationDomainServiceã€UserOrganizationDomainServiceã€OrganizationPermissionDomainService
- **é¢†åŸŸäº‹ä»¶**: OrganizationCreatedEventã€OrganizationRenamedEventã€UserOrganizationChangedEventã€OrganizationPermissionChangedEventã€OrganizationHierarchyChangedEventã€UserOrganizationRoleChangedEvent
- **äº‹ä»¶æº¯æº**: EventSourcedOrganizationã€EventSourcedUserOrganizationã€OrganizationEventStoreã€OrganizationSnapshotManager
- **ç¼“å­˜æœåŠ¡**: OrganizationCacheServiceã€OrganizationHierarchyCacheServiceã€UserOrganizationCacheService

**ä¸šåŠ¡è§„åˆ™**ï¼š
- ç»„ç»‡åç§°åœ¨ç§Ÿæˆ·å†…å¿…é¡»å”¯ä¸€
- ç»„ç»‡ä»£ç åœ¨ç§Ÿæˆ·å†…å¿…é¡»å”¯ä¸€
- ç»„ç»‡å¯ä»¥è®¾ç½®çˆ¶ç»„ç»‡ï¼Œå½¢æˆæ ‘å½¢ç»“æ„
- ç”¨æˆ·å¿…é¡»è‡³å°‘å½’å±ä¸€ä¸ªç»„ç»‡
- ç”¨æˆ·å¯ä»¥åŒæ—¶å½’å±å¤šä¸ªç»„ç»‡
- ç»„ç»‡æƒé™å¯ä»¥ç»§æ‰¿çˆ¶ç»„ç»‡æƒé™
- ç»„ç»‡é—´æ•°æ®é»˜è®¤éš”ç¦»
- æ‰€æœ‰ç»„ç»‡æ“ä½œéƒ½é€šè¿‡äº‹ä»¶è®°å½•
- æ”¯æŒç»„ç»‡æ¶æ„å˜æ›´å†å²è¿½è¸ª

### 3.3 å…±äº«å†…æ ¸é¢†åŸŸ

#### 3.3.1 ç³»ç»Ÿé…ç½®é¢†åŸŸ (System Configuration Domain)

**é¢†åŸŸèŒè´£**ï¼š
- ç³»ç»Ÿå‚æ•°é…ç½®
- ç§Ÿæˆ·é»˜è®¤é…ç½®
- åŠŸèƒ½å¼€å…³ç®¡ç†
- ç¯å¢ƒé…ç½®ç®¡ç†

#### 3.3.2 é€šçŸ¥é€šä¿¡é¢†åŸŸ (Notification & Communication Domain)

**é¢†åŸŸèŒè´£**ï¼š
- é‚®ä»¶é€šçŸ¥
- ç³»ç»Ÿæ¶ˆæ¯
- é€šçŸ¥æ¨¡æ¿ç®¡ç†
- é€šçŸ¥å†å²è®°å½•

**å­é¢†åŸŸåˆ’åˆ†**ï¼š
- **email**: é‚®ä»¶é€šçŸ¥
- **sms**: çŸ­ä¿¡é€šçŸ¥
- **push**: æ¨é€é€šçŸ¥

### 3.4 é¢†åŸŸé—´å…³ç³»

#### 3.4.1 ä¾èµ–å…³ç³»
```
ç§Ÿæˆ·é¢†åŸŸ â† ç”¨æˆ·é¢†åŸŸ
ç§Ÿæˆ·é¢†åŸŸ â† ç§Ÿæˆ·å˜æ›´é¢†åŸŸ
ç§Ÿæˆ·é¢†åŸŸ â† ç»„ç»‡é¢†åŸŸ
ç”¨æˆ·é¢†åŸŸ â† ç§Ÿæˆ·å˜æ›´é¢†åŸŸ
ç”¨æˆ·é¢†åŸŸ â† ç»„ç»‡é¢†åŸŸ
è®¤è¯é¢†åŸŸ â† ç”¨æˆ·é¢†åŸŸ
æˆæƒé¢†åŸŸ â† ç”¨æˆ·é¢†åŸŸ
æˆæƒé¢†åŸŸ â† ç»„ç»‡é¢†åŸŸ
ç”³è¯·å®¡æ ¸é¢†åŸŸ â† ç§Ÿæˆ·é¢†åŸŸ
ç”³è¯·å®¡æ ¸é¢†åŸŸ â† ç§Ÿæˆ·å˜æ›´é¢†åŸŸ
å®¡è®¡é¢†åŸŸ â† æ‰€æœ‰å…¶ä»–é¢†åŸŸ
é€šçŸ¥é¢†åŸŸ â† æ‰€æœ‰å…¶ä»–é¢†åŸŸ
```

#### 3.4.2 é›†æˆæ–¹å¼
- **äº‹ä»¶é©±åŠ¨**: é€šè¿‡é¢†åŸŸäº‹ä»¶è¿›è¡Œæ¾è€¦åˆé€šä¿¡
- **æ¥å£å¥‘çº¦**: å®šä¹‰æ¸…æ™°çš„é¢†åŸŸæ¥å£
- **å…±äº«å€¼å¯¹è±¡**: ä½¿ç”¨å…±äº«çš„å€¼å¯¹è±¡è¿›è¡Œæ•°æ®äº¤æ¢
- **é˜²è…å±‚**: éš”ç¦»å¤–éƒ¨ç³»ç»Ÿä¾èµ–

### 3.5 é¢†åŸŸè¾¹ç•Œé‡æ–°åˆ’åˆ†æ€»ç»“

#### 3.5.1 é‡æ–°åˆ’åˆ†çš„ä¼˜åŠ¿

**å•ä¸€èŒè´£åŸåˆ™**ï¼š
- **Usersé¢†åŸŸ**: ä¸“æ³¨äºç”¨æˆ·ä¿¡æ¯ç®¡ç†ï¼ŒèŒè´£æ›´åŠ çº¯ç²¹
- **Authenticationé¢†åŸŸ**: ä¸“æ³¨äºèº«ä»½éªŒè¯ï¼Œæ”¯æŒå¤šç§è®¤è¯æ–¹å¼
- **Authorizationé¢†åŸŸ**: ä¸“æ³¨äºæƒé™æ§åˆ¶ï¼Œé›†æˆCASLå’ŒOBAC

**é«˜å†…èšä½è€¦åˆ**ï¼š
- æ¯ä¸ªé¢†åŸŸèŒè´£æ˜ç¡®ï¼Œå†…éƒ¨é«˜å†…èš
- é¢†åŸŸé—´é€šè¿‡æ¥å£å’Œäº‹ä»¶åä½œï¼Œä½è€¦åˆ
- ä¾¿äºç‹¬ç«‹å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²

**å¯æ‰©å±•æ€§**ï¼š
- è®¤è¯é¢†åŸŸå¯ä»¥æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼ˆOAuthã€SAMLã€LDAPç­‰ï¼‰
- æˆæƒé¢†åŸŸå¯ä»¥é›†æˆä¸åŒçš„æƒé™æ¡†æ¶ï¼ˆRBACã€ABACã€PBACç­‰ï¼‰
- ç”¨æˆ·é¢†åŸŸå¯ä»¥ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘å’Œæ•°æ®æ¨¡å‹è®¾è®¡

**æŠ€æœ¯é€‰å‹çµæ´»æ€§**ï¼š
- è®¤è¯é¢†åŸŸå¯ä»¥é€‰æ‹©ä¸åŒçš„è®¤è¯åº“å’Œç­–ç•¥
- æˆæƒé¢†åŸŸå¯ä»¥é›†æˆCASLã€RBACã€ABACç­‰ä¸åŒæƒé™æ¨¡å‹
- ç”¨æˆ·é¢†åŸŸå¯ä»¥ä¸“æ³¨äºDDDå»ºæ¨¡å’Œä¸šåŠ¡è§„åˆ™

#### 3.5.2 å­é¢†åŸŸåˆ’åˆ†ç­–ç•¥

**é¢†åŸŸå‘½åè§„èŒƒ**ï¼š
- **é¢†åŸŸåç§°**: ä½¿ç”¨å¤æ•°å½¢å¼ï¼Œå¦‚ `tenants`ã€`users`ã€`organizations`
- **å­é¢†åŸŸåç§°**: ä½¿ç”¨åè¯ï¼Œå¦‚ `management`ã€`billing`ã€`authentication`
- **æ–‡ä»¶å‘½å**: ä½¿ç”¨ kebab-caseï¼Œå¦‚ `tenant-management.service.ts`

**å­é¢†åŸŸèŒè´£è¾¹ç•Œ**ï¼š
- **management**: æ ¸å¿ƒçš„CRUDæ“ä½œå’ŒçŠ¶æ€ç®¡ç†
- **profiles**: ç”¨æˆ·æ¡£æ¡ˆå’Œä¸ªæ€§åŒ–ä¿¡æ¯
- **preferences**: ç”¨æˆ·åå¥½å’Œé…ç½®è®¾ç½®
- **billing**: è®¡è´¹å’Œæ”¯ä»˜ç›¸å…³åŠŸèƒ½
- **settings**: é…ç½®å’Œä¸ªæ€§åŒ–è®¾ç½®
- **applications**: ç”³è¯·æµç¨‹ç®¡ç†
- **tenant-change**: ç§Ÿæˆ·å˜æ›´ç®¡ç†
- **registration**: ç”¨æˆ·æ³¨å†Œå’Œè´¦æˆ·åˆ›å»º
- **user-assignment**: ç”¨æˆ·ç»„ç»‡åˆ†é…
- **permissions**: æƒé™ç®¡ç†
- **hierarchy**: å±‚çº§å…³ç³»ç®¡ç†
- **structure**: ç»“æ„ç®¡ç†
- **logging**: æ—¥å¿—è®°å½•
- **compliance**: åˆè§„æ£€æŸ¥
- **reporting**: æŠ¥å‘Šç”Ÿæˆ
- **rules**: è§„åˆ™ç®¡ç†
- **history**: å†å²è®°å½•
- **approval**: å®¡æ ¸æµç¨‹
- **email**: é‚®ä»¶é€šçŸ¥
- **sms**: çŸ­ä¿¡é€šçŸ¥
- **push**: æ¨é€é€šçŸ¥

#### 3.5.3 å®æ–½å»ºè®®

**åˆ†é˜¶æ®µå®æ–½**ï¼š
1. **ç¬¬ä¸€é˜¶æ®µ**: åˆ›å»ºæ–°çš„é¢†åŸŸç»“æ„ï¼Œä¿æŒå‘åå…¼å®¹
2. **ç¬¬äºŒé˜¶æ®µ**: é€æ­¥è¿ç§»ç°æœ‰åŠŸèƒ½åˆ°æ–°é¢†åŸŸ
3. **ç¬¬ä¸‰é˜¶æ®µ**: å®Œå–„é¢†åŸŸé—´æ¥å£å’Œäº‹ä»¶é€šä¿¡
4. **ç¬¬å››é˜¶æ®µ**: ä¼˜åŒ–å’Œé‡æ„ï¼Œç§»é™¤æ—§ä»£ç 

**æ¥å£è®¾è®¡**ï¼š
- å®šä¹‰æ¸…æ™°çš„é¢†åŸŸé—´æ¥å£
- ä½¿ç”¨é¢†åŸŸäº‹ä»¶è¿›è¡Œæ¾è€¦åˆé€šä¿¡
- å®ç°é˜²è…å±‚éš”ç¦»å¤–éƒ¨ä¾èµ–

**æµ‹è¯•ç­–ç•¥**ï¼š
- ä¸ºæ¯ä¸ªé¢†åŸŸç¼–å†™ç‹¬ç«‹çš„å•å…ƒæµ‹è¯•
- ç¼–å†™é¢†åŸŸé—´çš„é›†æˆæµ‹è¯•
- å®ç°ç«¯åˆ°ç«¯çš„ä¸šåŠ¡æµç¨‹æµ‹è¯•



---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 4.1 æ•´ä½“æ¶æ„

#### 4.1.1 åˆ†å±‚æ¶æ„ (Layered Architecture)

åŸºäº**Clean Architectureï¼ˆæ•´æ´æ¶æ„ï¼‰**çš„åˆ†å±‚è®¾è®¡ï¼Œç¡®ä¿ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°çš„è§£è€¦ï¼š

1. **Domain Layer (é¢†åŸŸå±‚)**
   - çº¯ä¸šåŠ¡é€»è¾‘ï¼Œæ— å¤–éƒ¨ä¾èµ–
   - åŒ…å«å®ä½“ã€å€¼å¯¹è±¡ã€é¢†åŸŸæœåŠ¡ã€é¢†åŸŸäº‹ä»¶
   - å®šä¹‰ä¸šåŠ¡è§„åˆ™å’Œçº¦æŸ
   - å®ç°DDDæ ¸å¿ƒæ¦‚å¿µï¼šèšåˆæ ¹ã€é¢†åŸŸæœåŠ¡ã€é¢†åŸŸäº‹ä»¶

2. **Application Layer (åº”ç”¨å±‚)**
   - ä¸šåŠ¡ç”¨ä¾‹åè°ƒ
   - åŒ…å«åº”ç”¨æœåŠ¡ã€Use Casesï¼ˆç”¨ä¾‹ï¼‰ã€DTOã€æ¥å£ã€æ ¡éªŒå™¨
   - åè°ƒé¢†åŸŸå¯¹è±¡å®Œæˆä¸šåŠ¡ç”¨ä¾‹
   - å®ç°ç”¨ä¾‹ç¼–æ’å’Œä¸šåŠ¡æµç¨‹æ§åˆ¶
   - **Use Cases**: å®šä¹‰å…·ä½“çš„ä¸šåŠ¡ç”¨ä¾‹ï¼Œæ¯ä¸ªç”¨ä¾‹ä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡æµç¨‹

3. **Infrastructure Layer (åŸºç¡€è®¾æ–½å±‚)**
   - æŠ€æœ¯å®ç°ç»†èŠ‚
   - åŒ…å«ORMå®ä½“ã€ä»“å‚¨å®ç°ã€å¤–éƒ¨æœåŠ¡é›†æˆ
   - æä¾›æŠ€æœ¯å®ç°æ”¯æŒ
   - å®ç°æ•°æ®æŒä¹…åŒ–ã€å¤–éƒ¨æœåŠ¡è°ƒç”¨

4. **Presentation Layer (è¡¨ç°å±‚)**
   - ç”¨æˆ·ç•Œé¢å’ŒAPI
   - åŒ…å«æ§åˆ¶å™¨ã€è¡¨ç°å±‚DTOã€æ ¡éªŒå™¨
   - å¤„ç†HTTPè¯·æ±‚å’Œå“åº”
   - å®ç°ç”¨æˆ·äº¤äº’å’Œæ•°æ®å±•ç¤º

#### 4.1.2 æ¨¡å—åŒ–è®¾è®¡ (Modular Design)

åŸºäº**DDDå’ŒClean Architecture**çš„æ¨¡å—åŒ–è®¾è®¡åŸåˆ™ï¼š

- æ¯ä¸ªä¸šåŠ¡æ¨¡å—ç‹¬ç«‹ï¼ŒåŒ…å«å®Œæ•´çš„å››å±‚æ¶æ„
- æ¨¡å—é—´é€šè¿‡æ¥å£é€šä¿¡ï¼Œé™ä½è€¦åˆ
- å…±äº«å±‚æä¾›é€šç”¨åŠŸèƒ½
- æ¯ä¸ªæ¨¡å—éƒ½æœ‰æ˜ç¡®çš„è¾¹ç•Œå’ŒèŒè´£
- æ”¯æŒæ¨¡å—çš„ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²

#### 4.1.3 ä¾èµ–å€’ç½® (Dependency Inversion)

éµå¾ª**Clean Architecture**çš„ä¾èµ–å€’ç½®åŸåˆ™ï¼š

- é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—
- æŠ½è±¡ä¸ä¾èµ–å…·ä½“å®ç°
- é€šè¿‡ä¾èµ–æ³¨å…¥å®ç°è§£è€¦
- é¢†åŸŸå±‚å®šä¹‰æ¥å£ï¼ŒåŸºç¡€è®¾æ–½å±‚å®ç°æ¥å£
- ç¡®ä¿ä¸šåŠ¡é€»è¾‘çš„ç‹¬ç«‹æ€§å’Œå¯æµ‹è¯•æ€§

### 4.2 æŠ€æœ¯æ¶æ„

#### 4.2.1 æ¡†æ¶é€‰å‹
- **NestJS**: ä¼ä¸šçº§Node.jsæ¡†æ¶ï¼Œæ”¯æŒTypeScript
- **Fastify**: é«˜æ€§èƒ½HTTPå¹³å°ï¼Œæ›¿ä»£Express
- **TypeScript**: å¼ºç±»å‹JavaScriptè¶…é›†

#### 4.2.2 æ¶æ„æ¨¡å¼
- **CQRS**: å‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»
- **Event Sourcing**: äº‹ä»¶æº¯æºï¼ˆæ‰€æœ‰é¢†åŸŸæ¨¡å—å®ç°ï¼‰
- **Repository Pattern**: ä»“å‚¨æ¨¡å¼ï¼ˆé¢†åŸŸå±‚å®šä¹‰æ¥å£ï¼ŒåŸºç¡€è®¾æ–½å±‚å®ç°ï¼‰
- **Factory Pattern**: å·¥å‚æ¨¡å¼ï¼ˆèšåˆæ ¹åˆ›å»ºå’Œé‡å»ºï¼‰
- **Observer Pattern**: è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰
- **Aggregate Pattern**: èšåˆæ¨¡å¼ï¼ˆDDDæ ¸å¿ƒæ¨¡å¼ï¼‰
- **Domain Service Pattern**: é¢†åŸŸæœåŠ¡æ¨¡å¼ï¼ˆè·¨èšåˆä¸šåŠ¡é€»è¾‘ï¼‰
- **Value Object Pattern**: å€¼å¯¹è±¡æ¨¡å¼ï¼ˆä¸å¯å˜æ•°æ®å¯¹è±¡ï¼‰
- **Use Case Pattern**: ç”¨ä¾‹æ¨¡å¼ï¼ˆåº”ç”¨å±‚ä¸šåŠ¡ç”¨ä¾‹å°è£…ï¼‰

#### 4.2.2 æ•°æ®åº“ä¸ç¼“å­˜
- **PostgreSQL**: å…³ç³»å‹æ•°æ®åº“ï¼Œæ”¯æŒJSONå’Œå¤æ‚æŸ¥è¯¢
- **MikroORM**: TypeScriptä¼˜å…ˆçš„ORMï¼Œæ”¯æŒDDD
- **MongoDB**: æ–‡æ¡£å‹æ•°æ®åº“ï¼ˆæœªæ¥æ‰©å±•ï¼‰
- **Redis**: åˆ†å¸ƒå¼ç¼“å­˜å’Œä¼šè¯å­˜å‚¨
- **Node-Cache**: å†…å­˜ç¼“å­˜
- **Cache-Manager**: ç¼“å­˜ç®¡ç†å™¨

#### 4.2.3 æ•°æ®åº“é€‚é…æ¶æ„
- **æ•°æ®åº“æŠ½è±¡å±‚**: ç»Ÿä¸€çš„æ•°æ®åº“æ“ä½œæ¥å£
- **MikroORMé€‚é…å™¨**: åŸºäºMikroORMçš„å¤šæ•°æ®åº“é€‚é…
- **è¿æ¥æ± ç®¡ç†**: æ•°æ®åº“è¿æ¥æ± é…ç½®å’Œç®¡ç†
- **äº‹åŠ¡ç®¡ç†**: è·¨æ•°æ®åº“çš„äº‹åŠ¡æ”¯æŒ
- **è¿ç§»ç®¡ç†**: æ•°æ®åº“ç»“æ„è¿ç§»å’Œç‰ˆæœ¬æ§åˆ¶
- **æ•°æ®åº“é©±åŠ¨**: PostgreSQLé©±åŠ¨ + MongoDBé©±åŠ¨

#### 4.2.4 è®¤è¯ä¸å®‰å…¨
- **JWT**: JSON Web Tokenè®¤è¯
- **bcrypt**: å¯†ç åŠ å¯†
- **Helmet**: å®‰å…¨ä¸­é—´ä»¶
- **CASL**: å£°æ˜å¼æƒé™ç®¡ç†åº“

#### 4.2.5 ç›‘æ§ä¸è¿½è¸ª
- **OpenTelemetry**: åˆ†å¸ƒå¼è¿½è¸ªå’ŒæŒ‡æ ‡æ”¶é›†
- **Jaeger**: åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ
- **Prometheus**: æŒ‡æ ‡ç›‘æ§å’Œå‘Šè­¦
- **Grafana**: ç›‘æ§æ•°æ®å¯è§†åŒ–
- **AsyncLocalStorage**: Node.jså¼‚æ­¥ä¸Šä¸‹æ–‡ä¼ æ’­
- **UUID**: å”¯ä¸€æ ‡è¯†ç¬¦ç”Ÿæˆ

#### 4.2.6 æ—¥å¿—ç®¡ç†
- **Pino**: é«˜æ€§èƒ½Node.jsæ—¥å¿—åº“
- **ç»“æ„åŒ–æ—¥å¿—**: JSONæ ¼å¼æ—¥å¿—è¾“å‡º
- **æ—¥å¿—çº§åˆ«**: error, warn, info, debug, trace
- **æ—¥å¿—è½®è½¬**: è‡ªåŠ¨æ—¥å¿—æ–‡ä»¶è½®è½¬
- **æ—¥å¿—å‹ç¼©**: å†å²æ—¥å¿—å‹ç¼©å­˜å‚¨
- **æ—¥å¿—æŸ¥è¯¢**: é«˜æ€§èƒ½æ—¥å¿—æŸ¥è¯¢å’Œè¿‡æ»¤

#### 4.2.7 é…ç½®ç®¡ç†
- **ConfigService**: NestJSé…ç½®æœåŠ¡
- **ç¯å¢ƒå˜é‡**: æ”¯æŒ.envæ–‡ä»¶å’Œç¯å¢ƒå˜é‡
- **é…ç½®éªŒè¯**: Joié…ç½®éªŒè¯
- **çƒ­é‡è½½**: æ”¯æŒé…ç½®çƒ­é‡è½½
- **é…ç½®åŠ å¯†**: æ•æ„Ÿé…ç½®åŠ å¯†å­˜å‚¨
- **é…ç½®ç¼“å­˜**: é…ç½®ä¿¡æ¯ç¼“å­˜æœºåˆ¶

### 4.3 é¡¹ç›®ç»“æ„

```
apps/api/src/
â”œâ”€â”€ main.ts                          # åº”ç”¨å…¥å£
â”œâ”€â”€ app.module.ts                    # æ ¹æ¨¡å—
â”œâ”€â”€ app.controller.ts                # æ ¹æ§åˆ¶å™¨
â”œâ”€â”€ app.service.ts                   # æ ¹æœåŠ¡
â”‚
â”œâ”€â”€ shared/                          # å…±äº«å±‚
â”‚   â”œâ”€â”€ domain/                      # å…±äº«é¢†åŸŸ
â”‚   â”‚   â”œâ”€â”€ entities/                # å…±äº«å®ä½“
â”‚   â”‚   â”‚   â””â”€â”€ base.entity.ts      # åŸºç¡€å®ä½“
â”‚   â”‚   â”œâ”€â”€ value-objects/           # å€¼å¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ events/                  # é¢†åŸŸäº‹ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ base.event.ts       # åŸºç¡€äº‹ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ domain-event.ts     # é¢†åŸŸäº‹ä»¶åŸºç±»
â”‚   â”‚   â”œâ”€â”€ event-sourcing/          # äº‹ä»¶æº¯æº
â”‚   â”‚   â”‚   â”œâ”€â”€ event-sourced-aggregate.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ event-store.interface.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ event-handler.interface.ts
â”‚   â”‚   â”‚   â””â”€â”€ snapshot-manager.interface.ts
â”‚   â”‚   â””â”€â”€ exceptions/              # é¢†åŸŸå¼‚å¸¸
â”‚   â”‚
â”‚   â”œâ”€â”€ infrastructure/              # å…±äº«åŸºç¡€è®¾æ–½
â”‚   â”‚   â”œâ”€â”€ database/                # æ•°æ®åº“é…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ config/             # æ•°æ®åº“é…ç½®
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ postgresql.config.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ mongodb.config.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ database.config.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ adapters/           # MikroORMæ•°æ®åº“é€‚é…å™¨
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ base/           # åŸºç¡€é€‚é…å™¨
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ mikroorm-adapter.interface.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ connection-manager.interface.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ transaction-manager.interface.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ postgresql/     # PostgreSQL + MikroORMé€‚é…å™¨
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ postgresql-mikroorm-adapter.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ postgresql-connection-manager.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ postgresql-transaction-manager.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ mongodb/        # MongoDB + MikroORMé€‚é…å™¨
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ mongodb-mikroorm-adapter.ts
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ mongodb-connection-manager.ts
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ mongodb-transaction-manager.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ migrations/         # MikroORMè¿ç§»
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ postgresql/     # PostgreSQLè¿ç§»
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ mongodb/        # MongoDBè¿ç§»
â”‚   â”‚   â”‚   â”œâ”€â”€ seeders/            # æ•°æ®ç§å­
â”‚   â”‚   â”‚   â””â”€â”€ factories/          # æ•°æ®åº“å·¥å‚
â”‚   â”‚   â”‚       â”œâ”€â”€ mikroorm-factory.ts
â”‚   â”‚   â”‚       â””â”€â”€ connection-factory.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ config/                 # é…ç½®ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ config.module.ts    # é…ç½®æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ config.service.ts   # é…ç½®æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ config.validator.ts # é…ç½®éªŒè¯å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ config.encryption.ts # é…ç½®åŠ å¯†
â”‚   â”‚   â”‚   â”œâ”€â”€ config.cache.ts     # é…ç½®ç¼“å­˜
â”‚   â”‚   â”‚   â”œâ”€â”€ schemas/            # é…ç½®æ¨¡å¼
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ app.config.schema.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ database.config.schema.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ redis.config.schema.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ jwt.config.schema.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ event-sourcing.config.schema.ts
â”‚   â”‚   â”‚   â””â”€â”€ loaders/            # é…ç½®åŠ è½½å™¨
â”‚   â”‚   â”‚       â”œâ”€â”€ env.config.loader.ts
â”‚   â”‚   â”‚       â”œâ”€â”€ file.config.loader.ts
â”‚   â”‚   â”‚       â””â”€â”€ remote.config.loader.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ logging/                 # æ—¥å¿—é…ç½®
â”‚   â”‚   â”œâ”€â”€ pino-logger.service.ts
â”‚   â”‚   â”œâ”€â”€ pino-logger.module.ts
â”‚   â”‚   â”œâ”€â”€ pino-logger.interceptor.ts
â”‚   â”‚   â”œâ”€â”€ pino-logger.middleware.ts
â”‚   â”‚   â”œâ”€â”€ pino-logger.config.ts
â”‚   â”‚   â”œâ”€â”€ pino-logger.transport.ts
â”‚   â”‚   â””â”€â”€ pino-logger.formatter.ts
â”‚   â”œâ”€â”€ auth/                    # è®¤è¯é…ç½®
â”‚   â”œâ”€â”€ cache/                   # ç¼“å­˜é…ç½®
â”‚   â”‚   â”œâ”€â”€ redis-cache.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ redis-cache.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ memory-cache.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ cache-manager.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ cache-key.factory.ts
â”‚   â”‚   â”‚   â””â”€â”€ cache-invalidation.service.ts
â”‚   â”‚   â””â”€â”€ event-sourcing/          # äº‹ä»¶æº¯æºå®ç°
â”‚   â”‚       â”œâ”€â”€ postgres-event-store.ts
â”‚   â”‚       â”œâ”€â”€ redis-event-cache.ts
â”‚   â”‚       â”œâ”€â”€ event-publisher.ts
â”‚   â”‚       â”œâ”€â”€ event-handler-registry.ts
â”‚   â”‚       â””â”€â”€ snapshot-manager.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ application/                 # å…±äº«åº”ç”¨æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ interfaces/              # åº”ç”¨æ¥å£
â”‚   â”‚   â”œâ”€â”€ dto/                     # å…±äº«DTO
â”‚   â”‚   â””â”€â”€ validators/              # å…±äº«æ ¡éªŒå™¨
â”‚   â”‚
â”‚   â””â”€â”€ presentation/                # å…±äº«è¡¨ç°å±‚
â”‚       â”œâ”€â”€ decorators/              # è‡ªå®šä¹‰è£…é¥°å™¨
â”‚       â”œâ”€â”€ guards/                  # å®ˆå«
â”‚       â”œâ”€â”€ interceptors/            # æ‹¦æˆªå™¨
â”‚       â”œâ”€â”€ filters/                 # å¼‚å¸¸è¿‡æ»¤å™¨
â”‚       â”œâ”€â”€ middlewares/             # ä¸­é—´ä»¶
â”‚       â”‚   â”œâ”€â”€ request-tracing.middleware.ts
â”‚       â”‚   â”œâ”€â”€ tenant-context.middleware.ts
â”‚       â”‚   â””â”€â”€ correlation.middleware.ts
â”‚       â””â”€â”€ context/               # è¯·æ±‚ä¸Šä¸‹æ–‡ç®¡ç†
â”‚           â”œâ”€â”€ request-context.service.ts
â”‚           â”œâ”€â”€ tenant-context.service.ts
â”‚           â””â”€â”€ correlation.service.ts
â”‚
â”œâ”€â”€ modules/                         # ä¸šåŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ tenants/                     # ç§Ÿæˆ·é¢†åŸŸ
â”‚   â”‚   â”œâ”€â”€ management/              # ç§Ÿæˆ·ç®¡ç†å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ billing/                 # ç§Ÿæˆ·è®¡è´¹å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ settings/                # ç§Ÿæˆ·è®¾ç½®å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ applications/            # ç§Ÿæˆ·ç”³è¯·å­é¢†åŸŸ â­ æ–°å¢
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ tenant-change/           # ç§Ÿæˆ·å˜æ›´å­é¢†åŸŸ â­ æ–°å¢
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â””â”€â”€ tenants.module.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ users/                       # ç”¨æˆ·é¢†åŸŸ
â”‚   â”‚   â”œâ”€â”€ management/              # ç”¨æˆ·ç®¡ç†å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ profiles/                # ç”¨æˆ·æ¡£æ¡ˆå­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ preferences/             # ç”¨æˆ·åå¥½å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ registration/            # ç”¨æˆ·æ³¨å†Œå­é¢†åŸŸ â­ æ–°å¢
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ tenant-change/           # ç”¨æˆ·ç§Ÿæˆ·å˜æ›´å­é¢†åŸŸ â­ æ–°å¢
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â””â”€â”€ users.module.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ authentication/              # è®¤è¯é¢†åŸŸ
â”‚   â”‚   â”œâ”€â”€ login/                   # ç™»å½•å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ password/                # å¯†ç ç®¡ç†å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ mfa/                     # å¤šå› å­è®¤è¯å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ sessions/                # ä¼šè¯ç®¡ç†å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â””â”€â”€ authentication.module.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ authorization/               # æˆæƒé¢†åŸŸ
â”‚   â”‚   â”œâ”€â”€ permissions/             # æƒé™ç®¡ç†å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ roles/                   # è§’è‰²ç®¡ç†å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ policies/                # ç­–ç•¥ç®¡ç†å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ casl/                    # CASLé›†æˆå­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ obac/                    # åŸºäºç»„ç»‡çš„è®¿é—®æ§åˆ¶å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â””â”€â”€ authorization.module.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ organizations/               # ç»„ç»‡é¢†åŸŸ
â”‚   â”‚   â”œâ”€â”€ management/              # ç»„ç»‡ç®¡ç†å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ hierarchy/               # ç»„ç»‡å±‚çº§å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ structure/               # ç»„ç»‡ç»“æ„å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ user-assignment/         # ç”¨æˆ·åˆ†é…å­é¢†åŸŸ â­ æ–°å¢
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ permissions/             # ç»„ç»‡æƒé™å­é¢†åŸŸ â­ æ–°å¢
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â””â”€â”€ organizations.module.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ tenant-change/               # ç§Ÿæˆ·å˜æ›´é¢†åŸŸ
â”‚   â”‚   â”œâ”€â”€ applications/            # ç§Ÿæˆ·å˜æ›´ç”³è¯·å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ approval/                # ç§Ÿæˆ·å˜æ›´å®¡æ ¸å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ history/                 # ç§Ÿæˆ·å˜æ›´å†å²å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â””â”€â”€ tenant-change.module.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ application-review/          # ç”³è¯·å®¡æ ¸é¢†åŸŸ
â”‚   â”‚   â”œâ”€â”€ management/              # ç”³è¯·ç®¡ç†å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ rules/                   # å®¡æ ¸è§„åˆ™å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ history/                 # å®¡æ ¸å†å²å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â””â”€â”€ application-review.module.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ events/                      # äº‹ä»¶é¢†åŸŸ
â”‚   â”‚   â”œâ”€â”€ sourcing/                # äº‹ä»¶æº¯æºå­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ publishing/              # äº‹ä»¶å‘å¸ƒå­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ replay/                  # äº‹ä»¶é‡æ”¾å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â””â”€â”€ events.module.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ audit/                       # å®¡è®¡é¢†åŸŸ
â”‚   â”‚   â”œâ”€â”€ logging/                 # å®¡è®¡æ—¥å¿—å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ compliance/              # åˆè§„å®¡è®¡å­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ reporting/               # å®¡è®¡æŠ¥å‘Šå­é¢†åŸŸ
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚   â””â”€â”€ audit.module.ts
â”‚   â”‚
â”‚   â””â”€â”€ notifications/               # é€šçŸ¥é¢†åŸŸ
â”‚       â”œâ”€â”€ email/                   # é‚®ä»¶é€šçŸ¥å­é¢†åŸŸ
â”‚       â”‚   â”œâ”€â”€ domain/
â”‚       â”‚   â”œâ”€â”€ application/
â”‚       â”‚   â”œâ”€â”€ infrastructure/
â”‚       â”‚   â””â”€â”€ presentation/
â”‚       â”œâ”€â”€ sms/                     # çŸ­ä¿¡é€šçŸ¥å­é¢†åŸŸ
â”‚       â”‚   â”œâ”€â”€ domain/
â”‚       â”‚   â”œâ”€â”€ application/
â”‚       â”‚   â”œâ”€â”€ infrastructure/
â”‚       â”‚   â””â”€â”€ presentation/
â”‚       â”œâ”€â”€ push/                    # æ¨é€é€šçŸ¥å­é¢†åŸŸ
â”‚       â”‚   â”œâ”€â”€ domain/
â”‚       â”‚   â”œâ”€â”€ application/
â”‚       â”‚   â”œâ”€â”€ infrastructure/
â”‚       â”‚   â””â”€â”€ presentation/
â”‚       â””â”€â”€ notifications.module.ts
```

### 4.4 äº‹ä»¶æº¯æºæ¶æ„ (Event Sourcing Architecture)

#### 4.4.1 äº‹ä»¶æº¯æºæ¦‚è¿°
ç³»ç»Ÿé‡‡ç”¨äº‹ä»¶æº¯æºæ¨¡å¼ï¼Œæ‰€æœ‰é¢†åŸŸäº‹ä»¶éƒ½ä¼šè¢«æŒä¹…åŒ–å­˜å‚¨ï¼Œç”¨äºçŠ¶æ€é‡å»ºã€å®¡è®¡è¿½è¸ªå’Œä¸šåŠ¡åˆ†æã€‚

**æ ¸å¿ƒåŸåˆ™**ï¼š
- æ‰€æœ‰ä¸šåŠ¡æ“ä½œéƒ½é€šè¿‡äº‹ä»¶è¡¨ç¤º
- äº‹ä»¶æ˜¯ä¸å¯å˜çš„ï¼Œä¸€æ—¦åˆ›å»ºå°±ä¸èƒ½ä¿®æ”¹
- èšåˆçŠ¶æ€é€šè¿‡é‡æ”¾äº‹ä»¶é‡å»º
- æ”¯æŒäº‹ä»¶ç‰ˆæœ¬ç®¡ç†å’Œå…¼å®¹æ€§

#### 4.4.2 äº‹ä»¶å­˜å‚¨è®¾è®¡
**äº‹ä»¶å­˜å‚¨ç»“æ„**ï¼š
```sql
-- äº‹ä»¶è¡¨
CREATE TABLE events (
  id UUID PRIMARY KEY,
  aggregate_id VARCHAR(255) NOT NULL,
  aggregate_type VARCHAR(100) NOT NULL,
  event_type VARCHAR(100) NOT NULL,
  event_version INTEGER NOT NULL,
  event_data JSONB NOT NULL,
  metadata JSONB,
  created_at TIMESTAMP NOT NULL,
  correlation_id UUID,
  causation_id UUID
);

-- å¿«ç…§è¡¨
CREATE TABLE snapshots (
  id UUID PRIMARY KEY,
  aggregate_id VARCHAR(255) NOT NULL,
  aggregate_type VARCHAR(100) NOT NULL,
  aggregate_version INTEGER NOT NULL,
  aggregate_state JSONB NOT NULL,
  created_at TIMESTAMP NOT NULL
);

-- äº‹ä»¶è®¢é˜…è¡¨
CREATE TABLE event_subscriptions (
  id UUID PRIMARY KEY,
  subscriber_name VARCHAR(100) NOT NULL,
  last_processed_event_id UUID,
  last_processed_position BIGINT,
  created_at TIMESTAMP NOT NULL,
  updated_at TIMESTAMP NOT NULL
);
```

#### 4.4.3 äº‹ä»¶æº¯æºç»„ä»¶

**æ ¸å¿ƒç»„ä»¶**ï¼š
- **EventStore**: äº‹ä»¶å­˜å‚¨æ¥å£å’Œå®ç°
- **EventSourcedAggregate**: äº‹ä»¶æº¯æºèšåˆæ ¹åŸºç±»
- **EventPublisher**: äº‹ä»¶å‘å¸ƒå™¨
- **EventHandler**: äº‹ä»¶å¤„ç†å™¨
- **SnapshotManager**: å¿«ç…§ç®¡ç†å™¨
- **EventReplayTool**: äº‹ä»¶é‡æ”¾å·¥å…·

**äº‹ä»¶å¤„ç†æµç¨‹**ï¼š
1. èšåˆæ ¹æ‰§è¡Œä¸šåŠ¡æ“ä½œ
2. ç”Ÿæˆé¢†åŸŸäº‹ä»¶
3. äº‹ä»¶å­˜å‚¨åˆ°EventStore
4. å‘å¸ƒäº‹ä»¶åˆ°äº‹ä»¶æ€»çº¿
5. äº‹ä»¶å¤„ç†å™¨å¤„ç†äº‹ä»¶
6. å®šæœŸåˆ›å»ºå¿«ç…§ä¼˜åŒ–æ€§èƒ½

### 4.5 ç¼“å­˜æ¶æ„è®¾è®¡ (Caching Architecture)

#### 4.5.1 ç¼“å­˜å±‚æ¬¡ç»“æ„
ç³»ç»Ÿé‡‡ç”¨å¤šçº§ç¼“å­˜æ¶æ„ï¼Œä»åº”ç”¨å±‚åˆ°æ•°æ®å±‚æä¾›å…¨é¢çš„ç¼“å­˜æ”¯æŒã€‚

**ç¼“å­˜å±‚æ¬¡**ï¼š
1. **åº”ç”¨å±‚ç¼“å­˜**: å†…å­˜ç¼“å­˜ï¼Œæœ€å¿«å“åº”
2. **åˆ†å¸ƒå¼ç¼“å­˜**: Redisé›†ç¾¤ï¼Œè·¨å®ä¾‹å…±äº«
3. **æ•°æ®åº“ç¼“å­˜**: æŸ¥è¯¢ç»“æœç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›
4. **CDNç¼“å­˜**: é™æ€èµ„æºç¼“å­˜ï¼Œæå‡å‰ç«¯æ€§èƒ½

#### 4.5.2 ç¼“å­˜ç­–ç•¥è®¾è®¡

**ç¼“å­˜åˆ†ç±»**ï¼š
- **æƒé™ç¼“å­˜**: ç”¨æˆ·æƒé™ã€è§’è‰²æƒé™ã€ç»„ç»‡æƒé™
- **ç»„ç»‡ç¼“å­˜**: ç»„ç»‡æ¶æ„ã€å±‚çº§å…³ç³»ã€ç”¨æˆ·å½’å±
- **ä¼šè¯ç¼“å­˜**: ç”¨æˆ·ä¼šè¯ã€è®¤è¯ä¿¡æ¯ã€è®¿é—®ä»¤ç‰Œ
- **äº‹ä»¶ç¼“å­˜**: é¢†åŸŸäº‹ä»¶ã€èšåˆå¿«ç…§ã€äº‹ä»¶è®¢é˜…
- **é…ç½®ç¼“å­˜**: ç³»ç»Ÿé…ç½®ã€ç§Ÿæˆ·é…ç½®ã€åŠŸèƒ½å¼€å…³

**ç¼“å­˜ç­–ç•¥**ï¼š
- **TTLç­–ç•¥**: åŸºäºæ—¶é—´çš„è¿‡æœŸç­–ç•¥
- **LRUç­–ç•¥**: æœ€è¿‘æœ€å°‘ä½¿ç”¨æ·˜æ±°ç­–ç•¥
- **å†™ç©¿é€ç­–ç•¥**: å†™æ“ä½œåŒæ—¶æ›´æ–°ç¼“å­˜å’Œæ•°æ®åº“
- **å†™å›ç­–ç•¥**: å†™æ“ä½œå…ˆæ›´æ–°ç¼“å­˜ï¼Œå¼‚æ­¥æ›´æ–°æ•°æ®åº“
- **å¤±æ•ˆç­–ç•¥**: æ•°æ®å˜æ›´æ—¶ä¸»åŠ¨å¤±æ•ˆç›¸å…³ç¼“å­˜

#### 4.5.3 ç¼“å­˜å®ç°æ–¹æ¡ˆ

**æƒé™ç¼“å­˜å®ç°**ï¼š
```typescript
// ç”¨æˆ·æƒé™ç¼“å­˜é”®è®¾è®¡
const userPermissionKey = `user:permissions:${userId}:${tenantId}`
const userRoleKey = `user:roles:${userId}:${tenantId}`
const userOrganizationKey = `user:organizations:${userId}:${tenantId}`

// ç»„ç»‡æƒé™ç¼“å­˜é”®è®¾è®¡
const organizationPermissionKey = `org:permissions:${organizationId}`
const organizationHierarchyKey = `org:hierarchy:${tenantId}`

// CASLæƒé™èƒ½åŠ›ç¼“å­˜
const userAbilityKey = `user:ability:${userId}:${tenantId}`
```

**ç¼“å­˜æ›´æ–°ç­–ç•¥**ï¼š
- **æƒé™å˜æ›´**: è§’è‰²åˆ†é…ã€ç»„ç»‡æƒé™å˜æ›´æ—¶å¤±æ•ˆç”¨æˆ·æƒé™ç¼“å­˜
- **ç»„ç»‡å˜æ›´**: ç»„ç»‡æ¶æ„å˜æ›´æ—¶å¤±æ•ˆç›¸å…³ç»„ç»‡ç¼“å­˜
- **ç”¨æˆ·å˜æ›´**: ç”¨æˆ·ä¿¡æ¯å˜æ›´æ—¶å¤±æ•ˆç”¨æˆ·ç›¸å…³ç¼“å­˜
- **ç§Ÿæˆ·å˜æ›´**: ç§Ÿæˆ·é…ç½®å˜æ›´æ—¶å¤±æ•ˆç§Ÿæˆ·ç›¸å…³ç¼“å­˜

**ç¼“å­˜ä¸€è‡´æ€§ä¿è¯**ï¼š
- **äº‹ä»¶é©±åŠ¨**: é€šè¿‡é¢†åŸŸäº‹ä»¶è§¦å‘ç¼“å­˜å¤±æ•ˆ
- **åˆ†å¸ƒå¼é”**: é˜²æ­¢ç¼“å­˜å‡»ç©¿å’Œé›ªå´©
- **ç‰ˆæœ¬æ§åˆ¶**: ç¼“å­˜ç‰ˆæœ¬å·ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **å¼‚æ­¥æ›´æ–°**: éå…³é”®è·¯å¾„ä½¿ç”¨å¼‚æ­¥ç¼“å­˜æ›´æ–°

---

## ğŸ—ï¸ æ ¸å¿ƒå®ä½“è®¾è®¡

### 5.1 ç§Ÿæˆ·ç®¡ç†é¢†åŸŸå®ä½“

#### 5.1.1 ç§Ÿæˆ·å®ä½“ (Tenant)
**èšåˆæ ¹ï¼Œä»£è¡¨ç³»ç»Ÿä¸­çš„ç§Ÿæˆ·ç»„ç»‡**

**æ ¸å¿ƒå±æ€§**ï¼š
- `id: TenantId` - ç§Ÿæˆ·å”¯ä¸€æ ‡è¯†
- `code: TenantCode` - ç§Ÿæˆ·ä»£ç ï¼ˆå…¨å±€å”¯ä¸€ï¼‰
- `name: TenantName` - ç§Ÿæˆ·åç§°ï¼ˆå…¨å±€å”¯ä¸€ï¼‰
- `domain: TenantDomain` - ç§Ÿæˆ·åŸŸå
- `status: TenantStatus` - ç§Ÿæˆ·çŠ¶æ€ï¼ˆæ¿€æ´»/åœç”¨ï¼‰
- `adminId: UserId` - ç§Ÿæˆ·ç®¡ç†å‘˜ID
- `config: TenantConfig` - ç§Ÿæˆ·é…ç½®ä¿¡æ¯
- `createdAt: Date` - åˆ›å»ºæ—¶é—´
- `updatedAt: Date` - æ›´æ–°æ—¶é—´

**ä¸šåŠ¡è§„åˆ™**ï¼š
- ç§Ÿæˆ·ä»£ç å¿…é¡»å…¨å±€å”¯ä¸€
- ç§Ÿæˆ·åç§°å¿…é¡»å…¨å±€å”¯ä¸€
- æ¯ä¸ªç§Ÿæˆ·æœ‰ä¸”åªèƒ½æœ‰ä¸€ä¸ªç®¡ç†å‘˜
- é»˜è®¤ç³»ç»Ÿç§Ÿæˆ·ä¸èƒ½è¢«åˆ é™¤æˆ–åœç”¨

#### 5.1.2 ç§Ÿæˆ·ç”³è¯·å®ä½“ (TenantApplication)
**èšåˆæ ¹ï¼Œç®¡ç†ç§Ÿæˆ·åˆ›å»ºç”³è¯·æµç¨‹**

**æ ¸å¿ƒå±æ€§**ï¼š
- `id: ApplicationId` - ç”³è¯·å”¯ä¸€æ ‡è¯†
- `applicantId: UserId` - ç”³è¯·äººID
- `tenantName: TenantName` - ç”³è¯·ç§Ÿæˆ·åç§°
- `tenantCode: TenantCode` - ç”³è¯·ç§Ÿæˆ·ä»£ç 
- `description: string` - ç”³è¯·æè¿°
- `status: ApplicationStatus` - ç”³è¯·çŠ¶æ€
- `reviewerId: UserId` - å®¡æ ¸äººID
- `reviewComment: string` - å®¡æ ¸æ„è§
- `reviewedAt: Date` - å®¡æ ¸æ—¶é—´
- `createdAt: Date` - ç”³è¯·æ—¶é—´

### 5.2 ç”¨æˆ·ç®¡ç†é¢†åŸŸå®ä½“

#### 5.2.1 ç”¨æˆ·å®ä½“ (User)
**èšåˆæ ¹ï¼Œä»£è¡¨ç³»ç»Ÿä¸­çš„ç”¨æˆ·**

**æ ¸å¿ƒå±æ€§**ï¼š
- `id: UserId` - ç”¨æˆ·å”¯ä¸€æ ‡è¯†
- `email: Email` - é‚®ç®±åœ°å€ï¼ˆå…¨å±€å”¯ä¸€ï¼‰
- `username: Username` - ç”¨æˆ·å
- `nickname: Nickname` - æ˜µç§°ï¼ˆå…¨å±€å”¯ä¸€ï¼‰
- `password: Password` - åŠ å¯†å¯†ç 
- `firstName: string` - å
- `lastName: string`

---

## ğŸ—ï¸ DDDä¸Clean Architectureå®æ–½æŒ‡å—

### 7.1 DDDå®æ–½åŸåˆ™

#### 7.1.1 é¢†åŸŸå»ºæ¨¡åŸåˆ™
- **ä»¥ä¸šåŠ¡ä¸ºä¸­å¿ƒ**: æ‰€æœ‰è®¾è®¡å†³ç­–éƒ½åŸºäºä¸šåŠ¡éœ€æ±‚å’Œä¸šåŠ¡è§„åˆ™
- **ç»Ÿä¸€è¯­è¨€**: ä½¿ç”¨ä¸šåŠ¡æœ¯è¯­è¿›è¡Œæ²Ÿé€šå’Œå»ºæ¨¡ï¼Œç¡®ä¿å¼€å‘å›¢é˜Ÿå’Œä¸šåŠ¡å›¢é˜Ÿè¯­è¨€ä¸€è‡´
- **è¾¹ç•Œä¸Šä¸‹æ–‡**: æ˜ç¡®å®šä¹‰æ¯ä¸ªé¢†åŸŸçš„è¾¹ç•Œï¼Œé¿å…æ¦‚å¿µæ··æ·†
- **èšåˆæ ¹è®¾è®¡**: æ¯ä¸ªèšåˆéƒ½æœ‰æ˜ç¡®çš„èšåˆæ ¹ï¼Œç¡®ä¿ä¸šåŠ¡ä¸€è‡´æ€§

#### 7.1.2 é¢†åŸŸå¯¹è±¡è®¾è®¡
- **å®ä½“ (Entity)**: æœ‰å”¯ä¸€æ ‡è¯†çš„å¯¹è±¡ï¼Œå¯ä»¥æ”¹å˜çŠ¶æ€
- **å€¼å¯¹è±¡ (Value Object)**: ä¸å¯å˜çš„å¯¹è±¡ï¼Œé€šè¿‡å±æ€§å€¼åˆ¤æ–­ç›¸ç­‰æ€§
- **èšåˆæ ¹ (Aggregate Root)**: èšåˆçš„å…¥å£ç‚¹ï¼Œç¡®ä¿ä¸šåŠ¡ä¸€è‡´æ€§
- **é¢†åŸŸæœåŠ¡ (Domain Service)**: å¤„ç†è·¨èšåˆçš„ä¸šåŠ¡é€»è¾‘
- **é¢†åŸŸäº‹ä»¶ (Domain Event)**: è¡¨ç¤ºé¢†åŸŸå†…å‘ç”Ÿçš„é‡è¦äº‹ä»¶

#### 7.1.3 é¢†åŸŸäº‹ä»¶è®¾è®¡
- **äº‹ä»¶å‘½å**: ä½¿ç”¨è¿‡å»æ—¶æ€ï¼Œè¡¨ç¤ºå·²å‘ç”Ÿçš„äº‹å®
- **äº‹ä»¶æ•°æ®**: åŒ…å«äº‹ä»¶å‘ç”Ÿæ—¶çš„å®Œæ•´ä¸Šä¸‹æ–‡ä¿¡æ¯
- **äº‹ä»¶å‘å¸ƒ**: ç”±èšåˆæ ¹å‘å¸ƒï¼Œç¡®ä¿äº‹ä»¶çš„ä¸€è‡´æ€§
- **äº‹ä»¶å¤„ç†**: é€šè¿‡äº‹ä»¶å¤„ç†å™¨å®ç°é¢†åŸŸé—´çš„æ¾è€¦åˆé€šä¿¡

### 7.2 Clean Architectureå®æ–½åŸåˆ™

#### 7.2.1 åˆ†å±‚æ¶æ„åŸåˆ™
- **ä¾èµ–æ–¹å‘**: ä¾èµ–å…³ç³»ä»å¤–å‘å†…ï¼Œå†…å±‚ä¸ä¾èµ–å¤–å±‚
- **æ¥å£éš”ç¦»**: æ¯å±‚é€šè¿‡æ¥å£ä¸ç›¸é‚»å±‚äº¤äº’
- **å•ä¸€èŒè´£**: æ¯å±‚åªè´Ÿè´£è‡ªå·±çš„èŒè´£ï¼Œä¸è¶Šç•Œ
- **å¼€é—­åŸåˆ™**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
- **Use Caseså°è£…**: åº”ç”¨å±‚é€šè¿‡Use Caseså°è£…ä¸šåŠ¡ç”¨ä¾‹ï¼Œç¡®ä¿ä¸šåŠ¡é€»è¾‘çš„å®Œæ•´æ€§

#### 7.2.2 ä¾èµ–å€’ç½®åŸåˆ™
- **æŠ½è±¡ä¾èµ–**: é«˜å±‚æ¨¡å—ä¾èµ–æŠ½è±¡ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
- **æ¥å£å®šä¹‰**: åœ¨é¢†åŸŸå±‚å®šä¹‰æ¥å£ï¼Œåœ¨åŸºç¡€è®¾æ–½å±‚å®ç°
- **ä¾èµ–æ³¨å…¥**: é€šè¿‡ä¾èµ–æ³¨å…¥å®¹å™¨ç®¡ç†ä¾èµ–å…³ç³»
- **æµ‹è¯•å‹å¥½**: é€šè¿‡æŠ½è±¡æ¥å£ä¾¿äºå•å…ƒæµ‹è¯•

#### 7.2.3 æ¨¡å—åŒ–è®¾è®¡åŸåˆ™
- **æ¨¡å—è¾¹ç•Œ**: æ¯ä¸ªæ¨¡å—æœ‰æ˜ç¡®çš„è¾¹ç•Œå’ŒèŒè´£
- **æ¨¡å—é€šä¿¡**: é€šè¿‡æ¥å£å’Œäº‹ä»¶è¿›è¡Œæ¨¡å—é—´é€šä¿¡
- **æ¨¡å—ç‹¬ç«‹**: æ¯ä¸ªæ¨¡å—å¯ä»¥ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²
- **å…±äº«å†…æ ¸**: é€šè¿‡å…±äº«å†…æ ¸æä¾›é€šç”¨åŠŸèƒ½

### 7.3 å¼€å‘å®è·µæŒ‡å—

#### 7.3.1 ä»£ç ç»„ç»‡
```
modules/tenant-management/
â”œâ”€â”€ domain/                    # é¢†åŸŸå±‚
â”‚   â”œâ”€â”€ entities/             # å®ä½“
â”‚   â”œâ”€â”€ value-objects/        # å€¼å¯¹è±¡
â”‚   â”œâ”€â”€ aggregates/           # èšåˆæ ¹
â”‚   â”œâ”€â”€ services/             # é¢†åŸŸæœåŠ¡
â”‚   â”œâ”€â”€ events/               # é¢†åŸŸäº‹ä»¶
â”‚   â”œâ”€â”€ repositories/         # ä»“å‚¨æ¥å£
â”‚   â””â”€â”€ exceptions/           # é¢†åŸŸå¼‚å¸¸
â”œâ”€â”€ application/              # åº”ç”¨å±‚
â”‚   â”œâ”€â”€ services/             # åº”ç”¨æœåŠ¡
â”‚   â”œâ”€â”€ use-cases/            # ä¸šåŠ¡ç”¨ä¾‹
â”‚   â”‚   â”œâ”€â”€ commands/         # å‘½ä»¤ç”¨ä¾‹
â”‚   â”‚   â”‚   â”œâ”€â”€ create-tenant.command.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ register-user.command.ts
â”‚   â”‚   â”‚   â””â”€â”€ assign-role.command.ts
â”‚   â”‚   â”œâ”€â”€ queries/          # æŸ¥è¯¢ç”¨ä¾‹
â”‚   â”‚   â”‚   â”œâ”€â”€ get-user-profile.query.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ get-user-permissions.query.ts
â”‚   â”‚   â”‚   â””â”€â”€ get-organization-tree.query.ts
â”‚   â”‚   â””â”€â”€ handlers/         # ç”¨ä¾‹å¤„ç†å™¨
â”‚   â”‚       â”œâ”€â”€ create-tenant.handler.ts
â”‚   â”‚       â”œâ”€â”€ register-user.handler.ts
â”‚   â”‚       â””â”€â”€ assign-role.handler.ts
â”‚   â”œâ”€â”€ dto/                  # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ interfaces/           # åº”ç”¨æ¥å£
â”‚   â””â”€â”€ validators/           # åº”ç”¨æ ¡éªŒå™¨
â”œâ”€â”€ infrastructure/           # åŸºç¡€è®¾æ–½å±‚
â”‚   â”œâ”€â”€ entities/             # ORMå®ä½“
â”‚   â”œâ”€â”€ repositories/         # ä»“å‚¨å®ç°
â”‚   â”œâ”€â”€ external/             # å¤–éƒ¨æœåŠ¡
â”‚   â””â”€â”€ config/               # é…ç½®
â””â”€â”€ presentation/             # è¡¨ç°å±‚
    â”œâ”€â”€ controllers/          # æ§åˆ¶å™¨
    â”œâ”€â”€ dto/                  # è¡¨ç°å±‚DTO
    â”œâ”€â”€ validators/           # è¡¨ç°å±‚æ ¡éªŒå™¨
    â””â”€â”€ guards/               # å®ˆå«
```

#### 7.3.2 å‘½åè§„èŒƒ
- **èšåˆæ ¹**: ä½¿ç”¨ä¸šåŠ¡æœ¯è¯­ï¼Œå¦‚ `Tenant`, `User`, `Organization`
- **å®ä½“**: ä½¿ç”¨ä¸šåŠ¡æ¦‚å¿µï¼Œå¦‚ `TenantConfig`, `UserProfile`
- **å€¼å¯¹è±¡**: ä½¿ç”¨æè¿°æ€§åç§°ï¼Œå¦‚ `TenantId`, `Email`, `Password`
- **é¢†åŸŸæœåŠ¡**: ä»¥ `DomainService` ç»“å°¾ï¼Œå¦‚ `TenantDomainService`
- **åº”ç”¨æœåŠ¡**: ä»¥ `Service` ç»“å°¾ï¼Œå¦‚ `TenantApplicationService`
- **ä»“å‚¨æ¥å£**: ä»¥ `Repository` ç»“å°¾ï¼Œå¦‚ `TenantRepository`
- **Use Cases**: ä»¥ `UseCase` ç»“å°¾ï¼Œå¦‚ `CreateTenantUseCase`, `GetUserProfileUseCase`
- **Commands**: ä»¥ `Command` ç»“å°¾ï¼Œå¦‚ `CreateTenantCommand`, `AssignRoleCommand`
- **Queries**: ä»¥ `Query` ç»“å°¾ï¼Œå¦‚ `GetUserProfileQuery`, `GetUserPermissionsQuery`
- **Handlers**: ä»¥ `Handler` ç»“å°¾ï¼Œå¦‚ `CreateTenantHandler`, `GetUserProfileHandler`

#### 7.3.3 æµ‹è¯•ç­–ç•¥
- **å•å…ƒæµ‹è¯•**: æµ‹è¯•é¢†åŸŸå¯¹è±¡å’Œé¢†åŸŸæœåŠ¡
- **é›†æˆæµ‹è¯•**: æµ‹è¯•åº”ç”¨æœåŠ¡å’Œä»“å‚¨å®ç°
- **ç«¯åˆ°ç«¯æµ‹è¯•**: æµ‹è¯•å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
- **æµ‹è¯•æ•°æ®**: ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºæµ‹è¯•æ•°æ®
- **Use Casesæµ‹è¯•**: æµ‹è¯•ä¸šåŠ¡ç”¨ä¾‹çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§
- **å‘½ä»¤æŸ¥è¯¢æµ‹è¯•**: åˆ†åˆ«æµ‹è¯•å‘½ä»¤å’ŒæŸ¥è¯¢ç”¨ä¾‹
- **å¼‚å¸¸æµ‹è¯•**: æµ‹è¯•Use Casesçš„å¼‚å¸¸å¤„ç†é€»è¾‘

### 7.4 æ¶æ„ä¼˜åŠ¿

#### 7.4.1 ä¸šåŠ¡ä¼˜åŠ¿
- **ä¸šåŠ¡å“åº”æ€§**: ä¸šåŠ¡å˜æ›´æ—¶ç³»ç»Ÿèƒ½å¤Ÿå¿«é€Ÿå“åº”
- **ä¸šåŠ¡ä¸€è‡´æ€§**: é€šè¿‡èšåˆæ ¹ç¡®ä¿ä¸šåŠ¡è§„åˆ™çš„ä¸€è‡´æ€§
- **ä¸šåŠ¡å¯ç†è§£æ€§**: ä»£ç ç»“æ„åæ˜ ä¸šåŠ¡ç»“æ„ï¼Œä¾¿äºç†è§£å’Œç»´æŠ¤
- **ä¸šåŠ¡å¯æ‰©å±•æ€§**: æ–°ä¸šåŠ¡åŠŸèƒ½å¯ä»¥ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²

#### 7.4.2 æŠ€æœ¯ä¼˜åŠ¿
- **æŠ€æœ¯ç‹¬ç«‹æ€§**: ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°è§£è€¦
- **å¯æµ‹è¯•æ€§**: é€šè¿‡ä¾èµ–å€’ç½®ä¾¿äºå•å…ƒæµ‹è¯•
- **å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„å±‚æ¬¡ç»“æ„ä¾¿äºç»´æŠ¤å’Œé‡æ„
- **å¯æ‰©å±•æ€§**: æ¨¡å—åŒ–è®¾è®¡æ”¯æŒæ°´å¹³æ‰©å±•

#### 7.4.3 å›¢é˜Ÿä¼˜åŠ¿
- **å›¢é˜Ÿåä½œ**: åŸºäºé¢†åŸŸè¾¹ç•Œè¿›è¡Œå›¢é˜Ÿåˆ†å·¥
- **çŸ¥è¯†å…±äº«**: ç»Ÿä¸€è¯­è¨€ä¿ƒè¿›å›¢é˜Ÿæ²Ÿé€š
- **å¹¶è¡Œå¼€å‘**: æ¨¡å—åŒ–è®¾è®¡æ”¯æŒå¹¶è¡Œå¼€å‘
- **è´¨é‡ä¿è¯**: æ¸…æ™°çš„æ¶æ„ä¾¿äºä»£ç å®¡æŸ¥å’Œè´¨é‡æ§åˆ¶

### 7.5 Use Casesè®¾è®¡æŒ‡å—

#### 7.5.1 Use Casesæ¦‚è¿°
Use Casesæ˜¯åº”ç”¨å±‚çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£å°è£…å…·ä½“çš„ä¸šåŠ¡ç”¨ä¾‹ï¼Œåè°ƒé¢†åŸŸå¯¹è±¡å®Œæˆä¸šåŠ¡æ“ä½œã€‚

**Use Casesçš„ç‰¹ç‚¹**ï¼š
- **å•ä¸€èŒè´£**: æ¯ä¸ªUse Caseåªè´Ÿè´£ä¸€ä¸ªå…·ä½“çš„ä¸šåŠ¡ç”¨ä¾‹
- **ä¸šåŠ¡å®Œæ•´æ€§**: ç¡®ä¿ä¸šåŠ¡ç”¨ä¾‹çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§
- **åè°ƒä½œç”¨**: åè°ƒå¤šä¸ªé¢†åŸŸå¯¹è±¡å®Œæˆå¤æ‚ä¸šåŠ¡æ“ä½œ
- **äº‹åŠ¡è¾¹ç•Œ**: å®šä¹‰ä¸šåŠ¡æ“ä½œçš„äº‹åŠ¡è¾¹ç•Œ
- **è¾“å…¥è¾“å‡º**: æ˜ç¡®çš„è¾“å…¥å‚æ•°å’Œè¾“å‡ºç»“æœ

#### 7.5.2 Use Casesåˆ†ç±»

**å‘½ä»¤ç”¨ä¾‹ (Commands)**ï¼š
- ä¿®æ”¹ç³»ç»ŸçŠ¶æ€çš„ä¸šåŠ¡æ“ä½œ
- è¿”å›æ“ä½œç»“æœï¼Œä¸è¿”å›æ•°æ®
- ä¾‹å¦‚ï¼šåˆ›å»ºç§Ÿæˆ·ã€æ³¨å†Œç”¨æˆ·ã€åˆ†é…è§’è‰²

**æŸ¥è¯¢ç”¨ä¾‹ (Queries)**ï¼š
- æŸ¥è¯¢ç³»ç»Ÿæ•°æ®çš„ä¸šåŠ¡æ“ä½œ
- è¿”å›æŸ¥è¯¢ç»“æœï¼Œä¸ä¿®æ”¹çŠ¶æ€
- ä¾‹å¦‚ï¼šè·å–ç”¨æˆ·ä¿¡æ¯ã€æŸ¥è¯¢æƒé™ã€è·å–ç»„ç»‡æ¶æ„

#### 7.5.3 Use Casesè®¾è®¡æ¨¡å¼

**Command Pattern**ï¼š
```typescript
// å‘½ä»¤æ¥å£
interface ICommand {
  execute(): Promise<CommandResult>;
}

// å‘½ä»¤å¤„ç†å™¨æ¥å£
interface ICommandHandler<T extends ICommand> {
  handle(command: T): Promise<CommandResult>;
}

// å…·ä½“å‘½ä»¤
class CreateTenantCommand implements ICommand {
  constructor(
    public readonly tenantName: string,
    public readonly tenantCode: string,
    public readonly adminId: string
  ) {}
}

// å‘½ä»¤å¤„ç†å™¨
class CreateTenantHandler implements ICommandHandler<CreateTenantCommand> {
  async handle(command: CreateTenantCommand): Promise<CommandResult> {
    // ä¸šåŠ¡é€»è¾‘å®ç°
  }
}
```

**Query Pattern**ï¼š
```typescript
// æŸ¥è¯¢æ¥å£
interface IQuery<TResult> {
  execute(): Promise<TResult>;
}

// æŸ¥è¯¢å¤„ç†å™¨æ¥å£
interface IQueryHandler<TQuery extends IQuery<TResult>, TResult> {
  handle(query: TQuery): Promise<TResult>;
}

// å…·ä½“æŸ¥è¯¢
class GetUserProfileQuery implements IQuery<UserProfileDto> {
  constructor(public readonly userId: string) {}
}

// æŸ¥è¯¢å¤„ç†å™¨
class GetUserProfileHandler implements IQueryHandler<GetUserProfileQuery, UserProfileDto> {
  async handle(query: GetUserProfileQuery): Promise<UserProfileDto> {
    // æŸ¥è¯¢é€»è¾‘å®ç°
  }
}
```

#### 7.5.4 Use Caseså®ç°åŸåˆ™

**ä¾èµ–æ³¨å…¥**ï¼š
- Use Casesé€šè¿‡ä¾èµ–æ³¨å…¥è·å–é¢†åŸŸæœåŠ¡å’Œä»“å‚¨
- ç¡®ä¿Use Casesçš„å¯æµ‹è¯•æ€§å’Œå¯ç»´æŠ¤æ€§

**äº‹åŠ¡ç®¡ç†**ï¼š
- æ¯ä¸ªUse Caseå®šä¹‰æ˜ç¡®çš„äº‹åŠ¡è¾¹ç•Œ
- ç¡®ä¿ä¸šåŠ¡æ“ä½œçš„ä¸€è‡´æ€§å’ŒåŸå­æ€§

**å¼‚å¸¸å¤„ç†**ï¼š
- ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- å°†é¢†åŸŸå¼‚å¸¸è½¬æ¢ä¸ºåº”ç”¨å±‚å¼‚å¸¸

**éªŒè¯é€»è¾‘**ï¼š
- è¾“å…¥å‚æ•°çš„ä¸šåŠ¡è§„åˆ™éªŒè¯
- ç¡®ä¿æ•°æ®çš„æœ‰æ•ˆæ€§å’Œä¸€è‡´æ€§

#### 7.5.5 Use Casesç¤ºä¾‹

**åˆ›å»ºç§Ÿæˆ·ç”¨ä¾‹**ï¼š
```typescript
@Injectable()
export class CreateTenantUseCase {
  constructor(
    private readonly tenantRepository: ITenantRepository,
    private readonly userRepository: IUserRepository,
    private readonly eventBus: IEventBus
  ) {}

  async execute(command: CreateTenantCommand): Promise<CreateTenantResult> {
    // 1. éªŒè¯è¾“å…¥å‚æ•°
    await this.validateCommand(command);

    // 2. æ£€æŸ¥ä¸šåŠ¡è§„åˆ™
    await this.checkBusinessRules(command);

    // 3. åˆ›å»ºç§Ÿæˆ·èšåˆæ ¹
    const tenant = Tenant.create(
      new TenantId(command.tenantId),
      new TenantName(command.tenantName),
      new TenantCode(command.tenantCode),
      new UserId(command.adminId)
    );

    // 4. ä¿å­˜ç§Ÿæˆ·
    await this.tenantRepository.save(tenant);

    // 5. å‘å¸ƒé¢†åŸŸäº‹ä»¶
    await this.eventBus.publish(new TenantCreatedEvent(tenant));

    // 6. è¿”å›ç»“æœ
    return new CreateTenantResult(tenant.id.value);
  }

  private async validateCommand(command: CreateTenantCommand): Promise<void> {
    // éªŒè¯é€»è¾‘
  }

  private async checkBusinessRules(command: CreateTenantCommand): Promise<void> {
    // ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
  }
}
```

**è·å–ç”¨æˆ·æƒé™ç”¨ä¾‹**ï¼š
```typescript
@Injectable()
export class GetUserPermissionsUseCase {
  constructor(
    private readonly userRepository: IUserRepository,
    private readonly permissionService: IPermissionService,
    private readonly cacheService: ICacheService
  ) {}

  async execute(query: GetUserPermissionsQuery): Promise<UserPermissionsDto> {
    // 1. å°è¯•ä»ç¼“å­˜è·å–
    const cacheKey = `user:permissions:${query.userId}:${query.tenantId}`;
    let permissions = await this.cacheService.get(cacheKey);

    if (!permissions) {
      // 2. è·å–ç”¨æˆ·ä¿¡æ¯
      const user = await this.userRepository.findById(new UserId(query.userId));
      if (!user) {
        throw new UserNotFoundException(query.userId);
      }

      // 3. è®¡ç®—ç”¨æˆ·æƒé™
      permissions = await this.permissionService.calculateUserPermissions(user);

      // 4. ç¼“å­˜ç»“æœ
      await this.cacheService.set(cacheKey, permissions, 300);
    }

    // 5. è¿”å›æƒé™ä¿¡æ¯
    return UserPermissionsDto.fromDomain(permissions);
  }
}
```

#### 7.5.6 Use Casesæµ‹è¯•ç­–ç•¥

**å•å…ƒæµ‹è¯•**ï¼š
- æµ‹è¯•Use Caseçš„ä¸šåŠ¡é€»è¾‘
- æ¨¡æ‹Ÿä¾èµ–çš„æœåŠ¡å’Œä»“å‚¨
- éªŒè¯è¾“å…¥è¾“å‡ºå’Œå¼‚å¸¸å¤„ç†

**é›†æˆæµ‹è¯•**ï¼š
- æµ‹è¯•Use Caseä¸é¢†åŸŸå±‚çš„é›†æˆ
- éªŒè¯äº‹åŠ¡è¾¹ç•Œå’Œäº‹ä»¶å‘å¸ƒ
- æµ‹è¯•ç¼“å­˜å’Œæ€§èƒ½ä¼˜åŒ–

**ç«¯åˆ°ç«¯æµ‹è¯•**ï¼š
- æµ‹è¯•å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
- éªŒè¯Use Caseåœ¨çœŸå®ç¯å¢ƒä¸­çš„è¡¨ç°
- æµ‹è¯•æ€§èƒ½å’Œå¹¶å‘å¤„ç†

### 4.6 è¯·æ±‚è¿½è¸ªä¸ç§Ÿæˆ·ä¸Šä¸‹æ–‡æ¶æ„ (Request Tracing & Tenant Context Architecture)

#### 4.6.1 è¯·æ±‚è¿½è¸ªæ¶æ„
ç³»ç»Ÿå®ç°å®Œæ•´çš„è¯·æ±‚è¿½è¸ªæœºåˆ¶ï¼Œç¡®ä¿æ¯ä¸ªHTTPè¯·æ±‚éƒ½æœ‰å”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œæ”¯æŒå…¨é“¾è·¯è¿½è¸ªå’Œé—®é¢˜æ’æŸ¥ã€‚

**æ ¸å¿ƒç»„ä»¶**ï¼š
- **RequestIdç”Ÿæˆå™¨**: ç”Ÿæˆå…¨å±€å”¯ä¸€çš„è¯·æ±‚ID
- **è¯·æ±‚ä¸Šä¸‹æ–‡**: å­˜å‚¨è¯·æ±‚ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- **è¿½è¸ªä¸­é—´ä»¶**: è‡ªåŠ¨æ³¨å…¥è¯·æ±‚IDå’Œä¸Šä¸‹æ–‡ä¿¡æ¯
- **æ—¥å¿—å…³è”**: æ‰€æœ‰æ—¥å¿—éƒ½å…³è”åˆ°è¯·æ±‚ID
- **æ€§èƒ½ç›‘æ§**: åŸºäºè¯·æ±‚IDçš„æ€§èƒ½æ•°æ®æ”¶é›†

**è¯·æ±‚IDæ ¼å¼**ï¼š
```typescript
// è¯·æ±‚IDæ ¼å¼ï¼š{timestamp}-{random}-{instance}
// ç¤ºä¾‹ï¼š20241201143022-abc123def456-instance-01
const requestId = `${timestamp}-${randomString}-${instanceId}`;
```

#### 4.6.2 ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†
ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å’Œç®¡ç†ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼Œç¡®ä¿å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

**ç§Ÿæˆ·è¯†åˆ«ç­–ç•¥**ï¼š
- **åŸŸåè¯†åˆ«**: é€šè¿‡è¯·æ±‚åŸŸåè¯†åˆ«ç§Ÿæˆ·
- **å­åŸŸåè¯†åˆ«**: é€šè¿‡å­åŸŸåè¯†åˆ«ç§Ÿæˆ·
- **è·¯å¾„è¯†åˆ«**: é€šè¿‡URLè·¯å¾„è¯†åˆ«ç§Ÿæˆ·
- **Headerè¯†åˆ«**: é€šè¿‡è‡ªå®šä¹‰Headerè¯†åˆ«ç§Ÿæˆ·
- **Tokenè¯†åˆ«**: é€šè¿‡JWT Tokenè¯†åˆ«ç§Ÿæˆ·

**ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç¼“å­˜**ï¼š
- **å†…å­˜ç¼“å­˜**: ç§Ÿæˆ·ä¿¡æ¯çš„å†…å­˜ç¼“å­˜
- **Redisç¼“å­˜**: ç§Ÿæˆ·ä¿¡æ¯çš„åˆ†å¸ƒå¼ç¼“å­˜
- **ç¼“å­˜ç­–ç•¥**: TTL + å˜æ›´å¤±æ•ˆç­–ç•¥
- **ç¼“å­˜é”®è®¾è®¡**: `tenant:context:${tenantId}`

#### 4.6.3 ä¸Šä¸‹æ–‡ä¼ æ’­æœºåˆ¶
è¯·æ±‚ä¸Šä¸‹æ–‡ä¿¡æ¯åœ¨æ•´ä¸ªè¯·æ±‚ç”Ÿå‘½å‘¨æœŸä¸­è‡ªåŠ¨ä¼ æ’­ã€‚

**ä¸Šä¸‹æ–‡ä¿¡æ¯**ï¼š
```typescript
interface RequestContext {
  requestId: string;           // è¯·æ±‚å”¯ä¸€ID
  tenantId: string;           // ç§Ÿæˆ·ID
  userId: string;             // ç”¨æˆ·ID
  correlationId: string;      // å…³è”IDï¼ˆç”¨äºè·¨æœåŠ¡è¿½è¸ªï¼‰
  timestamp: Date;            // è¯·æ±‚æ—¶é—´æˆ³
  userAgent: string;          // ç”¨æˆ·ä»£ç†
  ipAddress: string;          // IPåœ°å€
  sessionId: string;          // ä¼šè¯ID
}
```

**ä¸Šä¸‹æ–‡ä¼ æ’­**ï¼š
- **HTTP Header**: é€šè¿‡è‡ªå®šä¹‰Headerä¼ æ’­
- **AsyncLocalStorage**: Node.jså¼‚æ­¥ä¸Šä¸‹æ–‡ä¼ æ’­
- **äº‹ä»¶ä¼ æ’­**: é¢†åŸŸäº‹ä»¶åŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯
- **æ—¥å¿—ä¼ æ’­**: æ‰€æœ‰æ—¥å¿—è‡ªåŠ¨åŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯

### 6.8 è¯·æ±‚è¿½è¸ªä¸ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†æµç¨‹

#### 6.8.1 è¯·æ±‚è¿½è¸ªæµç¨‹
1. **è¯·æ±‚æ¥æ”¶**
   - ç”Ÿæˆå”¯ä¸€è¯·æ±‚ID
   - åˆ›å»ºè¯·æ±‚ä¸Šä¸‹æ–‡
   - è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´

2. **ä¸Šä¸‹æ–‡æ³¨å…¥**
   - å°†è¯·æ±‚IDæ³¨å…¥åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡
   - å°†ä¸Šä¸‹æ–‡ä¿¡æ¯ä¼ æ’­åˆ°æ‰€æœ‰ç»„ä»¶
   - è®¾ç½®AsyncLocalStorage

3. **ä¸šåŠ¡å¤„ç†**
   - æ‰€æœ‰ä¸šåŠ¡æ“ä½œéƒ½å…³è”è¯·æ±‚ID
   - é¢†åŸŸäº‹ä»¶åŒ…å«è¯·æ±‚ä¸Šä¸‹æ–‡
   - æ—¥å¿—è®°å½•åŒ…å«è¯·æ±‚ID

4. **å“åº”è¿”å›**
   - è®°å½•è¯·æ±‚ç»“æŸæ—¶é—´
   - è®¡ç®—è¯·æ±‚å¤„ç†æ—¶é—´
   - æ¸…ç†è¯·æ±‚ä¸Šä¸‹æ–‡

#### 6.8.2 ç§Ÿæˆ·ä¸Šä¸‹æ–‡è¯†åˆ«æµç¨‹
1. **ç§Ÿæˆ·è¯†åˆ«**
   - è§£æè¯·æ±‚åŸŸå/å­åŸŸå
   - æ£€æŸ¥è‡ªå®šä¹‰Header
   - è§£æJWT Token
   - ç¡®å®šç§Ÿæˆ·ID

2. **ç§Ÿæˆ·éªŒè¯**
   - éªŒè¯ç§Ÿæˆ·æ˜¯å¦å­˜åœ¨
   - æ£€æŸ¥ç§Ÿæˆ·çŠ¶æ€
   - éªŒè¯ç§Ÿæˆ·æƒé™

3. **ä¸Šä¸‹æ–‡ç¼“å­˜**
   - æŸ¥è¯¢ç§Ÿæˆ·ä¿¡æ¯ç¼“å­˜
   - ç¼“å­˜æœªå‘½ä¸­æ—¶ä»æ•°æ®åº“åŠ è½½
   - æ›´æ–°ç§Ÿæˆ·ä¿¡æ¯ç¼“å­˜
   - è®¾ç½®ç¼“å­˜TTL

4. **ä¸Šä¸‹æ–‡ä¼ æ’­**
   - å°†ç§Ÿæˆ·IDæ³¨å…¥è¯·æ±‚ä¸Šä¸‹æ–‡
   - ä¼ æ’­åˆ°æ‰€æœ‰ä¸šåŠ¡ç»„ä»¶
   - ç¡®ä¿å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»

#### 6.8.3 è·¨æœåŠ¡è¿½è¸ªæµç¨‹
1. **å…³è”IDç”Ÿæˆ**
   - ä¸ºæ¯ä¸ªè¯·æ±‚ç”Ÿæˆå…³è”ID
   - å…³è”IDåœ¨è·¨æœåŠ¡è°ƒç”¨ä¸­ä¿æŒä¸å˜
   - æ”¯æŒåˆ†å¸ƒå¼è¿½è¸ª

2. **æœåŠ¡é—´ä¼ æ’­**
   - HTTP Headerä¼ æ’­å…³è”ID
   - æ¶ˆæ¯é˜Ÿåˆ—ä¼ æ’­å…³è”ID
   - äº‹ä»¶æ€»çº¿ä¼ æ’­å…³è”ID

3. **è¿½è¸ªæ•°æ®æ”¶é›†**
   - æ”¶é›†å„æœåŠ¡çš„å¤„ç†æ—¶é—´
   - è®°å½•æœåŠ¡é—´çš„è°ƒç”¨å…³ç³»
   - ç”Ÿæˆå®Œæ•´çš„è°ƒç”¨é“¾è·¯

4. **æ€§èƒ½åˆ†æ**
   - åˆ†æè¯·æ±‚å¤„ç†ç“¶é¢ˆ
   - è¯†åˆ«æ…¢æŸ¥è¯¢å’Œæ€§èƒ½é—®é¢˜
   - ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š

### 7.6 è¯·æ±‚è¿½è¸ªä¸ç§Ÿæˆ·ä¸Šä¸‹æ–‡å®ç°æŒ‡å—

#### 7.6.1 è¯·æ±‚è¿½è¸ªä¸­é—´ä»¶å®ç°
```typescript
@Injectable()
export class RequestTracingMiddleware implements NestMiddleware {
  constructor(
    private readonly requestContextService: RequestContextService,
    private readonly logger: PinoLogger
  ) {}

  use(req: Request, res: Response, next: NextFunction) {
    // 1. ç”Ÿæˆè¯·æ±‚ID
    const requestId = this.generateRequestId();
    
    // 2. åˆ›å»ºè¯·æ±‚ä¸Šä¸‹æ–‡
    const context: RequestContext = {
      requestId,
      tenantId: null,
      userId: null,
      correlationId: req.headers['x-correlation-id'] as string || requestId,
      timestamp: new Date(),
      userAgent: req.headers['user-agent'],
      ipAddress: req.ip,
      sessionId: req.session?.id
    };

    // 3. è®¾ç½®AsyncLocalStorage
    this.requestContextService.setContext(context);

    // 4. æ³¨å…¥è¯·æ±‚IDåˆ°å“åº”å¤´
    res.setHeader('x-request-id', requestId);

    // 5. è®°å½•è¯·æ±‚å¼€å§‹æ—¥å¿—
    this.logger.info('Request started', {
      requestId,
      method: req.method,
      url: req.url,
      ip: req.ip
    });

    // 6. è®°å½•è¯·æ±‚ç»“æŸ
    res.on('finish', () => {
      const duration = Date.now() - context.timestamp.getTime();
      this.logger.info('Request finished', {
        requestId,
        statusCode: res.statusCode,
        duration
      });
    });

    next();
  }

  private generateRequestId(): string {
    const timestamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0];
    const random = Math.random().toString(36).substring(2, 15);
    const instanceId = process.env.INSTANCE_ID || 'instance-01';
    return `${timestamp}-${random}-${instanceId}`;
  }
}
```

#### 7.6.2 ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸­é—´ä»¶å®ç°
```typescript
@Injectable()
export class TenantContextMiddleware implements NestMiddleware {
  constructor(
    private readonly tenantContextService: TenantContextService,
    private readonly tenantRepository: ITenantRepository,
    private readonly cacheService: ICacheService
  ) {}

  async use(req: Request, res: Response, next: NextFunction) {
    try {
      // 1. è¯†åˆ«ç§Ÿæˆ·
      const tenantId = await this.identifyTenant(req);
      
      if (tenantId) {
        // 2. è·å–ç§Ÿæˆ·ä¸Šä¸‹æ–‡
        const tenantContext = await this.getTenantContext(tenantId);
        
        // 3. æ›´æ–°è¯·æ±‚ä¸Šä¸‹æ–‡
        this.tenantContextService.setTenantContext(tenantContext);
        
        // 4. æ³¨å…¥ç§Ÿæˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¯¹è±¡
        req.tenant = tenantContext;
      }

      next();
    } catch (error) {
      next(error);
    }
  }

  private async identifyTenant(req: Request): Promise<string | null> {
    // 1. ä»åŸŸåè¯†åˆ«
    const hostname = req.hostname;
    const tenantFromDomain = await this.identifyTenantFromDomain(hostname);
    if (tenantFromDomain) return tenantFromDomain;

    // 2. ä»Headerè¯†åˆ«
    const tenantFromHeader = req.headers['x-tenant-id'] as string;
    if (tenantFromHeader) return tenantFromHeader;

    // 3. ä»JWT Tokenè¯†åˆ«
    const token = req.headers.authorization?.replace('Bearer ', '');
    if (token) {
      const tenantFromToken = await this.identifyTenantFromToken(token);
      if (tenantFromToken) return tenantFromToken;
    }

    return null;
  }

  private async getTenantContext(tenantId: string): Promise<TenantContext> {
    // 1. å°è¯•ä»ç¼“å­˜è·å–
    const cacheKey = `tenant:context:${tenantId}`;
    let tenantContext = await this.cacheService.get(cacheKey);

    if (!tenantContext) {
      // 2. ä»æ•°æ®åº“åŠ è½½
      const tenant = await this.tenantRepository.findById(new TenantId(tenantId));
      if (!tenant) {
        throw new TenantNotFoundException(tenantId);
      }

      // 3. åˆ›å»ºç§Ÿæˆ·ä¸Šä¸‹æ–‡
      tenantContext = {
        tenantId: tenant.id.value,
        tenantCode: tenant.code.value,
        tenantName: tenant.name.value,
        status: tenant.status.value,
        adminId: tenant.adminId.value,
        config: tenant.config
      };

      // 4. ç¼“å­˜ç§Ÿæˆ·ä¸Šä¸‹æ–‡
      await this.cacheService.set(cacheKey, tenantContext, 3600); // 1å°æ—¶TTL
    }

    return tenantContext;
  }
}
```

#### 7.6.3 è¯·æ±‚ä¸Šä¸‹æ–‡æœåŠ¡å®ç°
```typescript
@Injectable()
export class RequestContextService {
  private readonly asyncLocalStorage = new AsyncLocalStorage<RequestContext>();

  setContext(context: RequestContext): void {
    this.asyncLocalStorage.enterWith(context);
  }

  getContext(): RequestContext | undefined {
    return this.asyncLocalStorage.getStore();
  }

  getRequestId(): string | undefined {
    return this.getContext()?.requestId;
  }

  getTenantId(): string | undefined {
    return this.getContext()?.tenantId;
  }

  getUserId(): string | undefined {
    return this.getContext()?.userId;
  }

  getCorrelationId(): string | undefined {
    return this.getContext()?.correlationId;
  }

  // ç”¨äºæ—¥å¿—è®°å½•
  getLogContext(): Record<string, any> {
    const context = this.getContext();
    if (!context) return {};

    return {
      requestId: context.requestId,
      tenantId: context.tenantId,
      userId: context.userId,
      correlationId: context.correlationId,
      timestamp: context.timestamp.toISOString()
    };
  }
}
```

#### 7.6.4 é¢†åŸŸäº‹ä»¶ä¸­çš„ä¸Šä¸‹æ–‡ä¼ æ’­
```typescript
// åŸºç¡€äº‹ä»¶ç±»
export abstract class BaseDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly requestId?: string;
  public readonly tenantId?: string;
  public readonly correlationId?: string;

  constructor() {
    this.eventId = generateEventId();
    this.occurredOn = new Date();
    
    // ä»è¯·æ±‚ä¸Šä¸‹æ–‡è·å–è¿½è¸ªä¿¡æ¯
    const context = this.getRequestContext();
    if (context) {
      this.requestId = context.requestId;
      this.tenantId = context.tenantId;
      this.correlationId = context.correlationId;
    }
  }

  private getRequestContext(): RequestContext | undefined {
    // é€šè¿‡ä¾èµ–æ³¨å…¥è·å–RequestContextService
    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥é€šè¿‡DIå®¹å™¨è·å–
    return undefined;
  }
}

// å…·ä½“äº‹ä»¶ç±»
export class TenantCreatedEvent extends BaseDomainEvent {
  constructor(
    public readonly tenant: Tenant
  ) {
    super();
  }
}
```

#### 7.6.5 æ—¥å¿—è®°å½•ä¸­çš„ä¸Šä¸‹æ–‡ä¼ æ’­
```typescript
// è‡ªå®šä¹‰æ—¥å¿—æ‹¦æˆªå™¨
@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  constructor(
    private readonly requestContextService: RequestContextService,
    private readonly logger: PinoLogger
  ) {}

  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const request = context.switchToHttp().getRequest();
    const logContext = this.requestContextService.getLogContext();

    // ä¸ºæ‰€æœ‰æ—¥å¿—æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯
    this.logger.setContext(logContext);

    return next.handle().pipe(
      tap({
        next: (data) => {
          this.logger.info('Request completed successfully', {
            ...logContext,
            responseData: data
          });
        },
        error: (error) => {
          this.logger.error('Request failed', {
            ...logContext,
            error: error.message,
            stack: error.stack
          });
        }
      })
    );
  }
}
```

#### 7.6.6 æ€§èƒ½ç›‘æ§é›†æˆ
```typescript
// æ€§èƒ½ç›‘æ§è£…é¥°å™¨
export function MonitorPerformance(operation: string) {
  return function (target: any, propertyKey: string, descriptor: PropertyDescriptor) {
    const originalMethod = descriptor.value;

    descriptor.value = async function (...args: any[]) {
      const startTime = Date.now();
      const requestId = this.requestContextService?.getRequestId();
      const tenantId = this.requestContextService?.getTenantId();

      try {
        const result = await originalMethod.apply(this, args);
        
        // è®°å½•æ€§èƒ½æŒ‡æ ‡
        const duration = Date.now() - startTime;
        this.metricsService.recordOperationDuration(operation, duration, {
          requestId,
          tenantId,
          success: true
        });

        return result;
      } catch (error) {
        // è®°å½•é”™è¯¯æŒ‡æ ‡
        const duration = Date.now() - startTime;
        this.metricsService.recordOperationDuration(operation, duration, {
          requestId,
          tenantId,
          success: false,
          error: error.message
        });

        throw error;
      }
    };

    return descriptor;
  };
}
```

#### 7.6.7 é…ç½®å’Œæ³¨å†Œ
```typescript
// app.module.ts
@Module({
  imports: [
    // å…¶ä»–æ¨¡å—...
  ],
  providers: [
    RequestContextService,
    TenantContextService,
    CorrelationService,
    {
      provide: APP_INTERCEPTOR,
      useClass: LoggingInterceptor,
    },
    {
      provide: APP_GUARD,
      useClass: TenantContextGuard,
    }
  ],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer
      .apply(RequestTracingMiddleware, TenantContextMiddleware)
      .forRoutes('*');
  }
}
```

### 4.7 MikroORMå¤šæ•°æ®åº“é€‚é…æ¶æ„ (MikroORM Multi-Database Architecture)

#### 4.7.1 æ¶æ„æ¦‚è¿°
ç³»ç»ŸåŸºäºMikroORMå®ç°å¤šæ•°æ®åº“é€‚é…ï¼Œæ”¯æŒPostgreSQLå’ŒMongoDBï¼Œé€šè¿‡ç»Ÿä¸€çš„æ¥å£å’Œé…ç½®å®ç°æ•°æ®åº“çš„çµæ´»åˆ‡æ¢ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- **ç»Ÿä¸€ORM**: æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½åŸºäºMikroORM
- **æ•°æ®åº“æŠ½è±¡**: é€šè¿‡æ¥å£æŠ½è±¡ä¸åŒæ•°æ®åº“çš„å·®å¼‚
- **é…ç½®é©±åŠ¨**: é€šè¿‡é…ç½®æ–‡ä»¶åˆ‡æ¢æ•°æ®åº“ç±»å‹
- **è¿ç§»ç®¡ç†**: ç»Ÿä¸€çš„æ•°æ®åº“è¿ç§»å’Œç‰ˆæœ¬æ§åˆ¶
- **äº‹åŠ¡æ”¯æŒ**: è·¨æ•°æ®åº“çš„äº‹åŠ¡ç®¡ç†

#### 4.7.2 æ•°æ®åº“é€‚é…å™¨è®¾è®¡

**åŸºç¡€é€‚é…å™¨æ¥å£**ï¼š
```typescript
interface IMikroOrmAdapter {
  // æ•°æ®åº“è¿æ¥ç®¡ç†
  connect(): Promise<void>;
  disconnect(): Promise<void>;
  isConnected(): boolean;
  
  // å®ä½“ç®¡ç†å™¨
  getEntityManager(): EntityManager;
  
  // äº‹åŠ¡ç®¡ç†
  beginTransaction(): Promise<EntityManager>;
  commitTransaction(em: EntityManager): Promise<void>;
  rollbackTransaction(em: EntityManager): Promise<void>;
  
  // è¿ç§»ç®¡ç†
  runMigrations(): Promise<void>;
  createMigration(): Promise<void>;
  
  // æ•°æ®åº“ä¿¡æ¯
  getDatabaseName(): string;
  getDatabaseType(): DatabaseType;
}
```

**PostgreSQLé€‚é…å™¨**ï¼š
```typescript
import { MikroORM } from '@mikro-orm/core';
import { SqlHighlighter } from '@mikro-orm/sql-highlighter';
import { TsMorphMetadataProvider } from '@mikro-orm/reflection';
import { Migrator } from '@mikro-orm/migrations';
import { EntityGenerator } from '@mikro-orm/entity-generator';
import { SeedManager } from '@mikro-orm/seeder';

@Injectable()
export class PostgresqlMikroOrmAdapter implements IMikroOrmAdapter {
  private mikroOrm: MikroORM;
  
  constructor(
    private readonly config: PostgresqlConfig,
    private readonly logger: PinoLogger
  ) {}
  
  async connect(): Promise<void> {
    this.mikroOrm = await MikroORM.init({
      type: 'postgresql',
      host: this.config.host,
      port: this.config.port,
      user: this.config.user,
      password: this.config.password,
      dbName: this.config.database,
      entities: this.config.entities,
      entitiesTs: this.config.entitiesTs,
      migrations: this.config.migrations,
      debug: this.config.debug || false,
      highlighter: new SqlHighlighter(),
      metadataProvider: TsMorphMetadataProvider,
      extensions: [Migrator, EntityGenerator, SeedManager],
      // PostgreSQLç‰¹å®šé…ç½®
      pool: {
        min: this.config.pool.min,
        max: this.config.pool.max,
        acquireTimeoutMillis: this.config.pool.acquireTimeout,
        createTimeoutMillis: this.config.pool.createTimeout,
        destroyTimeoutMillis: this.config.pool.destroyTimeout,
        idleTimeoutMillis: this.config.pool.idleTimeout,
        reapIntervalMillis: this.config.pool.reapInterval,
      }
    });
  }
  
  getEntityManager(): EntityManager {
    return this.mikroOrm.em;
  }
  
  async beginTransaction(): Promise<EntityManager> {
    return await this.mikroOrm.em.begin();
  }
  
  async commitTransaction(em: EntityManager): Promise<void> {
    await em.commit();
  }
  
  async rollbackTransaction(em: EntityManager): Promise<void> {
    await em.rollback();
  }
  
  async runMigrations(): Promise<void> {
    await this.mikroOrm.migrator.up();
  }
  
  async createMigration(): Promise<void> {
    await this.mikroOrm.migrator.createMigration();
  }
  
  getDatabaseName(): string {
    return this.config.database;
  }
  
  getDatabaseType(): DatabaseType {
    return DatabaseType.POSTGRESQL;
  }
}
```

**MongoDBé€‚é…å™¨**ï¼š
```typescript
import { MikroORM } from '@mikro-orm/core';
import { SqlHighlighter } from '@mikro-orm/sql-highlighter';
import { TsMorphMetadataProvider } from '@mikro-orm/reflection';
import { Migrator } from '@mikro-orm/migrations';
import { EntityGenerator } from '@mikro-orm/entity-generator';
import { SeedManager } from '@mikro-orm/seeder';

@Injectable()
export class MongodbMikroOrmAdapter implements IMikroOrmAdapter {
  private mikroOrm: MikroORM;
  
  constructor(
    private readonly config: MongodbConfig,
    private readonly logger: PinoLogger
  ) {}
  
  async connect(): Promise<void> {
    this.mikroOrm = await MikroORM.init({
      type: 'mongo',
      clientUrl: this.config.url,
      dbName: this.config.database,
      entities: this.config.entities,
      entitiesTs: this.config.entitiesTs,
      migrations: this.config.migrations,
      debug: this.config.debug || false,
      highlighter: new SqlHighlighter(),
      metadataProvider: TsMorphMetadataProvider,
      extensions: [Migrator, EntityGenerator, SeedManager],
      // MongoDBç‰¹å®šé…ç½®
      pool: {
        min: this.config.pool.min,
        max: this.config.pool.max,
        acquireTimeoutMillis: this.config.pool.acquireTimeout,
      },
      // MongoDBè¿æ¥é€‰é¡¹
      options: {
        useUnifiedTopology: true,
        useNewUrlParser: true,
        maxPoolSize: this.config.pool.max,
        minPoolSize: this.config.pool.min,
      }
    });
  }
  
  getEntityManager(): EntityManager {
    return this.mikroOrm.em;
  }
  
  async beginTransaction(): Promise<EntityManager> {
    // MongoDB 4.0+ æ”¯æŒäº‹åŠ¡
    return await this.mikroOrm.em.begin();
  }
  
  async commitTransaction(em: EntityManager): Promise<void> {
    await em.commit();
  }
  
  async rollbackTransaction(em: EntityManager): Promise<void> {
    await em.rollback();
  }
  
  async runMigrations(): Promise<void> {
    await this.mikroOrm.migrator.up();
  }
  
  async createMigration(): Promise<void> {
    await this.mikroOrm.migrator.createMigration();
  }
  
  getDatabaseName(): string {
    return this.config.database;
  }
  
  getDatabaseType(): DatabaseType {
    return DatabaseType.MONGODB;
  }
}
```

#### 4.7.3 æ•°æ®åº“å·¥å‚æ¨¡å¼

**æ•°æ®åº“å·¥å‚**ï¼š
```typescript
@Injectable()
export class MikroOrmFactory {
  constructor(
    private readonly postgresqlConfig: PostgresqlConfig,
    private readonly mongodbConfig: MongodbConfig,
    private readonly logger: PinoLogger
  ) {}
  
  createAdapter(databaseType: DatabaseType): IMikroOrmAdapter {
    switch (databaseType) {
      case DatabaseType.POSTGRESQL:
        return new PostgresqlMikroOrmAdapter(this.postgresqlConfig, this.logger);
      
      case DatabaseType.MONGODB:
        return new MongodbMikroOrmAdapter(this.mongodbConfig, this.logger);
      
      default:
        throw new UnsupportedDatabaseTypeError(databaseType);
    }
  }
  
  createConnectionManager(databaseType: DatabaseType): IConnectionManager {
    const adapter = this.createAdapter(databaseType);
    return new MikroOrmConnectionManager(adapter);
  }
}
```

#### 4.7.4 é…ç½®ç®¡ç†

**æ•°æ®åº“é…ç½®æ¥å£**ï¼š
```typescript
interface DatabaseConfig {
  type: DatabaseType;
  host: string;
  port: number;
  user: string;
  password: string;
  database: string;
  entities: string[];
  migrations: string[];
  pool: {
    min: number;
    max: number;
    acquireTimeout: number;
    createTimeout: number;
    destroyTimeout: number;
    idleTimeout: number;
    reapInterval: number;
  };
}

interface PostgresqlConfig extends DatabaseConfig {
  type: DatabaseType.POSTGRESQL;
  ssl?: boolean;
  schema?: string;
  entitiesTs?: string[];
  debug?: boolean;
}

interface MongodbConfig extends DatabaseConfig {
  type: DatabaseType.MONGODB;
  url: string;
  entitiesTs?: string[];
  debug?: boolean;
  options?: {
    useUnifiedTopology: boolean;
    useNewUrlParser: boolean;
    maxPoolSize: number;
    minPoolSize: number;
  };
}
```

**é…ç½®åŠ è½½**ï¼š
```typescript
@Injectable()
export class DatabaseConfigService {
  constructor(private readonly configService: ConfigService) {}
  
  getPostgresqlConfig(): PostgresqlConfig {
    return {
      type: DatabaseType.POSTGRESQL,
      host: this.configService.get('database.postgresql.host'),
      port: this.configService.get('database.postgresql.port'),
      user: this.configService.get('database.postgresql.user'),
      password: this.configService.get('database.postgresql.password'),
      database: this.configService.get('database.postgresql.database'),
      entities: this.configService.get('database.postgresql.entities'),
      entitiesTs: this.configService.get('database.postgresql.entitiesTs'),
      migrations: this.configService.get('database.postgresql.migrations'),
      pool: this.configService.get('database.postgresql.pool'),
      ssl: this.configService.get('database.postgresql.ssl'),
      schema: this.configService.get('database.postgresql.schema'),
      debug: this.configService.get('database.postgresql.debug'),
    };
  }
  
  getMongodbConfig(): MongodbConfig {
    return {
      type: DatabaseType.MONGODB,
      url: this.configService.get('database.mongodb.url'),
      database: this.configService.get('database.mongodb.database'),
      entities: this.configService.get('database.mongodb.entities'),
      entitiesTs: this.configService.get('database.mongodb.entitiesTs'),
      migrations: this.configService.get('database.mongodb.migrations'),
      pool: this.configService.get('database.mongodb.pool'),
      options: this.configService.get('database.mongodb.options'),
      debug: this.configService.get('database.mongodb.debug'),
    };
  }
  
  getCurrentDatabaseType(): DatabaseType {
    return this.configService.get('database.current') as DatabaseType;
  }
}
```

#### 4.7.5 ä»“å‚¨å®ç°é€‚é…

**åŸºç¡€ä»“å‚¨å®ç°**ï¼š
```typescript
@Injectable()
export class BaseRepository<T extends AnyEntity> {
  constructor(
    private readonly entityManager: EntityManager,
    private readonly entityClass: EntityClass<T>
  ) {}
  
  async findById(id: string): Promise<T | null> {
    return await this.entityManager.findOne(this.entityClass, { id } as any);
  }
  
  async save(entity: T): Promise<T> {
    await this.entityManager.persistAndFlush(entity);
    return entity;
  }
  
  async delete(entity: T): Promise<void> {
    await this.entityManager.removeAndFlush(entity);
  }
  
  async findOne(criteria: any): Promise<T | null> {
    return await this.entityManager.findOne(this.entityClass, criteria);
  }
  
  async find(criteria: any): Promise<T[]> {
    return await this.entityManager.find(this.entityClass, criteria);
  }
  
  async count(criteria: any): Promise<number> {
    return await this.entityManager.count(this.entityClass, criteria);
  }
}
```

**ç§Ÿæˆ·ä»“å‚¨å®ç°**ï¼š
```typescript
@Injectable()
export class TenantRepository extends BaseRepository<TenantEntity> implements ITenantRepository {
  constructor(
    @Inject('DATABASE_ADAPTER') private readonly databaseAdapter: IMikroOrmAdapter
  ) {
    super(databaseAdapter.getEntityManager(), TenantEntity);
  }
  
  async findByCode(code: TenantCode): Promise<TenantEntity | null> {
    return await this.findOne({ code: code.value });
  }
  
  async findByName(name: TenantName): Promise<TenantEntity | null> {
    return await this.findOne({ name: name.value });
  }
  
  async findByDomain(domain: string): Promise<TenantEntity | null> {
    return await this.findOne({ domain });
  }
  
  async findActiveTenants(): Promise<TenantEntity[]> {
    return await this.find({ status: TenantStatus.ACTIVE });
  }
}
```

#### 4.7.6 æ¨¡å—é…ç½®

**æ•°æ®åº“æ¨¡å—**ï¼š
```typescript
@Module({
  imports: [],
  providers: [
    DatabaseConfigService,
    MikroOrmFactory,
    {
      provide: 'DATABASE_ADAPTER',
      useFactory: (factory: MikroOrmFactory, config: DatabaseConfigService) => {
        const databaseType = config.getCurrentDatabaseType();
        return factory.createAdapter(databaseType);
      },
      inject: [MikroOrmFactory, DatabaseConfigService],
    },
    {
      provide: 'CONNECTION_MANAGER',
      useFactory: (factory: MikroOrmFactory, config: DatabaseConfigService) => {
        const databaseType = config.getCurrentDatabaseType();
        return factory.createConnectionManager(databaseType);
      },
      inject: [MikroOrmFactory, DatabaseConfigService],
    },
    // ä»“å‚¨æä¾›è€…
    {
      provide: ITenantRepository,
      useClass: TenantRepository,
    },
    {
      provide: IUserRepository,
      useClass: UserRepository,
    },
    // å…¶ä»–ä»“å‚¨...
  ],
  exports: [
    'DATABASE_ADAPTER',
    'CONNECTION_MANAGER',
    ITenantRepository,
    IUserRepository,
    // å…¶ä»–ä»“å‚¨...
  ],
})
export class DatabaseModule {}
```

#### 4.7.7 ç¯å¢ƒé…ç½®ç¤ºä¾‹

**å¼€å‘ç¯å¢ƒé…ç½®**ï¼š
```yaml
# config/database.yaml
database:
  current: postgresql  # æˆ– mongodb
  
  postgresql:
    host: localhost
    port: 5432
    user: postgres
    password: password
    database: iam_dev
    entities: ['dist/**/*.entity.js']
    entitiesTs: ['src/**/*.entity.ts']
    migrations: ['dist/migrations/*.js']
    debug: true
    ssl: false
    schema: public
    pool:
      min: 2
      max: 10
      acquireTimeout: 30000
      createTimeout: 30000
      destroyTimeout: 5000
      idleTimeout: 30000
      reapInterval: 1000
  
  mongodb:
    url: mongodb://localhost:27017
    database: iam_dev
    entities: ['dist/**/*.entity.js']
    entitiesTs: ['src/**/*.entity.ts']
    migrations: ['dist/migrations/*.js']
    debug: true
    pool:
      min: 2
      max: 10
      acquireTimeout: 30000
    options:
      useUnifiedTopology: true
      useNewUrlParser: true
      maxPoolSize: 10
      minPoolSize: 2
```

**ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š
```yaml
# config/database.yaml
database:
  current: postgresql
  
  postgresql:
    host: ${POSTGRES_HOST}
    port: ${POSTGRES_PORT}
    user: ${POSTGRES_USER}
    password: ${POSTGRES_PASSWORD}
    database: ${POSTGRES_DB}
    entities: ['dist/**/*.entity.js']
    entitiesTs: ['src/**/*.entity.ts']
    migrations: ['dist/migrations/*.js']
    debug: false
    ssl: true
    schema: public
    pool:
      min: 5
      max: 20
      acquireTimeout: 60000
      createTimeout: 60000
      destroyTimeout: 10000
      idleTimeout: 60000
      reapInterval: 2000
  
  mongodb:
    url: ${MONGO_URL}
    database: ${MONGO_DB}
    entities: ['dist/**/*.entity.js']
    entitiesTs: ['src/**/*.entity.ts']
    migrations: ['dist/migrations/*.js']
    debug: false
    pool:
      min: 5
      max: 20
      acquireTimeout: 60000
    options:
      useUnifiedTopology: true
      useNewUrlParser: true
      maxPoolSize: 20
      minPoolSize: 5
```

**TypeScripté…ç½®æ–‡ä»¶ç¤ºä¾‹**ï¼š
```typescript
// mikro-orm.config.ts
import { defineConfig } from '@mikro-orm/postgresql';
import { SqlHighlighter } from '@mikro-orm/sql-highlighter';
import { TsMorphMetadataProvider } from '@mikro-orm/reflection';
import { Migrator } from '@mikro-orm/migrations';
import { EntityGenerator } from '@mikro-orm/entity-generator';
import { SeedManager } from '@mikro-orm/seeder';

export default defineConfig({
  host: process.env.POSTGRES_HOST || 'localhost',
  port: parseInt(process.env.POSTGRES_PORT || '5432'),
  user: process.env.POSTGRES_USER || 'postgres',
  password: process.env.POSTGRES_PASSWORD || 'password',
  dbName: process.env.POSTGRES_DB || 'iam_system',
  entities: ['dist/**/*.entity.js'],
  entitiesTs: ['src/**/*.entity.ts'],
  migrations: ['dist/migrations/*.js'],
  debug: process.env.NODE_ENV === 'development',
  highlighter: new SqlHighlighter(),
  metadataProvider: TsMorphMetadataProvider,
  extensions: [Migrator, EntityGenerator, SeedManager],
  pool: {
    min: parseInt(process.env.DB_POOL_MIN || '2'),
    max: parseInt(process.env.DB_POOL_MAX || '10'),
    acquireTimeoutMillis: parseInt(process.env.DB_ACQUIRE_TIMEOUT || '30000'),
  },
  ssl: process.env.NODE_ENV === 'production',
});
```
  
  postgresql:
    host: localhost
    port: 5432
    user: postgres
    password: password
    database: iam_system
    entities: ['dist/**/*.entity.js']
    migrations: ['dist/migrations/*.js']
    pool:
      min: 2
      max: 10
      acquireTimeout: 30000
      createTimeout: 30000
      destroyTimeout: 5000
      idleTimeout: 30000
      reapInterval: 1000
    ssl: false
    schema: public
  
  mongodb:
    url: mongodb://localhost:27017
    database: iam_system
    entities: ['dist/**/*.entity.js']
    migrations: ['dist/migrations/*.js']
    pool:
      min: 2
      max: 10
      acquireTimeout: 30000
    options:
      useUnifiedTopology: true
      useNewUrlParser: true
      maxPoolSize: 10
      minPoolSize: 2
```

#### 4.7.8 è¿ç§»ç®¡ç†

**PostgreSQLè¿ç§»ç¤ºä¾‹**ï¼š
```typescript
// migrations/PostgreSqlMigration20241201.ts
import { Migration } from '@mikro-orm/migrations';

export class PostgreSqlMigration20241201 extends Migration {
  async up(): Promise<void> {
    this.addSql(`
      CREATE TABLE tenants (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        code VARCHAR(50) UNIQUE NOT NULL,
        name VARCHAR(100) UNIQUE NOT NULL,
        domain VARCHAR(255),
        status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
        admin_id UUID NOT NULL,
        config JSONB,
        created_at TIMESTAMP NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMP NOT NULL DEFAULT NOW()
      );
    `);
  }

  async down(): Promise<void> {
    this.addSql('DROP TABLE tenants;');
  }
}
```

**MongoDBè¿ç§»ç¤ºä¾‹**ï¼š
```typescript
// migrations/MongoDbMigration20241201.ts
import { Migration } from '@mikro-orm/migrations';

export class MongoDbMigration20241201 extends Migration {
  async up(): Promise<void> {
    await this.getCollection('tenants').createIndex(
      { code: 1 },
      { unique: true }
    );
    
    await this.getCollection('tenants').createIndex(
      { name: 1 },
      { unique: true }
    );
  }

  async down(): Promise<void> {
    await this.getCollection('tenants').dropIndex('code_1');
    await this.getCollection('tenants').dropIndex('name_1');
  }
}
```

### 6.9 æ•°æ®åº“é€‚é…ç®¡ç†æµç¨‹

#### 6.9.1 æ•°æ®åº“è¿æ¥ç®¡ç†æµç¨‹
1. **é…ç½®åŠ è½½**
   - è¯»å–æ•°æ®åº“é…ç½®æ–‡ä»¶
   - éªŒè¯é…ç½®å‚æ•°æœ‰æ•ˆæ€§
   - ç¡®å®šå½“å‰æ•°æ®åº“ç±»å‹

2. **é€‚é…å™¨åˆ›å»º**
   - æ ¹æ®æ•°æ®åº“ç±»å‹åˆ›å»ºå¯¹åº”é€‚é…å™¨
   - åˆå§‹åŒ–MikroORMå®ä¾‹
   - é…ç½®è¿æ¥æ± å‚æ•°

3. **è¿æ¥å»ºç«‹**
   - å»ºç«‹æ•°æ®åº“è¿æ¥
   - éªŒè¯è¿æ¥çŠ¶æ€
   - è®°å½•è¿æ¥ä¿¡æ¯

4. **è¿æ¥ç›‘æ§**
   - ç›‘æ§è¿æ¥æ± çŠ¶æ€
   - æ£€æµ‹è¿æ¥å¼‚å¸¸
   - è‡ªåŠ¨é‡è¿æœºåˆ¶

#### 6.9.2 æ•°æ®åº“è¿ç§»æµç¨‹
1. **è¿ç§»æ£€æµ‹**
   - æ£€æŸ¥æ•°æ®åº“ç‰ˆæœ¬
   - è¯†åˆ«å¾…æ‰§è¡Œçš„è¿ç§»
   - éªŒè¯è¿ç§»æ–‡ä»¶å®Œæ•´æ€§

2. **è¿ç§»æ‰§è¡Œ**
   - æŒ‰é¡ºåºæ‰§è¡Œè¿ç§»æ–‡ä»¶
   - è®°å½•è¿ç§»æ‰§è¡Œæ—¥å¿—
   - æ›´æ–°æ•°æ®åº“ç‰ˆæœ¬

3. **è¿ç§»å›æ»š**
   - æ”¯æŒè¿ç§»å›æ»šæ“ä½œ
   - éªŒè¯å›æ»šå®‰å…¨æ€§
   - è®°å½•å›æ»šæ—¥å¿—

4. **è¿ç§»éªŒè¯**
   - éªŒè¯è¿ç§»æ‰§è¡Œç»“æœ
   - æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
   - ç”Ÿæˆè¿ç§»æŠ¥å‘Š

#### 6.9.3 æ•°æ®åº“åˆ‡æ¢æµç¨‹
1. **åˆ‡æ¢å‡†å¤‡**
   - å¤‡ä»½å½“å‰æ•°æ®åº“
   - éªŒè¯ç›®æ ‡æ•°æ®åº“é…ç½®
   - å‡†å¤‡æ•°æ®è¿ç§»è„šæœ¬

2. **æ•°æ®è¿ç§»**
   - æ‰§è¡Œæ•°æ®å¯¼å‡º
   - è½¬æ¢æ•°æ®æ ¼å¼
   - å¯¼å…¥ç›®æ ‡æ•°æ®åº“

3. **é…ç½®æ›´æ–°**
   - æ›´æ–°åº”ç”¨é…ç½®
   - é‡å¯åº”ç”¨æœåŠ¡
   - éªŒè¯æœåŠ¡çŠ¶æ€

4. **åˆ‡æ¢éªŒè¯**
   - éªŒè¯æ•°æ®å®Œæ•´æ€§
   - æµ‹è¯•åº”ç”¨åŠŸèƒ½
   - ç›‘æ§ç³»ç»Ÿæ€§èƒ½

#### 6.9.4 äº‹åŠ¡ç®¡ç†æµç¨‹
1. **äº‹åŠ¡å¼€å§‹**
   - åˆ›å»ºäº‹åŠ¡ä¸Šä¸‹æ–‡
   - åˆ†é…äº‹åŠ¡ID
   - è®°å½•äº‹åŠ¡å¼€å§‹æ—¶é—´

2. **äº‹åŠ¡æ‰§è¡Œ**
   - æ‰§è¡Œæ•°æ®åº“æ“ä½œ
   - è®°å½•æ“ä½œæ—¥å¿—
   - ç›‘æ§äº‹åŠ¡çŠ¶æ€

3. **äº‹åŠ¡æäº¤**
   - éªŒè¯äº‹åŠ¡ä¸€è‡´æ€§
   - æäº¤äº‹åŠ¡å˜æ›´
   - é‡Šæ”¾äº‹åŠ¡èµ„æº

4. **äº‹åŠ¡å›æ»š**
   - æ£€æµ‹äº‹åŠ¡å¼‚å¸¸
   - å›æ»šäº‹åŠ¡å˜æ›´
   - è®°å½•å›æ»šæ—¥å¿—
```

### 4.8 é…ç½®ç®¡ç†æ¶æ„ (Configuration Management Architecture)

#### 4.8.1 é…ç½®ç®¡ç†æ¦‚è¿°
ç³»ç»Ÿé‡‡ç”¨ç»Ÿä¸€çš„é…ç½®ç®¡ç†æ¶æ„ï¼Œæ”¯æŒå¤šç¯å¢ƒã€å¤šç§Ÿæˆ·ã€å¤šæ•°æ®åº“çš„é…ç½®ç®¡ç†ï¼Œç¡®ä¿é…ç½®çš„å®‰å…¨æ€§ã€ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- **åˆ†å±‚é…ç½®**: ç³»ç»Ÿçº§ã€ç§Ÿæˆ·çº§ã€ç¯å¢ƒçº§é…ç½®åˆ†å±‚ç®¡ç†
- **é…ç½®éªŒè¯**: å¼ºç±»å‹é…ç½®éªŒè¯å’Œæ¨¡å¼æ£€æŸ¥
- **é…ç½®åŠ å¯†**: æ•æ„Ÿé…ç½®ä¿¡æ¯åŠ å¯†å­˜å‚¨
- **çƒ­é‡è½½**: æ”¯æŒé…ç½®å˜æ›´çƒ­é‡è½½
- **é…ç½®ç¼“å­˜**: é«˜æ€§èƒ½é…ç½®ç¼“å­˜æœºåˆ¶
- **é…ç½®å®¡è®¡**: é…ç½®å˜æ›´å®¡è®¡å’Œç‰ˆæœ¬æ§åˆ¶

#### 4.8.2 é…ç½®å±‚æ¬¡ç»“æ„

**é…ç½®å±‚æ¬¡**ï¼š
1. **ç³»ç»Ÿçº§é…ç½®**: åº”ç”¨åŸºç¡€é…ç½®ï¼Œå¦‚ç«¯å£ã€æ—¥å¿—çº§åˆ«ç­‰
2. **ç¯å¢ƒçº§é…ç½®**: å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒç‰¹å®šé…ç½®
3. **ç§Ÿæˆ·çº§é…ç½®**: ç§Ÿæˆ·ç‰¹å®šçš„ä¸šåŠ¡é…ç½®
4. **æ¨¡å—çº§é…ç½®**: å„ä¸šåŠ¡æ¨¡å—çš„ä¸“ç”¨é…ç½®
5. **è¿è¡Œæ—¶é…ç½®**: åŠ¨æ€é…ç½®å’ŒåŠŸèƒ½å¼€å…³

**é…ç½®ä¼˜å…ˆçº§**ï¼š
```
ç¯å¢ƒå˜é‡ > ç§Ÿæˆ·é…ç½® > ç¯å¢ƒé…ç½® > ç³»ç»Ÿé…ç½® > é»˜è®¤é…ç½®
```

#### 4.8.3 é…ç½®ç®¡ç†ç»„ä»¶è®¾è®¡

**é…ç½®æœåŠ¡æ¥å£**ï¼š
```typescript
interface IConfigurationService {
  // åŸºç¡€é…ç½®è·å–
  get<T>(key: string, defaultValue?: T): T;
  getOrThrow<T>(key: string): T;
  
  // é…ç½®éªŒè¯
  validate(): Promise<ValidationResult>;
  
  // é…ç½®é‡è½½
  reload(): Promise<void>;
  
  // é…ç½®ç›‘å¬
  watch(key: string, callback: (value: any) => void): void;
  
  // é…ç½®åŠ å¯†
  encrypt(value: string): string;
  decrypt(value: string): string;
  
  // ç§Ÿæˆ·é…ç½®
  getTenantConfig(tenantId: string, key: string): any;
  setTenantConfig(tenantId: string, key: string, value: any): Promise<void>;
}
```

**é…ç½®éªŒè¯å™¨**ï¼š
```typescript
@Injectable()
export class ConfigurationValidator {
  private readonly schemas = new Map<string, Joi.ObjectSchema>();

  constructor() {
    this.registerSchemas();
  }

  async validate(config: any): Promise<ValidationResult> {
    const errors: ValidationError[] = [];

    for (const [name, schema] of this.schemas) {
      try {
        await schema.validateAsync(config[name]);
      } catch (error) {
        errors.push({
          section: name,
          message: error.message,
          details: error.details
        });
      }
    }

    return {
      isValid: errors.length === 0,
      errors
    };
  }

  private registerSchemas(): void {
    // åº”ç”¨é…ç½®æ¨¡å¼
    this.schemas.set('app', Joi.object({
      port: Joi.number().port().default(3000),
      host: Joi.string().hostname().default('localhost'),
      environment: Joi.string().valid('development', 'test', 'production').required(),
      logLevel: Joi.string().valid('error', 'warn', 'info', 'debug').default('info'),
      cors: Joi.object({
        enabled: Joi.boolean().default(true),
        origins: Joi.array().items(Joi.string()).default(['*'])
      })
    }));

    // æ•°æ®åº“é…ç½®æ¨¡å¼
    this.schemas.set('database', Joi.object({
      current: Joi.string().valid('postgresql', 'mongodb').required(),
      postgresql: Joi.object({
        host: Joi.string().required(),
        port: Joi.number().port().default(5432),
        user: Joi.string().required(),
        password: Joi.string().required(),
        database: Joi.string().required(),
        entities: Joi.array().items(Joi.string()).default(['dist/**/*.entity.js']),
        entitiesTs: Joi.array().items(Joi.string()).default(['src/**/*.entity.ts']),
        migrations: Joi.array().items(Joi.string()).default(['dist/migrations/*.js']),
        debug: Joi.boolean().default(false),
        ssl: Joi.boolean().default(false),
        pool: Joi.object({
          min: Joi.number().min(1).default(2),
          max: Joi.number().min(1).default(10),
          acquireTimeout: Joi.number().default(30000)
        })
      }),
      mongodb: Joi.object({
        url: Joi.string().uri().required(),
        database: Joi.string().required(),
        entities: Joi.array().items(Joi.string()).default(['dist/**/*.entity.js']),
        entitiesTs: Joi.array().items(Joi.string()).default(['src/**/*.entity.ts']),
        migrations: Joi.array().items(Joi.string()).default(['dist/migrations/*.js']),
        debug: Joi.boolean().default(false),
        options: Joi.object({
          useUnifiedTopology: Joi.boolean().default(true),
          useNewUrlParser: Joi.boolean().default(true)
        })
      })
    }));

    // Redisé…ç½®æ¨¡å¼
    this.schemas.set('redis', Joi.object({
      host: Joi.string().required(),
      port: Joi.number().port().default(6379),
      password: Joi.string().optional(),
      db: Joi.number().min(0).default(0),
      keyPrefix: Joi.string().default('iam:'),
      ttl: Joi.number().min(1).default(3600)
    }));

    // JWTé…ç½®æ¨¡å¼
    this.schemas.set('jwt', Joi.object({
      secret: Joi.string().min(32).required(),
      expiresIn: Joi.string().default('24h'),
      refreshExpiresIn: Joi.string().default('7d'),
      issuer: Joi.string().required(),
      audience: Joi.string().required()
    }));

    // Event Sourcingé…ç½®æ¨¡å¼
    this.schemas.set('eventSourcing', Joi.object({
      enabled: Joi.boolean().default(true),
      snapshotInterval: Joi.number().min(1).default(100),
      eventRetentionDays: Joi.number().min(1).default(365),
      maxEventSize: Joi.number().min(1024).default(1024 * 1024), // 1MB
      compression: Joi.object({
        enabled: Joi.boolean().default(true),
        algorithm: Joi.string().valid('gzip', 'lz4').default('gzip')
      })
    }));
  }
}
```

**é…ç½®åŠ å¯†æœåŠ¡**ï¼š
```typescript
@Injectable()
export class ConfigurationEncryptionService {
  private readonly algorithm = 'aes-256-gcm';
  private readonly key: Buffer;

  constructor() {
    this.key = Buffer.from(process.env.CONFIG_ENCRYPTION_KEY || '', 'hex');
    if (this.key.length !== 32) {
      throw new Error('CONFIG_ENCRYPTION_KEY must be 32 bytes (64 hex characters)');
    }
  }

  encrypt(text: string): string {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipher(this.algorithm, this.key);
    cipher.setAAD(Buffer.from('config', 'utf8'));
    
    let encrypted = cipher.update(text, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    
    const authTag = cipher.getAuthTag();
    
    return `${iv.toString('hex')}:${authTag.toString('hex')}:${encrypted}`;
  }

  decrypt(encryptedText: string): string {
    const [ivHex, authTagHex, encrypted] = encryptedText.split(':');
    
    const iv = Buffer.from(ivHex, 'hex');
    const authTag = Buffer.from(authTagHex, 'hex');
    
    const decipher = crypto.createDecipher(this.algorithm, this.key);
    decipher.setAAD(Buffer.from('config', 'utf8'));
    decipher.setAuthTag(authTag);
    
    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    
    return decrypted;
  }

  isEncrypted(value: string): boolean {
    return value.includes(':') && value.split(':').length === 3;
  }
}
```

**é…ç½®ç¼“å­˜æœåŠ¡**ï¼š
```typescript
@Injectable()
export class ConfigurationCacheService {
  private readonly cache = new Map<string, { value: any; timestamp: number; ttl: number }>();
  private readonly defaultTTL = 300000; // 5åˆ†é’Ÿ

  get<T>(key: string): T | null {
    const item = this.cache.get(key);
    if (!item) return null;

    if (Date.now() - item.timestamp > item.ttl) {
      this.cache.delete(key);
      return null;
    }

    return item.value;
  }

  set<T>(key: string, value: T, ttl: number = this.defaultTTL): void {
    this.cache.set(key, {
      value,
      timestamp: Date.now(),
      ttl
    });
  }

  delete(key: string): void {
    this.cache.delete(key);
  }

  clear(): void {
    this.cache.clear();
  }

  getStats(): CacheStats {
    return {
      size: this.cache.size,
      keys: Array.from(this.cache.keys())
    };
  }
}
```

#### 4.8.4 é…ç½®åŠ è½½å™¨è®¾è®¡

**ç¯å¢ƒå˜é‡é…ç½®åŠ è½½å™¨**ï¼š
```typescript
@Injectable()
export class EnvironmentConfigLoader {
  load(): Record<string, any> {
    const config: Record<string, any> = {};

    // åº”ç”¨é…ç½®
    config.app = {
      port: parseInt(process.env.PORT || '3000'),
      host: process.env.HOST || 'localhost',
      environment: process.env.NODE_ENV || 'development',
      logLevel: process.env.LOG_LEVEL || 'info'
    };

    // æ•°æ®åº“é…ç½®
    config.database = {
      current: process.env.DATABASE_TYPE || 'postgresql',
      postgresql: {
        host: process.env.POSTGRES_HOST,
        port: parseInt(process.env.POSTGRES_PORT || '5432'),
        user: process.env.POSTGRES_USER,
        password: process.env.POSTGRES_PASSWORD,
        database: process.env.POSTGRES_DB,
        ssl: process.env.POSTGRES_SSL === 'true'
      },
      mongodb: {
        url: process.env.MONGO_URL,
        database: process.env.MONGO_DB
      }
    };

    // Redisé…ç½®
    config.redis = {
      host: process.env.REDIS_HOST || 'localhost',
      port: parseInt(process.env.REDIS_PORT || '6379'),
      password: process.env.REDIS_PASSWORD,
      db: parseInt(process.env.REDIS_DB || '0')
    };

    // JWTé…ç½®
    config.jwt = {
      secret: process.env.JWT_SECRET,
      expiresIn: process.env.JWT_EXPIRES_IN || '24h',
      issuer: process.env.JWT_ISSUER || 'iam-system',
      audience: process.env.JWT_AUDIENCE || 'iam-users'
    };

    return config;
  }
}
```

**æ–‡ä»¶é…ç½®åŠ è½½å™¨**ï¼š
```typescript
@Injectable()
export class FileConfigLoader {
  constructor(
    private readonly encryptionService: ConfigurationEncryptionService
  ) {}

  async load(configPath: string): Promise<Record<string, any>> {
    const config = await this.loadConfigFile(configPath);
    return this.decryptSensitiveValues(config);
  }

  private async loadConfigFile(path: string): Promise<Record<string, any>> {
    const ext = path.split('.').pop();
    
    switch (ext) {
      case 'json':
        return JSON.parse(await fs.readFile(path, 'utf8'));
      case 'yaml':
      case 'yml':
        return yaml.load(await fs.readFile(path, 'utf8'));
      case 'js':
        return require(path);
      default:
        throw new Error(`Unsupported config file format: ${ext}`);
    }
  }

  private decryptSensitiveValues(config: any): any {
    if (typeof config === 'string' && this.encryptionService.isEncrypted(config)) {
      return this.encryptionService.decrypt(config);
    }

    if (Array.isArray(config)) {
      return config.map(item => this.decryptSensitiveValues(item));
    }

    if (typeof config === 'object' && config !== null) {
      const decrypted: any = {};
      for (const [key, value] of Object.entries(config)) {
        decrypted[key] = this.decryptSensitiveValues(value);
      }
      return decrypted;
    }

    return config;
  }
}
```

#### 4.8.5 ç§Ÿæˆ·é…ç½®ç®¡ç†

**ç§Ÿæˆ·é…ç½®æœåŠ¡**ï¼š
```typescript
@Injectable()
export class TenantConfigurationService {
  constructor(
    private readonly configService: IConfigurationService,
    private readonly cacheService: ICacheService
  ) {}

  async getTenantConfig(tenantId: string, key: string): Promise<any> {
    const cacheKey = `tenant:config:${tenantId}:${key}`;
    
    // å°è¯•ä»ç¼“å­˜è·å–
    let config = await this.cacheService.get(cacheKey);
    if (config) return config;

    // ä»æ•°æ®åº“åŠ è½½
    config = await this.loadTenantConfigFromDatabase(tenantId, key);
    
    // ç¼“å­˜é…ç½®
    await this.cacheService.set(cacheKey, config, 300); // 5åˆ†é’ŸTTL
    
    return config;
  }

  async setTenantConfig(tenantId: string, key: string, value: any): Promise<void> {
    // ä¿å­˜åˆ°æ•°æ®åº“
    await this.saveTenantConfigToDatabase(tenantId, key, value);
    
    // æ¸…é™¤ç¼“å­˜
    const cacheKey = `tenant:config:${tenantId}:${key}`;
    await this.cacheService.delete(cacheKey);
    
    // å‘å¸ƒé…ç½®å˜æ›´äº‹ä»¶
    await this.publishConfigChangeEvent(tenantId, key, value);
  }

  async getTenantConfigs(tenantId: string): Promise<Record<string, any>> {
    const configs = await this.loadAllTenantConfigsFromDatabase(tenantId);
    return configs.reduce((acc, config) => {
      acc[config.key] = config.value;
      return acc;
    }, {} as Record<string, any>);
  }

  private async loadTenantConfigFromDatabase(tenantId: string, key: string): Promise<any> {
    // ä»æ•°æ®åº“åŠ è½½ç§Ÿæˆ·é…ç½®
    // è¿™é‡Œéœ€è¦å®ç°å…·ä½“çš„æ•°æ®åº“æŸ¥è¯¢é€»è¾‘
    return null;
  }

  private async saveTenantConfigToDatabase(tenantId: string, key: string, value: any): Promise<void> {
    // ä¿å­˜ç§Ÿæˆ·é…ç½®åˆ°æ•°æ®åº“
    // è¿™é‡Œéœ€è¦å®ç°å…·ä½“çš„æ•°æ®åº“ä¿å­˜é€»è¾‘
  }

  private async publishConfigChangeEvent(tenantId: string, key: string, value: any): Promise<void> {
    // å‘å¸ƒé…ç½®å˜æ›´äº‹ä»¶
    // è¿™é‡Œéœ€è¦å®ç°äº‹ä»¶å‘å¸ƒé€»è¾‘
  }
}
```

#### 4.8.6 é…ç½®æ¨¡å—é…ç½®

**é…ç½®æ¨¡å—**ï¼š
```typescript
@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      load: [
        () => ({
          app: {
            port: parseInt(process.env.PORT || '3000'),
            host: process.env.HOST || 'localhost',
            environment: process.env.NODE_ENV || 'development',
            logLevel: process.env.LOG_LEVEL || 'info'
          },
          database: {
            current: process.env.DATABASE_TYPE || 'postgresql',
            postgresql: {
              host: process.env.POSTGRES_HOST,
              port: parseInt(process.env.POSTGRES_PORT || '5432'),
              user: process.env.POSTGRES_USER,
              password: process.env.POSTGRES_PASSWORD,
              database: process.env.POSTGRES_DB,
              ssl: process.env.POSTGRES_SSL === 'true'
            },
            mongodb: {
              url: process.env.MONGO_URL,
              database: process.env.MONGO_DB
            }
          },
          redis: {
            host: process.env.REDIS_HOST || 'localhost',
            port: parseInt(process.env.REDIS_PORT || '6379'),
            password: process.env.REDIS_PASSWORD,
            db: parseInt(process.env.REDIS_DB || '0')
          },
          jwt: {
            secret: process.env.JWT_SECRET,
            expiresIn: process.env.JWT_EXPIRES_IN || '24h',
            issuer: process.env.JWT_ISSUER || 'iam-system',
            audience: process.env.JWT_AUDIENCE || 'iam-users'
          },
          eventSourcing: {
            enabled: process.env.EVENT_SOURCING_ENABLED !== 'false',
            snapshotInterval: parseInt(process.env.SNAPSHOT_INTERVAL || '100'),
            eventRetentionDays: parseInt(process.env.EVENT_RETENTION_DAYS || '365'),
            maxEventSize: parseInt(process.env.MAX_EVENT_SIZE || '1048576')
          }
        })
      ],
      validationSchema: Joi.object({
        app: Joi.object({
          port: Joi.number().port().default(3000),
          host: Joi.string().hostname().default('localhost'),
          environment: Joi.string().valid('development', 'test', 'production').required(),
          logLevel: Joi.string().valid('error', 'warn', 'info', 'debug').default('info')
        }),
        database: Joi.object({
          current: Joi.string().valid('postgresql', 'mongodb').required(),
          postgresql: Joi.object({
            host: Joi.string().required(),
            port: Joi.number().port().default(5432),
            user: Joi.string().required(),
            password: Joi.string().required(),
            database: Joi.string().required()
          }),
          mongodb: Joi.object({
            url: Joi.string().uri().required(),
            database: Joi.string().required()
          })
        }),
        redis: Joi.object({
          host: Joi.string().required(),
          port: Joi.number().port().default(6379),
          password: Joi.string().optional(),
          db: Joi.number().min(0).default(0)
        }),
        jwt: Joi.object({
          secret: Joi.string().min(32).required(),
          expiresIn: Joi.string().default('24h'),
          issuer: Joi.string().required(),
          audience: Joi.string().required()
        }),
        eventSourcing: Joi.object({
          enabled: Joi.boolean().default(true),
          snapshotInterval: Joi.number().min(1).default(100),
          eventRetentionDays: Joi.number().min(1).default(365),
          maxEventSize: Joi.number().min(1024).default(1048576)
        })
      }),
      validationOptions: {
        allowUnknown: true,
        abortEarly: false
      }
    })
  ],
  providers: [
    ConfigurationService,
    ConfigurationValidator,
    ConfigurationEncryptionService,
    ConfigurationCacheService,
    TenantConfigurationService,
    EnvironmentConfigLoader,
    FileConfigLoader
  ],
  exports: [
    ConfigurationService,
    ConfigurationValidator,
    ConfigurationEncryptionService,
    ConfigurationCacheService,
    TenantConfigurationService
  ]
})
export class ConfigurationModule {}
```

#### 4.8.7 ç¯å¢ƒé…ç½®ç¤ºä¾‹

**å¼€å‘ç¯å¢ƒé…ç½®**ï¼š
```yaml
# config/development.yaml
app:
  port: 3000
  host: localhost
  environment: development
  logLevel: debug
  cors:
    enabled: true
    origins: ['http://localhost:3000', 'http://localhost:3001']

database:
  current: postgresql
  postgresql:
    host: localhost
    port: 5432
    user: postgres
    password: password
    database: iam_dev
    entities: ['dist/**/*.entity.js']
    entitiesTs: ['src/**/*.entity.ts']
    migrations: ['dist/migrations/*.js']
    debug: true
    ssl: false
    pool:
      min: 2
      max: 10
      acquireTimeout: 30000
  mongodb:
    url: mongodb://localhost:27017
    database: iam_dev
    entities: ['dist/**/*.entity.js']
    entitiesTs: ['src/**/*.entity.ts']
    migrations: ['dist/migrations/*.js']
    debug: true

redis:
  host: localhost
  port: 6379
  password: null
  db: 0
  keyPrefix: 'iam:dev:'
  ttl: 3600

jwt:
  secret: your-super-secret-jwt-key-for-development-only
  expiresIn: 24h
  refreshExpiresIn: 7d
  issuer: iam-system
  audience: iam-users

eventSourcing:
  enabled: true
  snapshotInterval: 50
  eventRetentionDays: 30
  maxEventSize: 1048576
  compression:
    enabled: true
    algorithm: gzip

logging:
  level: debug
  format: pretty
  destination: console

security:
  bcryptRounds: 10
  sessionTimeout: 3600
  maxLoginAttempts: 5
  lockoutDuration: 900
```

**ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š
```yaml
# config/production.yaml
app:
  port: 3000
  host: 0.0.0.0
  environment: production
  logLevel: info
  cors:
    enabled: true
    origins: ['https://your-domain.com']

database:
  current: postgresql
  postgresql:
    host: ${POSTGRES_HOST}
    port: ${POSTGRES_PORT}
    user: ${POSTGRES_USER}
    password: ${POSTGRES_PASSWORD}
    database: ${POSTGRES_DB}
    entities: ['dist/**/*.entity.js']
    entitiesTs: ['src/**/*.entity.ts']
    migrations: ['dist/migrations/*.js']
    debug: false
    ssl: true
    pool:
      min: 5
      max: 20
      acquireTimeout: 60000

redis:
  host: ${REDIS_HOST}
  port: ${REDIS_PORT}
  password: ${REDIS_PASSWORD}
  db: 0
  keyPrefix: 'iam:prod:'
  ttl: 1800

jwt:
  secret: ${JWT_SECRET}
  expiresIn: 1h
  refreshExpiresIn: 7d
  issuer: iam-system
  audience: iam-users

eventSourcing:
  enabled: true
  snapshotInterval: 100
  eventRetentionDays: 365
  maxEventSize: 2097152
  compression:
    enabled: true
    algorithm: lz4

logging:
  level: info
  format: json
  destination: file
  file: /var/log/iam-system/app.log

security:
  bcryptRounds: 12
  sessionTimeout: 1800
  maxLoginAttempts: 3
  lockoutDuration: 1800
```

#### 4.8.8 é…ç½®ç®¡ç†æµç¨‹

**é…ç½®åŠ è½½æµç¨‹**ï¼š
1. **ç¯å¢ƒæ£€æµ‹**: æ£€æµ‹å½“å‰è¿è¡Œç¯å¢ƒ
2. **é…ç½®åŠ è½½**: æŒ‰ä¼˜å…ˆçº§åŠ è½½é…ç½®æ–‡ä»¶
3. **é…ç½®éªŒè¯**: éªŒè¯é…ç½®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
4. **é…ç½®è§£å¯†**: è§£å¯†æ•æ„Ÿé…ç½®ä¿¡æ¯
5. **é…ç½®ç¼“å­˜**: ç¼“å­˜é…ç½®ä¿¡æ¯
6. **é…ç½®åº”ç”¨**: å°†é…ç½®åº”ç”¨åˆ°å„ä¸ªæ¨¡å—

**é…ç½®æ›´æ–°æµç¨‹**ï¼š
1. **é…ç½®å˜æ›´**: æ£€æµ‹é…ç½®å˜æ›´
2. **é…ç½®éªŒè¯**: éªŒè¯æ–°é…ç½®çš„æœ‰æ•ˆæ€§
3. **é…ç½®å¤‡ä»½**: å¤‡ä»½å½“å‰é…ç½®
4. **é…ç½®åº”ç”¨**: åº”ç”¨æ–°é…ç½®
5. **é…ç½®é€šçŸ¥**: é€šçŸ¥ç›¸å…³æ¨¡å—é…ç½®å˜æ›´
6. **é…ç½®å®¡è®¡**: è®°å½•é…ç½®å˜æ›´æ—¥å¿—

**ç§Ÿæˆ·é…ç½®ç®¡ç†æµç¨‹**ï¼š
1. **é…ç½®ç»§æ‰¿**: ç§Ÿæˆ·é…ç½®ç»§æ‰¿ç³»ç»Ÿé»˜è®¤é…ç½®
2. **é…ç½®è¦†ç›–**: ç§Ÿæˆ·ç‰¹å®šé…ç½®è¦†ç›–é»˜è®¤é…ç½®
3. **é…ç½®éªŒè¯**: éªŒè¯ç§Ÿæˆ·é…ç½®çš„æœ‰æ•ˆæ€§
4. **é…ç½®ç¼“å­˜**: ç¼“å­˜ç§Ÿæˆ·é…ç½®ä¿¡æ¯
5. **é…ç½®åŒæ­¥**: åŒæ­¥ç§Ÿæˆ·é…ç½®åˆ°æ‰€æœ‰å®ä¾‹
6. **é…ç½®å®¡è®¡**: è®°å½•ç§Ÿæˆ·é…ç½®å˜æ›´

### 6.10 é…ç½®ç®¡ç†æµç¨‹

#### 6.10.1 é…ç½®åŠ è½½æµç¨‹
1. **ç¯å¢ƒæ£€æµ‹**
   - æ£€æµ‹NODE_ENVç¯å¢ƒå˜é‡
   - ç¡®å®šå½“å‰è¿è¡Œç¯å¢ƒï¼ˆdevelopment/test/productionï¼‰
   - åŠ è½½å¯¹åº”ç¯å¢ƒçš„é…ç½®æ–‡ä»¶

2. **é…ç½®åŠ è½½**
   - æŒ‰ä¼˜å…ˆçº§åŠ è½½é…ç½®æº
   - ç¯å¢ƒå˜é‡ > ç§Ÿæˆ·é…ç½® > ç¯å¢ƒé…ç½® > ç³»ç»Ÿé…ç½® > é»˜è®¤é…ç½®
   - åˆå¹¶é…ç½®ä¿¡æ¯

3. **é…ç½®éªŒè¯**
   - ä½¿ç”¨JoiéªŒè¯é…ç½®æ¨¡å¼
   - æ£€æŸ¥å¿…éœ€é…ç½®é¡¹
   - éªŒè¯é…ç½®å€¼ç±»å‹å’ŒèŒƒå›´

4. **é…ç½®è§£å¯†**
   - è¯†åˆ«åŠ å¯†çš„é…ç½®é¡¹
   - ä½¿ç”¨é…ç½®åŠ å¯†æœåŠ¡è§£å¯†
   - éªŒè¯è§£å¯†ç»“æœ

5. **é…ç½®ç¼“å­˜**
   - å°†é…ç½®ä¿¡æ¯ç¼“å­˜åˆ°å†…å­˜
   - è®¾ç½®ç¼“å­˜TTL
   - è®°å½•ç¼“å­˜çŠ¶æ€

6. **é…ç½®åº”ç”¨**
   - å°†é…ç½®åº”ç”¨åˆ°å„ä¸ªæ¨¡å—
   - åˆå§‹åŒ–ç›¸å…³æœåŠ¡
   - è®°å½•é…ç½®åº”ç”¨çŠ¶æ€

#### 6.10.2 é…ç½®æ›´æ–°æµç¨‹
1. **é…ç½®å˜æ›´æ£€æµ‹**
   - ç›‘æ§é…ç½®æ–‡ä»¶å˜æ›´
   - æ£€æµ‹ç¯å¢ƒå˜é‡å˜æ›´
   - æ¥æ”¶é…ç½®æ›´æ–°é€šçŸ¥

2. **é…ç½®éªŒè¯**
   - éªŒè¯æ–°é…ç½®çš„æœ‰æ•ˆæ€§
   - æ£€æŸ¥é…ç½®ä¾èµ–å…³ç³»
   - éªŒè¯é…ç½®å…¼å®¹æ€§

3. **é…ç½®å¤‡ä»½**
   - å¤‡ä»½å½“å‰é…ç½®
   - è®°å½•é…ç½®å˜æ›´å†å²
   - ä¿å­˜é…ç½®å¿«ç…§

4. **é…ç½®åº”ç”¨**
   - åº”ç”¨æ–°é…ç½®åˆ°å†…å­˜
   - æ›´æ–°é…ç½®ç¼“å­˜
   - é€šçŸ¥ç›¸å…³æ¨¡å—

5. **é…ç½®é€šçŸ¥**
   - å‘å¸ƒé…ç½®å˜æ›´äº‹ä»¶
   - é€šçŸ¥è®¢é˜…çš„æ¨¡å—
   - è§¦å‘é…ç½®é‡è½½

6. **é…ç½®å®¡è®¡**
   - è®°å½•é…ç½®å˜æ›´æ—¥å¿—
   - ç”Ÿæˆé…ç½®å®¡è®¡æŠ¥å‘Š
   - ä¿å­˜é…ç½®ç‰ˆæœ¬ä¿¡æ¯

#### 6.10.3 ç§Ÿæˆ·é…ç½®ç®¡ç†æµç¨‹
1. **é…ç½®ç»§æ‰¿**
   - ç§Ÿæˆ·é…ç½®ç»§æ‰¿ç³»ç»Ÿé»˜è®¤é…ç½®
   - åº”ç”¨ç§Ÿæˆ·ç‰¹å®šé…ç½®
   - åˆå¹¶é…ç½®å±‚æ¬¡

2. **é…ç½®è¦†ç›–**
   - ç§Ÿæˆ·ç‰¹å®šé…ç½®è¦†ç›–é»˜è®¤é…ç½®
   - éªŒè¯é…ç½®è¦†ç›–è§„åˆ™
   - åº”ç”¨é…ç½®ä¼˜å…ˆçº§

3. **é…ç½®éªŒè¯**
   - éªŒè¯ç§Ÿæˆ·é…ç½®çš„æœ‰æ•ˆæ€§
   - æ£€æŸ¥ç§Ÿæˆ·æƒé™
   - éªŒè¯é…ç½®çº¦æŸ

4. **é…ç½®ç¼“å­˜**
   - ç¼“å­˜ç§Ÿæˆ·é…ç½®ä¿¡æ¯
   - è®¾ç½®ç¼“å­˜é”®å‰ç¼€
   - ç®¡ç†ç¼“å­˜è¿‡æœŸ

5. **é…ç½®åŒæ­¥**
   - åŒæ­¥ç§Ÿæˆ·é…ç½®åˆ°æ‰€æœ‰å®ä¾‹
   - å¤„ç†é…ç½®å†²çª
   - ç¡®ä¿é…ç½®ä¸€è‡´æ€§

6. **é…ç½®å®¡è®¡**
   - è®°å½•ç§Ÿæˆ·é…ç½®å˜æ›´
   - ç”Ÿæˆç§Ÿæˆ·é…ç½®æŠ¥å‘Š
   - ä¿å­˜é…ç½®å†å²

#### 6.10.4 é…ç½®å®‰å…¨ç®¡ç†æµç¨‹
1. **æ•æ„Ÿé…ç½®è¯†åˆ«**
   - è¯†åˆ«æ•æ„Ÿé…ç½®é¡¹
   - æ ‡è®°éœ€è¦åŠ å¯†çš„é…ç½®
   - è®¾ç½®é…ç½®å®‰å…¨çº§åˆ«

2. **é…ç½®åŠ å¯†**
   - ä½¿ç”¨AES-256-GCMåŠ å¯†ç®—æ³•
   - ç”ŸæˆåŠ å¯†å¯†é’¥
   - åŠ å¯†æ•æ„Ÿé…ç½®å€¼

3. **é…ç½®å­˜å‚¨**
   - å®‰å…¨å­˜å‚¨åŠ å¯†é…ç½®
   - è®¾ç½®è®¿é—®æƒé™
   - å¤‡ä»½åŠ å¯†å¯†é’¥

4. **é…ç½®è®¿é—®æ§åˆ¶**
   - æ§åˆ¶é…ç½®è®¿é—®æƒé™
   - è®°å½•é…ç½®è®¿é—®æ—¥å¿—
   - ç›‘æ§å¼‚å¸¸è®¿é—®

5. **é…ç½®å®¡è®¡**
   - å®¡è®¡é…ç½®è®¿é—®è®°å½•
   - ç›‘æ§é…ç½®å˜æ›´
   - ç”Ÿæˆå®‰å…¨æŠ¥å‘Š

### 4.9 Pinoæ—¥å¿—æ¶æ„è®¾è®¡ (Pino Logging Architecture)

#### 4.9.1 Pinoæ—¥å¿—æ¦‚è¿°
ç³»ç»Ÿé‡‡ç”¨Pinoä½œä¸ºæ ¸å¿ƒæ—¥å¿—åº“ï¼Œæ›¿ä»£NestJSå†…ç½®Loggerï¼Œæä¾›é«˜æ€§èƒ½ã€ç»“æ„åŒ–çš„æ—¥å¿—è®°å½•èƒ½åŠ›ï¼Œæ”¯æŒå¤šç¯å¢ƒã€å¤šç§Ÿæˆ·çš„æ—¥å¿—ç®¡ç†éœ€æ±‚ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- **é«˜æ€§èƒ½**: Pinoæ˜¯Node.jsä¸­æœ€å¿«çš„æ—¥å¿—åº“ä¹‹ä¸€
- **ç»“æ„åŒ–æ—¥å¿—**: JSONæ ¼å¼è¾“å‡ºï¼Œä¾¿äºæ—¥å¿—åˆ†æå’Œå¤„ç†
- **ä½å†…å­˜å ç”¨**: æœ€å°åŒ–å†…å­˜ä½¿ç”¨ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯
- **å¯æ‰©å±•æ€§**: æ”¯æŒå¤šç§ä¼ è¾“æ–¹å¼å’Œæ ¼å¼åŒ–
- **å¤šç§Ÿæˆ·æ”¯æŒ**: æ”¯æŒç§Ÿæˆ·çº§åˆ«çš„æ—¥å¿—éš”ç¦»
- **è¯·æ±‚è¿½è¸ª**: é›†æˆè¯·æ±‚IDå’Œç§Ÿæˆ·ä¸Šä¸‹æ–‡

#### 4.9.2 Pinoæ—¥å¿—ç»„ä»¶è®¾è®¡

**Pinoæ—¥å¿—æœåŠ¡**ï¼š
```typescript
/**
 * @class PinoLoggerService
 * @description Pinoæ—¥å¿—æœåŠ¡ï¼Œæä¾›é«˜æ€§èƒ½æ—¥å¿—è®°å½•
 */
@Injectable()
export class PinoLoggerService {
  private readonly logger: pino.Logger;
  private readonly requestContextService: RequestContextService;

  constructor(
    private readonly configService: ConfigService,
    requestContextService: RequestContextService
  ) {
    this.requestContextService = requestContextService;
    this.logger = this.createLogger();
  }

  private createLogger(): pino.Logger {
    const config = this.configService.get('logging');
    
    const pinoConfig: pino.LoggerOptions = {
      level: config.level || 'info',
      name: 'iam-system',
      timestamp: pino.stdTimeFunctions.isoTime,
      formatters: {
        level: (label) => ({ level: label }),
        log: (object) => {
          // æ·»åŠ è¯·æ±‚ä¸Šä¸‹æ–‡ä¿¡æ¯
          const context = this.requestContextService.getLogContext();
          return { ...object, ...context };
        }
      },
      serializers: {
        req: pino.stdSerializers.req,
        res: pino.stdSerializers.res,
        err: pino.stdSerializers.err
      },
      transport: config.transport ? {
        target: config.transport.target,
        options: config.transport.options
      } : undefined
    };

    return pino(pinoConfig);
  }

  // åŸºç¡€æ—¥å¿—æ–¹æ³•
  trace(message: string, ...args: any[]): void {
    this.logger.trace(message, ...args);
  }

  debug(message: string, ...args: any[]): void {
    this.logger.debug(message, ...args);
  }

  info(message: string, ...args: any[]): void {
    this.logger.info(message, ...args);
  }

  warn(message: string, ...args: any[]): void {
    this.logger.warn(message, ...args);
  }

  error(message: string, error?: Error, ...args: any[]): void {
    this.logger.error(error || message, ...args);
  }

  fatal(message: string, error?: Error, ...args: any[]): void {
    this.logger.fatal(error || message, ...args);
  }

  // ä¸šåŠ¡æ—¥å¿—æ–¹æ³•
  logUserAction(userId: string, action: string, details?: any): void {
    this.info('User action', {
      userId,
      action,
      details,
      type: 'user_action'
    });
  }

  logTenantAction(tenantId: string, action: string, details?: any): void {
    this.info('Tenant action', {
      tenantId,
      action,
      details,
      type: 'tenant_action'
    });
  }

  logSecurityEvent(event: string, details?: any): void {
    this.warn('Security event', {
      event,
      details,
      type: 'security_event'
    });
  }

  logPerformance(operation: string, duration: number, details?: any): void {
    this.info('Performance metric', {
      operation,
      duration,
      details,
      type: 'performance'
    });
  }

  // è·å–å­æ—¥å¿—å™¨
  child(bindings: pino.Bindings): pino.Logger {
    return this.logger.child(bindings);
  }
}
```

**Pinoæ—¥å¿—ä¸­é—´ä»¶**ï¼š
```typescript
/**
 * @class PinoLoggingMiddleware
 * @description Pinoæ—¥å¿—ä¸­é—´ä»¶ï¼Œè®°å½•HTTPè¯·æ±‚æ—¥å¿—
 */
@Injectable()
export class PinoLoggingMiddleware implements NestMiddleware {
  constructor(
    private readonly logger: PinoLoggerService,
    private readonly requestContextService: RequestContextService
  ) {}

  use(req: Request, res: Response, next: NextFunction): void {
    const startTime = Date.now();
    const requestId = this.requestContextService.getRequestId();
    const tenantId = this.requestContextService.getTenantId();

    // è®°å½•è¯·æ±‚å¼€å§‹
    this.logger.info('HTTP request started', {
      method: req.method,
      url: req.url,
      userAgent: req.get('User-Agent'),
      ip: req.ip,
      requestId,
      tenantId
    });

    // ç›‘å¬å“åº”å®Œæˆ
    res.on('finish', () => {
      const duration = Date.now() - startTime;
      
      this.logger.info('HTTP request completed', {
        method: req.method,
        url: req.url,
        statusCode: res.statusCode,
        duration,
        requestId,
        tenantId,
        contentLength: res.get('Content-Length')
      });
    });

    // ç›‘å¬å“åº”é”™è¯¯
    res.on('error', (error) => {
      this.logger.error('HTTP response error', error, {
        method: req.method,
        url: req.url,
        requestId,
        tenantId
      });
    });

    next();
  }
}
```

**Pinoæ—¥å¿—æ‹¦æˆªå™¨**ï¼š
```typescript
/**
 * @class PinoLoggingInterceptor
 * @description Pinoæ—¥å¿—æ‹¦æˆªå™¨ï¼Œè®°å½•æ–¹æ³•è°ƒç”¨æ—¥å¿—
 */
@Injectable()
export class PinoLoggingInterceptor implements NestInterceptor {
  constructor(
    private readonly logger: PinoLoggerService,
    private readonly requestContextService: RequestContextService
  ) {}

  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const request = context.switchToHttp().getRequest();
    const { method, url } = request;
    const className = context.getClass().name;
    const methodName = context.getHandler().name;
    const requestId = this.requestContextService.getRequestId();
    const tenantId = this.requestContextService.getTenantId();

    const startTime = Date.now();

    this.logger.debug('Method call started', {
      className,
      methodName,
      method,
      url,
      requestId,
      tenantId
    });

    return next.handle().pipe(
      tap({
        next: (data) => {
          const duration = Date.now() - startTime;
          this.logger.debug('Method call completed', {
            className,
            methodName,
            method,
            url,
            duration,
            requestId,
            tenantId,
            success: true
          });
        },
        error: (error) => {
          const duration = Date.now() - startTime;
          this.logger.error('Method call failed', error, {
            className,
            methodName,
            method,
            url,
            duration,
            requestId,
            tenantId,
            success: false
          });
        }
      })
    );
  }
}
```

**Pinoæ—¥å¿—é…ç½®**ï¼š
```typescript
/**
 * @class PinoLoggerConfig
 * @description Pinoæ—¥å¿—é…ç½®ç®¡ç†
 */
@Injectable()
export class PinoLoggerConfig {
  constructor(private readonly configService: ConfigService) {}

  getConfig(): PinoLoggerConfig {
    const config = this.configService.get('logging');
    
    return {
      level: config.level || 'info',
      name: config.name || 'iam-system',
      timestamp: config.timestamp !== false,
      prettyPrint: config.prettyPrint || false,
      destination: config.destination || 1, // stdout
      transport: this.getTransportConfig(config),
      formatters: this.getFormatters(),
      serializers: this.getSerializers(),
      base: this.getBaseConfig()
    };
  }

  private getTransportConfig(config: any): any {
    if (!config.transport) return undefined;

    switch (config.transport.type) {
      case 'file':
        return {
          target: 'pino/file',
          options: {
            destination: config.transport.file,
            mkdir: true
          }
        };
      
      case 'rotating-file':
        return {
          target: 'pino/file',
          options: {
            destination: config.transport.file,
            mkdir: true
          }
        };
      
      case 'pretty':
        return {
          target: 'pino-pretty',
          options: {
            colorize: true,
            translateTime: 'SYS:standard',
            ignore: 'pid,hostname'
          }
        };
      
      default:
        return undefined;
    }
  }

  private getFormatters(): any {
    return {
      level: (label: string) => ({ level: label }),
      log: (object: any) => {
        // æ·»åŠ æ—¶é—´æˆ³å’Œè¿›ç¨‹ä¿¡æ¯
        return {
          ...object,
          timestamp: new Date().toISOString(),
          pid: process.pid,
          hostname: require('os').hostname()
        };
      }
    };
  }

  private getSerializers(): any {
    return {
      req: pino.stdSerializers.req,
      res: pino.stdSerializers.res,
      err: pino.stdSerializers.err,
      error: pino.stdSerializers.err
    };
  }

  private getBaseConfig(): any {
    return {
      pid: process.pid,
      hostname: require('os').hostname()
    };
  }
}
```

**Pinoæ—¥å¿—ä¼ è¾“å™¨**ï¼š
```typescript
/**
 * @class PinoLoggerTransport
 * @description Pinoæ—¥å¿—ä¼ è¾“å™¨ï¼Œæ”¯æŒå¤šç§è¾“å‡ºæ–¹å¼
 */
@Injectable()
export class PinoLoggerTransport {
  constructor(private readonly configService: ConfigService) {}

  createFileTransport(filePath: string): pino.TransportTargetOptions {
    return {
      target: 'pino/file',
      options: {
        destination: filePath,
        mkdir: true
      }
    };
  }

  createRotatingFileTransport(config: any): pino.TransportTargetOptions {
    return {
      target: 'pino/file',
      options: {
        destination: config.file,
        mkdir: true
      }
    };
  }

  createPrettyTransport(): pino.TransportTargetOptions {
    return {
      target: 'pino-pretty',
      options: {
        colorize: true,
        translateTime: 'SYS:standard',
        ignore: 'pid,hostname',
        messageFormat: '{msg} {req.method} {req.url} {responseTime}ms'
      }
    };
  }

  createElasticsearchTransport(config: any): pino.TransportTargetOptions {
    return {
      target: 'pino-elasticsearch',
      options: {
        node: config.node,
        index: config.index,
        'es-version': config.version || 7,
        flushBytes: config.flushBytes || 1000
      }
    };
  }

  createDatadogTransport(config: any): pino.TransportTargetOptions {
    return {
      target: 'pino-datadog',
      options: {
        apiKey: config.apiKey,
        service: config.service,
        ddsource: config.source || 'nodejs',
        ddtags: config.tags || ''
      }
    };
  }
}
```

**Pinoæ—¥å¿—æ ¼å¼åŒ–å™¨**ï¼š
```typescript
/**
 * @class PinoLoggerFormatter
 * @description Pinoæ—¥å¿—æ ¼å¼åŒ–å™¨ï¼Œè‡ªå®šä¹‰æ—¥å¿—æ ¼å¼
 */
@Injectable()
export class PinoLoggerFormatter {
  formatError(error: Error): any {
    return {
      message: error.message,
      stack: error.stack,
      name: error.name,
      code: (error as any).code
    };
  }

  formatRequest(req: Request): any {
    return {
      method: req.method,
      url: req.url,
      headers: this.sanitizeHeaders(req.headers),
      query: req.query,
      body: this.sanitizeBody(req.body),
      ip: req.ip,
      userAgent: req.get('User-Agent')
    };
  }

  formatResponse(res: Response): any {
    return {
      statusCode: res.statusCode,
      headers: this.sanitizeHeaders(res.getHeaders()),
      contentLength: res.get('Content-Length')
    };
  }

  formatUserContext(user: any): any {
    return {
      userId: user?.id,
      email: user?.email,
      username: user?.username,
      tenantId: user?.tenantId,
      roles: user?.roles
    };
  }

  private sanitizeHeaders(headers: any): any {
    const sanitized = { ...headers };
    const sensitiveHeaders = ['authorization', 'cookie', 'x-api-key'];
    
    sensitiveHeaders.forEach(header => {
      if (sanitized[header]) {
        sanitized[header] = '[REDACTED]';
      }
    });
    
    return sanitized;
  }

  private sanitizeBody(body: any): any {
    if (!body) return body;
    
    const sanitized = { ...body };
    const sensitiveFields = ['password', 'token', 'secret', 'key'];
    
    sensitiveFields.forEach(field => {
      if (sanitized[field]) {
        sanitized[field] = '[REDACTED]';
      }
    });
    
    return sanitized;
  }
}
```

#### 4.9.3 Pinoæ—¥å¿—æ¨¡å—é…ç½®

**Pinoæ—¥å¿—æ¨¡å—**ï¼š
```typescript
/**
 * @class PinoLoggerModule
 * @description Pinoæ—¥å¿—æ¨¡å—é…ç½®
 */
@Module({
  imports: [ConfigModule],
  providers: [
    PinoLoggerService,
    PinoLoggerConfig,
    PinoLoggerTransport,
    PinoLoggerFormatter,
    {
      provide: 'PINO_LOGGER',
      useFactory: (config: PinoLoggerConfig) => {
        const pinoConfig = config.getConfig();
        return pino(pinoConfig);
      },
      inject: [PinoLoggerConfig]
    }
  ],
  exports: [
    PinoLoggerService,
    PinoLoggerConfig,
    PinoLoggerTransport,
    PinoLoggerFormatter
  ]
})
export class PinoLoggerModule {}
```

#### 4.9.4 æ—¥å¿—é…ç½®ç¤ºä¾‹

**å¼€å‘ç¯å¢ƒæ—¥å¿—é…ç½®**ï¼š
```yaml
# config/development.yaml
logging:
  level: debug
  name: iam-system-dev
  timestamp: true
  prettyPrint: true
  destination: console
  transport:
    type: pretty
    options:
      colorize: true
      translateTime: 'SYS:standard'
      ignore: 'pid,hostname'
  file:
    enabled: false
  elasticsearch:
    enabled: false
  datadog:
    enabled: false
```

**ç”Ÿäº§ç¯å¢ƒæ—¥å¿—é…ç½®**ï¼š
```yaml
# config/production.yaml
logging:
  level: info
  name: iam-system-prod
  timestamp: true
  prettyPrint: false
  destination: file
  transport:
    type: rotating-file
    file: /var/log/iam-system/app.log
    options:
      size: '10m'
      interval: '1d'
      compress: true
      maxFiles: 30
  file:
    enabled: true
    path: /var/log/iam-system
    maxSize: 10m
    maxFiles: 30
    compress: true
  elasticsearch:
    enabled: true
    node: ${ELASTICSEARCH_URL}
    index: iam-system-logs
    version: 7
    flushBytes: 1000
  datadog:
    enabled: true
    apiKey: ${DATADOG_API_KEY}
    service: iam-system
    source: nodejs
    tags: 'env:production,service:iam'
```

#### 4.9.5 æ—¥å¿—ç®¡ç†æµç¨‹

**æ—¥å¿—è®°å½•æµç¨‹**ï¼š
1. **æ—¥å¿—åˆå§‹åŒ–**
   - åŠ è½½æ—¥å¿—é…ç½®
   - åˆ›å»ºPinoæ—¥å¿—å®ä¾‹
   - é…ç½®ä¼ è¾“å™¨å’Œæ ¼å¼åŒ–å™¨
   - è®¾ç½®æ—¥å¿—çº§åˆ«å’Œè¾“å‡ºç›®æ ‡

2. **è¯·æ±‚æ—¥å¿—è®°å½•**
   - ç”Ÿæˆè¯·æ±‚ID
   - è®°å½•è¯·æ±‚å¼€å§‹ä¿¡æ¯
   - æ·»åŠ è¯·æ±‚ä¸Šä¸‹æ–‡ï¼ˆç§Ÿæˆ·IDã€ç”¨æˆ·IDç­‰ï¼‰
   - è®°å½•è¯·æ±‚å‚æ•°å’Œå¤´ä¿¡æ¯

3. **ä¸šåŠ¡æ—¥å¿—è®°å½•**
   - è®°å½•ä¸šåŠ¡æ“ä½œæ—¥å¿—
   - æ·»åŠ æ“ä½œç±»å‹å’Œè¯¦æƒ…
   - è®°å½•æ€§èƒ½æŒ‡æ ‡
   - è®°å½•å®‰å…¨äº‹ä»¶

4. **å“åº”æ—¥å¿—è®°å½•**
   - è®°å½•å“åº”çŠ¶æ€ç 
   - è®¡ç®—è¯·æ±‚å¤„ç†æ—¶é—´
   - è®°å½•å“åº”å¤§å°
   - è®°å½•é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœ‰ï¼‰

#### 6.11.2 æ—¥å¿—è¾“å‡ºæµç¨‹
1. **æ—¥å¿—æ ¼å¼åŒ–**
   - åº”ç”¨ç»“æ„åŒ–æ ¼å¼
   - æ·»åŠ æ—¶é—´æˆ³å’Œå…ƒæ•°æ®
   - è„±æ•æ•æ„Ÿä¿¡æ¯
   - ç»Ÿä¸€æ—¥å¿—æ ¼å¼

2. **æ—¥å¿—ä¼ è¾“**
   - æ ¹æ®ç¯å¢ƒé€‰æ‹©è¾“å‡ºæ–¹å¼
   - å¼€å‘ç¯å¢ƒï¼šæ§åˆ¶å°è¾“å‡º
   - ç”Ÿäº§ç¯å¢ƒï¼šæ–‡ä»¶æˆ–å¤–éƒ¨æœåŠ¡
   - æ”¯æŒå¤šç§ä¼ è¾“ç›®æ ‡

3. **æ—¥å¿—è½®è½¬**
   - ç›‘æ§æ—¥å¿—æ–‡ä»¶å¤§å°
   - è‡ªåŠ¨åˆ›å»ºæ–°æ—¥å¿—æ–‡ä»¶
   - å‹ç¼©å†å²æ—¥å¿—æ–‡ä»¶
   - æ¸…ç†è¿‡æœŸæ—¥å¿—æ–‡ä»¶

4. **æ—¥å¿—èšåˆ**
   - æ”¶é›†å¤šå®ä¾‹æ—¥å¿—
   - ç»Ÿä¸€æ—¥å¿—æ ¼å¼
   - å»ºç«‹æ—¥å¿—ç´¢å¼•
   - æ”¯æŒåˆ†å¸ƒå¼æŸ¥è¯¢

#### 6.11.3 æ—¥å¿—æŸ¥è¯¢æµç¨‹
1. **æ—¥å¿—æ”¶é›†**
   - ä»å¤šä¸ªæ¥æºæ”¶é›†æ—¥å¿—
   - ç»Ÿä¸€æ—¥å¿—æ ¼å¼å’Œç»“æ„
   - å»ºç«‹æ—¥å¿—ç´¢å¼•
   - æ”¯æŒå®æ—¶å’Œæ‰¹é‡æ”¶é›†

2. **æ—¥å¿—è¿‡æ»¤**
   - æŒ‰æ—¶é—´èŒƒå›´è¿‡æ»¤
   - æŒ‰æ—¥å¿—çº§åˆ«è¿‡æ»¤
   - æŒ‰ç§Ÿæˆ·IDè¿‡æ»¤
   - æŒ‰ç”¨æˆ·IDè¿‡æ»¤
   - æŒ‰æ“ä½œç±»å‹è¿‡æ»¤

3. **æ—¥å¿—æœç´¢**
   - å…¨æ–‡æœç´¢æ—¥å¿—å†…å®¹
   - ç»“æ„åŒ–å­—æ®µæœç´¢
   - æ”¯æŒå¤æ‚æŸ¥è¯¢æ¡ä»¶
   - é«˜æ€§èƒ½æœç´¢ä¼˜åŒ–

4. **æ—¥å¿—åˆ†æ**
   - ç»Ÿè®¡åˆ†ææ—¥å¿—æ•°æ®
   - è¯†åˆ«å¼‚å¸¸æ¨¡å¼
   - ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
   - å®‰å…¨äº‹ä»¶åˆ†æ

#### 6.11.4 æ—¥å¿—ç›‘æ§æµç¨‹
1. **æ—¥å¿—ç›‘æ§**
   - å®æ—¶ç›‘æ§æ—¥å¿—æµ
   - æ£€æµ‹å¼‚å¸¸æ¨¡å¼
   - ç›‘æ§ç³»ç»Ÿæ€§èƒ½
   - ç›‘æ§å®‰å…¨äº‹ä»¶

2. **å‘Šè­¦è§„åˆ™**
   - è®¾ç½®å‘Šè­¦é˜ˆå€¼
   - å®šä¹‰å‘Šè­¦è§„åˆ™
   - é…ç½®å‘Šè­¦çº§åˆ«
   - è®¾ç½®å‘Šè­¦é€šçŸ¥

3. **å‘Šè­¦è§¦å‘**
   - æ£€æµ‹å‘Šè­¦æ¡ä»¶
   - è§¦å‘å‘Šè­¦äº‹ä»¶
   - å‘é€å‘Šè­¦é€šçŸ¥
   - è®°å½•å‘Šè­¦å†å²

4. **å‘Šè­¦å¤„ç†**
   - ç¡®è®¤å‘Šè­¦äº‹ä»¶
   - åˆ†æå‘Šè­¦åŸå› 
   - æ‰§è¡Œå¤„ç†æªæ–½
   - å…³é—­å‘Šè­¦äº‹ä»¶