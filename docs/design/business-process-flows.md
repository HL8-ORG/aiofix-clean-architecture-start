# 业务流程文档

## 📋 文档信息

- **文档版本**: v1.0
- **创建日期**: 2024年12月
- **最后更新**: 2024年12月
- **文档状态**: 草稿
- **负责人**: 产品团队

---

## 🎯 文档目的

本文档详细描述了系统中各个核心业务流程，包括流程图、业务规则、异常处理等，帮助开发团队理解业务逻辑，确保系统实现符合业务需求。

---

## 🔄 核心业务流程

### 1. 租户申请与创建流程

#### 1.1 流程概述
租户申请与创建是系统的核心业务流程，确保租户创建的质量和合规性。

#### 1.2 流程图
```
开始
  ↓
用户提交租户申请
  ↓
系统验证申请信息
  ↓
[验证通过?]
  ↓ 是
申请进入待审核状态
  ↓
系统管理员查看申请
  ↓
系统管理员审核申请
  ↓
[审核通过?]
  ↓ 是
系统自动创建租户
  ↓
系统分配租户管理员
  ↓
系统初始化租户配置
  ↓
系统发送审核通过通知
  ↓
流程结束
  ↓ 否
系统发送审核拒绝通知
  ↓
流程结束
```

#### 1.3 详细步骤说明

**步骤1: 用户提交租户申请**
- **参与者**: 普通用户
- **输入**: 租户申请表单数据
- **处理**: 
  - 验证申请信息完整性
  - 检查租户代码唯一性
  - 检查申请人是否有未处理申请
- **输出**: 申请提交结果
- **业务规则**:
  - 申请人必须归属"默认系统租户"
  - 申请人不能有未处理的申请
  - 租户名称必须全局唯一
  - 租户代码必须全局唯一
  - 申请信息必须完整有效

**步骤2: 系统验证申请信息**
- **参与者**: 系统
- **输入**: 申请表单数据
- **处理**:
  - 验证租户名称格式（2-50字符）
  - 验证租户代码格式（3-20字符，仅允许字母数字下划线）
  - 验证申请人邮箱格式
  - 检查申请人是否归属"默认系统租户"
  - 检查租户名称是否已存在
  - 检查租户代码是否已存在
  - 检查申请人是否有未处理申请
- **输出**: 验证结果
- **异常处理**:
  - 验证失败：返回具体错误信息
  - 申请人不归属默认系统租户：提示用户只有默认系统租户用户才能申请
  - 申请人为租户管理员：提示租户管理员不能申请创建租户
  - 租户名称重复：提示用户修改
  - 租户代码重复：提示用户修改
  - 申请人有未处理申请：提示用户等待

**步骤3: 申请进入待审核状态**
- **参与者**: 系统
- **输入**: 验证通过的申请数据
- **处理**:
  - 创建租户申请记录
  - 设置申请状态为"待审核"
  - 记录申请提交时间
  - 生成申请ID
- **输出**: 申请记录
- **业务规则**:
  - 申请状态初始为"待审核"
  - 申请提交时间自动记录
  - 申请ID全局唯一

**步骤4: 系统管理员查看申请**
- **参与者**: 系统管理员
- **输入**: 待审核申请列表
- **处理**:
  - 获取所有待审核申请
  - 按提交时间排序
  - 显示申请基本信息
- **输出**: 申请列表
- **业务规则**:
  - 只有系统管理员可以查看待审核申请
  - 申请按提交时间倒序排列

**步骤5: 系统管理员审核申请**
- **参与者**: 系统管理员
- **输入**: 申请详情和审核决策
- **处理**:
  - 查看申请详细信息
  - 进行审核决策（通过/拒绝）
  - 填写审核意见（可选）
  - 记录审核人和审核时间
- **输出**: 审核结果
- **业务规则**:
  - 只有系统管理员可以审核申请
  - 审核操作必须记录审核人
  - 审核拒绝必须提供原因

**步骤6: 系统自动创建租户**
- **参与者**: 系统
- **输入**: 审核通过的申请数据
- **处理**:
  - 生成租户ID
  - 创建租户记录
  - 设置租户基本信息
  - 初始化租户配置
- **输出**: 租户记录
- **业务规则**:
  - 租户创建必须由系统自动完成
  - 租户ID全局唯一
  - 租户状态初始为"激活"

**步骤7: 系统分配租户管理员**
- **参与者**: 系统
- **输入**: 租户记录和申请人信息
- **处理**:
  - 将申请人设置为租户管理员
  - 分配租户管理权限
  - 记录管理员分配时间
- **输出**: 管理员分配结果
- **业务规则**:
  - 每个租户有且只能有一个管理员
  - 租户管理员默认为申请人
  - 管理员分配立即生效

**步骤8: 系统发送通知**
- **参与者**: 系统
- **输入**: 审核结果和用户信息
- **处理**:
  - 生成通知内容
  - 发送邮件通知
  - 记录通知发送时间
- **输出**: 通知发送结果
- **业务规则**:
  - 审核结果必须及时通知申请人
  - 通知内容包含审核结果和意见
  - 通知发送记录日志

#### 1.4 异常处理

**异常1: 申请信息验证失败**
- **触发条件**: 申请信息不符合要求
- **处理方式**: 返回具体错误信息，要求用户修改
- **恢复方式**: 用户修改后重新提交

**异常2: 申请人不归属默认系统租户**
- **触发条件**: 申请人不是默认系统租户用户
- **处理方式**: 提示用户只有默认系统租户用户才能申请创建租户，建议先申请退出当前租户
- **恢复方式**: 用户需要先申请退出当前租户

**异常2.1: 申请人为租户管理员**
- **触发条件**: 申请人是租户管理员
- **处理方式**: 提示租户管理员不能申请创建租户，需要先更换管理员
- **恢复方式**: 需要先更换租户管理员

**异常3: 租户名称重复**
- **触发条件**: 租户名称已存在
- **处理方式**: 提示用户选择其他租户名称
- **恢复方式**: 用户修改租户名称后重新提交

**异常4: 租户代码重复**
- **触发条件**: 租户代码已存在
- **处理方式**: 提示用户选择其他租户代码
- **恢复方式**: 用户修改租户代码后重新提交

**异常5: 申请人有未处理申请**
- **触发条件**: 申请人已有待处理申请
- **处理方式**: 提示用户等待现有申请处理完成
- **恢复方式**: 等待现有申请处理完成后再提交

**异常6: 审核拒绝**
- **触发条件**: 系统管理员拒绝申请
- **处理方式**: 发送拒绝通知，说明拒绝原因
- **恢复方式**: 用户根据反馈修改后重新申请

### 2. 用户注册与激活流程

#### 3.1 流程概述
用户注册与激活流程确保新用户能够安全地创建账号并开始使用系统。新用户默认归属默认系统租户的默认组织，支持多组织归属。

#### 3.2 流程图
```
开始
  ↓
用户填写注册表单
  ↓
系统验证注册信息
  ↓
[验证通过?]
  ↓ 是
创建用户账号
  ↓
设置用户状态为待激活
  ↓
分配默认系统租户和默认组织
  ↓
发送激活邮件
  ↓
用户点击激活链接
  ↓
系统验证激活链接
  ↓
[验证通过?]
  ↓ 是
激活用户账号
  ↓
设置用户状态为激活
  ↓
用户获得默认组织基础权限
  ↓
用户登录系统
  ↓
流程结束
```

#### 2.3 详细步骤说明

**步骤1: 用户填写注册表单**
- **参与者**: 新用户
- **输入**: 用户注册信息
- **处理**: 用户填写邮箱、密码、姓名等信息
- **输出**: 注册表单数据
- **业务规则**:
  - 邮箱地址必须全局唯一
  - 密码必须符合安全要求
  - 姓名必须真实有效

**步骤2: 系统验证注册信息**
- **参与者**: 系统
- **输入**: 注册表单数据
- **处理**:
  - 验证邮箱格式
  - 检查邮箱是否已注册
  - 验证密码强度
  - 验证姓名格式
- **输出**: 验证结果
- **异常处理**:
  - 邮箱格式错误：提示用户修改
  - 邮箱已注册：提示用户使用其他邮箱
  - 密码强度不足：提示用户设置更强密码

**步骤3: 创建用户账号**
- **参与者**: 系统
- **输入**: 验证通过的注册数据
- **处理**:
  - 生成用户ID
  - 创建用户记录
  - 加密存储密码
  - 设置用户状态为"待激活"
  - 分配用户归属默认系统租户
  - 分配用户归属默认系统租户的默认组织
- **输出**: 用户记录
- **业务规则**:
  - 用户ID全局唯一
  - 密码必须加密存储
  - 用户状态初始为"待激活"
  - 新用户默认归属默认系统租户
  - 新用户默认归属默认系统租户的默认组织

**步骤4: 发送激活邮件**
- **参与者**: 系统
- **输入**: 用户邮箱和激活链接
- **处理**:
  - 生成激活链接
  - 发送激活邮件
  - 记录邮件发送时间
- **输出**: 邮件发送结果
- **业务规则**:
  - 激活链接有效期24小时
  - 激活链接包含安全令牌
  - 邮件发送记录日志

**步骤5: 用户点击激活链接**
- **参与者**: 用户
- **输入**: 激活链接
- **处理**: 用户点击邮件中的激活链接
- **输出**: 激活请求
- **业务规则**:
  - 激活链接只能使用一次
  - 激活链接有时效性

**步骤6: 系统验证激活链接**
- **参与者**: 系统
- **输入**: 激活链接
- **处理**:
  - 解析激活链接
  - 验证安全令牌
  - 检查链接有效期
  - 检查用户状态
- **输出**: 验证结果
- **异常处理**:
  - 链接无效：提示用户重新申请激活
  - 链接过期：提示用户重新申请激活
  - 用户已激活：提示用户直接登录

**步骤7: 激活用户账号**
- **参与者**: 系统
- **输入**: 验证通过的激活请求
- **处理**:
  - 更新用户状态为"激活"
  - 记录激活时间
  - 清除激活链接
  - 分配用户所属组织的基础权限
- **输出**: 激活结果
- **业务规则**:
  - 激活后用户状态变为"激活"
  - 激活时间自动记录
  - 激活操作记录日志
  - 激活后用户获得所属组织的基础权限

### 3. 用户角色管理流程

#### 3.1 流程概述
用户角色管理流程确保用户权限的正确分配和管理。

#### 3.2 流程图
```
开始
  ↓
管理员查看用户列表
  ↓
管理员选择用户和角色
  ↓
系统验证角色分配
  ↓
[验证通过?]
  ↓ 是
分配角色给用户
  ↓
更新用户权限
  ↓
记录操作日志
  ↓
通知用户角色变更
  ↓
流程结束
```

#### 3.3 详细步骤说明

**步骤1: 管理员查看用户列表**
- **参与者**: 租户管理员/系统管理员
- **输入**: 用户查询条件
- **处理**:
  - 获取用户列表
  - 显示用户基本信息
  - 显示用户当前角色
- **输出**: 用户列表
- **业务规则**:
  - 租户管理员只能查看本租户用户
  - 系统管理员可以查看所有用户

**步骤2: 管理员选择用户和角色**
- **参与者**: 租户管理员/系统管理员
- **输入**: 用户ID和角色ID
- **处理**:
  - 选择要管理的用户
  - 选择要分配的角色
  - 确认操作
- **输出**: 角色分配请求
- **业务规则**:
  - 租户管理员不能管理其他租户用户
  - 系统管理员可以管理所有用户

**步骤3: 系统验证角色分配**
- **参与者**: 系统
- **输入**: 角色分配请求
- **处理**:
  - 验证用户存在性
  - 验证角色存在性
  - 验证分配权限
  - 检查角色冲突
- **输出**: 验证结果
- **异常处理**:
  - 用户不存在：返回错误信息
  - 角色不存在：返回错误信息
  - 权限不足：返回错误信息

**步骤4: 分配角色给用户**
- **参与者**: 系统
- **输入**: 验证通过的角色分配请求
- **处理**:
  - 创建用户角色关联
  - 更新用户权限
  - 记录分配时间
- **输出**: 角色分配结果
- **业务规则**:
  - 用户可以有多个角色
  - 角色分配立即生效
  - 分配时间自动记录

**步骤5: 更新用户权限**
- **参与者**: 系统
- **输入**: 用户角色信息
- **处理**:
  - 计算用户总权限
  - 更新权限缓存
  - 通知相关系统
- **输出**: 权限更新结果
- **业务规则**:
  - 权限基于角色计算
  - 权限变更立即生效
  - 权限缓存及时更新

**步骤6: 记录操作日志**
- **参与者**: 系统
- **输入**: 角色分配操作信息
- **处理**:
  - 记录操作类型
  - 记录操作人
  - 记录操作时间
  - 记录操作详情
- **输出**: 操作日志
- **业务规则**:
  - 所有角色操作必须记录日志
  - 日志包含完整的操作信息
  - 日志不可修改

**步骤7: 通知用户角色变更**
- **参与者**: 系统
- **输入**: 角色变更信息
- **处理**:
  - 生成通知内容
  - 发送通知给用户
  - 记录通知发送时间
- **输出**: 通知发送结果
- **业务规则**:
  - 角色变更必须通知用户
  - 通知包含变更详情
  - 通知发送记录日志

### 4. 组织管理流程

#### 4.1 组织创建流程
**流程概述**: 租户管理员创建新的组织，建立组织架构。

**流程图**:
```
开始
  ↓
租户管理员填写组织信息
  ↓
系统验证组织信息
  ↓
[验证通过?]
  ↓ 是
创建组织记录
  ↓
设置组织权限
  ↓
记录操作日志
  ↓
通知相关人员
  ↓
流程结束
```

**详细步骤说明**:

**步骤1: 租户管理员填写组织信息**
- **参与者**: 租户管理员
- **输入**: 组织创建表单数据
- **处理**: 
  - 填写组织名称、代码、描述等信息
  - 选择父组织（可选）
  - 设置组织负责人（可选）
- **输出**: 组织创建申请
- **业务规则**:
  - 组织名称在租户内必须唯一
  - 组织代码在租户内必须唯一
  - 父组织必须属于同一租户
  - 组织负责人必须是该租户的用户

**步骤2: 系统验证组织信息**
- **参与者**: 系统
- **输入**: 组织创建表单数据
- **处理**:
  - 验证组织名称格式（2-50字符）
  - 验证组织代码格式（3-20字符，字母数字下划线）
  - 检查组织名称在租户内唯一性
  - 检查组织代码在租户内唯一性
  - 验证父组织存在性（如果指定）
  - 验证组织负责人有效性（如果指定）
- **输出**: 验证结果
- **异常处理**:
  - 验证失败：返回具体错误信息
  - 组织名称重复：提示管理员选择其他名称
  - 组织代码重复：提示管理员选择其他代码
  - 父组织不存在：提示管理员选择有效父组织

**步骤3: 创建组织记录**
- **参与者**: 系统
- **输入**: 验证通过的组织数据
- **处理**:
  - 生成组织ID
  - 创建组织记录
  - 设置组织基本信息
  - 建立父子关系（如果指定父组织）
  - 设置组织状态为激活
- **输出**: 组织记录
- **业务规则**:
  - 组织ID全局唯一
  - 组织状态初始为激活
  - 组织创建时间自动记录
  - 组织层级关系正确建立

**步骤4: 设置组织权限**
- **参与者**: 系统
- **输入**: 组织记录
- **处理**:
  - 继承父组织权限（如果有父组织）
  - 设置组织特定权限
  - 初始化组织数据隔离配置
- **输出**: 权限配置结果
- **业务规则**:
  - 子组织默认继承父组织权限
  - 组织可以设置特定权限规则
  - 组织数据隔离默认启用

**步骤5: 记录操作日志**
- **参与者**: 系统
- **输入**: 组织创建操作信息
- **处理**:
  - 记录操作类型（组织创建）
  - 记录操作人（租户管理员）
  - 记录操作时间
  - 记录组织创建详情
- **输出**: 操作日志
- **业务规则**:
  - 组织创建必须记录详细日志
  - 日志包含完整的组织信息
  - 日志不可修改

#### 4.2 组织用户管理流程
**流程概述**: 租户管理员管理用户与组织的归属关系，支持多组织归属。

**流程图**:
```
开始
  ↓
租户管理员选择用户和组织
  ↓
系统验证用户组织分配
  ↓
[验证通过?]
  ↓ 是
更新用户组织归属
  ↓
重新计算用户权限
  ↓
记录操作日志
  ↓
通知用户组织变更
  ↓
流程结束
```

**详细步骤说明**:

**步骤1: 租户管理员选择用户和组织**
- **参与者**: 租户管理员
- **输入**: 用户ID和组织ID列表
- **处理**: 
  - 选择要管理的用户
  - 选择用户要归属的组织（支持多选）
  - 设置用户的主要组织（可选）
  - 设置用户在组织中的角色（可选）
- **输出**: 用户组织分配请求
- **业务规则**:
  - 用户必须至少归属一个组织
  - 用户可以同时归属多个组织
  - 主要组织必须从归属组织中选择
  - 用户在不同组织中可以有不同的角色

**步骤2: 系统验证用户组织分配**
- **参与者**: 系统
- **输入**: 用户组织分配请求
- **处理**:
  - 验证用户存在性和状态
  - 验证组织存在性和状态
  - 验证用户和组织属于同一租户
  - 检查组织分配的有效性
  - 验证主要组织设置的有效性
- **输出**: 验证结果
- **异常处理**:
  - 用户不存在：返回错误信息
  - 组织不存在：返回错误信息
  - 用户组织不属于同一租户：返回错误信息
  - 用户不能从最后一个组织中移除：提示至少保留一个组织

**步骤3: 更新用户组织归属**
- **参与者**: 系统
- **输入**: 验证通过的用户组织分配请求
- **处理**:
  - 更新用户组织归属关系
  - 设置用户主要组织
  - 设置用户在组织中的角色
  - 记录组织变更时间
- **输出**: 组织归属更新结果
- **业务规则**:
  - 用户组织归属变更必须原子性执行
  - 用户必须至少保留一个组织归属
  - 主要组织变更立即生效
  - 组织角色设置立即生效

**步骤4: 重新计算用户权限**
- **参与者**: 系统
- **输入**: 用户组织归属信息
- **处理**:
  - 计算用户在所有组织中的权限
  - 合并用户角色权限和组织权限
  - 更新用户权限缓存
  - 通知相关系统权限变更
- **输出**: 权限计算结果
- **业务规则**:
  - 用户权限 = 角色权限 + 所有组织权限的并集
  - 权限冲突时采用最高权限原则
  - 权限变更立即生效
  - 权限缓存及时更新

**步骤5: 记录操作日志**
- **参与者**: 系统
- **输入**: 用户组织变更操作信息
- **处理**:
  - 记录操作类型（用户组织变更）
  - 记录操作人（租户管理员）
  - 记录操作时间
  - 记录变更详情（原组织、新组织、变更原因）
- **输出**: 操作日志
- **业务规则**:
  - 用户组织变更必须记录详细日志
  - 日志包含完整的变更信息
  - 日志不可修改

**步骤6: 通知用户组织变更**
- **参与者**: 系统
- **输入**: 组织变更结果和用户信息
- **处理**:
  - 生成通知内容
  - 发送通知给用户
  - 记录通知发送时间
- **输出**: 通知发送结果
- **业务规则**:
  - 组织变更必须通知用户
  - 通知包含变更详情和影响
  - 通知发送记录日志

#### 4.3 组织权限管理流程
**流程概述**: 租户管理员管理组织的权限配置，支持权限继承和覆盖。

**流程图**:
```
开始
  ↓
租户管理员选择组织和权限
  ↓
系统验证权限配置
  ↓
[验证通过?]
  ↓ 是
更新组织权限
  ↓
继承子组织权限
  ↓
重新计算相关用户权限
  ↓
记录操作日志
  ↓
通知相关人员
  ↓
流程结束
```

**详细步骤说明**:

**步骤1: 租户管理员选择组织和权限**
- **参与者**: 租户管理员
- **输入**: 组织ID和权限配置
- **处理**: 
  - 选择要配置权限的组织
  - 设置组织数据访问权限
  - 设置组织功能操作权限
  - 设置组织用户管理权限
  - 设置组织系统配置权限
- **输出**: 组织权限配置请求
- **业务规则**:
  - 只有租户管理员可以配置组织权限
  - 权限配置支持细粒度控制
  - 权限配置可以覆盖父组织权限

**步骤2: 系统验证权限配置**
- **参与者**: 系统
- **输入**: 组织权限配置请求
- **处理**:
  - 验证组织存在性和状态
  - 验证权限配置的有效性
  - 检查权限冲突
  - 验证权限继承关系
- **输出**: 验证结果
- **异常处理**:
  - 组织不存在：返回错误信息
  - 权限配置无效：返回错误信息
  - 权限冲突：提示管理员调整配置

**步骤3: 更新组织权限**
- **参与者**: 系统
- **输入**: 验证通过的组织权限配置请求
- **处理**:
  - 更新组织权限配置
  - 设置权限继承规则
  - 记录权限变更时间
- **输出**: 权限更新结果
- **业务规则**:
  - 组织权限更新必须原子性执行
  - 权限变更立即生效
  - 权限继承规则正确应用

**步骤4: 继承子组织权限**
- **参与者**: 系统
- **输入**: 组织权限变更信息
- **处理**:
  - 识别所有子组织
  - 更新子组织权限继承
  - 处理权限覆盖情况
  - 记录权限继承变更
- **输出**: 权限继承结果
- **业务规则**:
  - 子组织默认继承父组织权限
  - 子组织可以覆盖父组织权限
  - 权限继承支持多层级传递
  - 权限变更时自动更新子组织权限

**步骤5: 重新计算相关用户权限**
- **参与者**: 系统
- **输入**: 组织权限变更信息
- **处理**:
  - 识别受影响的用户
  - 重新计算用户权限
  - 更新用户权限缓存
  - 通知相关系统权限变更
- **输出**: 用户权限更新结果
- **业务规则**:
  - 组织权限变更影响所有归属用户
  - 用户权限重新计算必须及时
  - 权限变更通知必须及时

#### 4.4 组织数据隔离流程
**流程概述**: 系统根据组织权限配置实现数据隔离，确保用户只能访问有权限的数据。

**流程图**:
```
开始
  ↓
用户发起数据访问请求
  ↓
系统获取用户组织归属
  ↓
系统获取组织权限配置
  ↓
系统计算用户数据访问范围
  ↓
系统验证访问权限
  ↓
[权限验证通过?]
  ↓ 是
返回数据访问结果
  ↓
记录数据访问日志
  ↓
流程结束
```

**详细步骤说明**:

**步骤1: 用户发起数据访问请求**
- **参与者**: 用户
- **输入**: 数据访问请求
- **处理**: 
  - 用户请求访问特定数据
  - 系统接收访问请求
  - 验证用户身份
- **输出**: 数据访问请求
- **业务规则**:
  - 用户必须已登录
  - 访问请求包含目标数据标识
  - 系统记录访问请求

**步骤2: 系统获取用户组织归属**
- **参与者**: 系统
- **输入**: 用户ID
- **处理**:
  - 查询用户归属的所有组织
  - 获取用户在各组织中的角色
  - 识别用户的主要组织
- **输出**: 用户组织归属信息
- **业务规则**:
  - 用户必须至少归属一个组织
  - 支持用户多组织归属
  - 组织归属信息实时获取

**步骤3: 系统获取组织权限配置**
- **参与者**: 系统
- **输入**: 用户组织归属信息
- **处理**:
  - 获取各组织的权限配置
  - 获取组织权限继承关系
  - 计算组织实际权限
- **输出**: 组织权限配置信息
- **业务规则**:
  - 组织权限配置实时获取
  - 权限继承关系正确计算
  - 权限覆盖规则正确应用

**步骤4: 系统计算用户数据访问范围**
- **参与者**: 系统
- **输入**: 用户组织归属和权限配置
- **处理**:
  - 计算用户在所有组织中的权限
  - 合并用户角色权限和组织权限
  - 确定用户数据访问范围
- **输出**: 用户数据访问范围
- **业务规则**:
  - 用户权限 = 角色权限 + 所有组织权限的并集
  - 数据访问范围 = 所有归属组织数据范围的并集
  - 权限冲突时采用最高权限原则

**步骤5: 系统验证访问权限**
- **参与者**: 系统
- **输入**: 数据访问请求和用户访问范围
- **处理**:
  - 检查目标数据是否在用户访问范围内
  - 验证用户是否有相应的操作权限
  - 检查数据访问限制
- **输出**: 权限验证结果
- **异常处理**:
  - 数据不在访问范围内：拒绝访问
  - 权限不足：拒绝访问
  - 访问受限：拒绝访问

**步骤6: 返回数据访问结果**
- **参与者**: 系统
- **输入**: 权限验证通过的数据访问请求
- **处理**:
  - 执行数据访问操作
  - 过滤用户无权限的数据
  - 返回访问结果
- **输出**: 数据访问结果
- **业务规则**:
  - 只返回用户有权限的数据
  - 数据访问结果正确
  - 访问性能符合要求

**步骤7: 记录数据访问日志**
- **参与者**: 系统
- **输入**: 数据访问操作信息
- **处理**:
  - 记录访问时间
  - 记录访问用户
  - 记录访问数据
  - 记录访问结果
- **输出**: 访问日志
- **业务规则**:
  - 所有数据访问都必须记录日志
  - 日志包含完整的访问信息
  - 异常访问必须告警

### 4. 用户租户变更流程

#### 4.1 流程概述
用户租户变更流程分为两个独立流程：退出租户流程和加入租户流程。用户必须先退出当前租户返回默认系统租户，然后才能申请加入其他租户，确保数据隔离和权限控制。

#### 4.2 退出租户流程图
```
开始
  ↓
用户提交退出租户申请
  ↓
系统验证申请信息
  ↓
[验证通过?]
  ↓ 是
申请进入待审核状态
  ↓
原租户管理员审核申请
  ↓
[审核通过?]
  ↓ 是
系统执行租户退出
  ↓
更新用户租户归属为默认系统租户
  ↓
清除原租户权限
  ↓
分配默认系统租户权限
  ↓
记录变更历史
  ↓
通知相关人员
  ↓
流程结束
```

#### 4.3 加入租户流程图
```
开始
  ↓
默认系统租户用户提交加入申请
  ↓
系统验证申请信息
  ↓
[验证通过?]
  ↓ 是
申请进入待审核状态
  ↓
目标租户管理员审核申请
  ↓
[审核通过?]
  ↓ 是
系统执行租户加入
  ↓
更新用户租户归属为目标租户
  ↓
分配目标租户权限
  ↓
记录变更历史
  ↓
通知相关人员
  ↓
流程结束
```

#### 4.4 退出租户详细步骤说明

**步骤1: 用户提交退出租户申请**
- **参与者**: 普通用户
- **输入**: 退出租户申请表单数据
- **处理**: 
  - 验证申请信息完整性
  - 检查用户是否有未处理申请
  - 检查用户当前租户状态
  - 检查用户是否为租户管理员
- **输出**: 申请提交结果
- **业务规则**:
  - 用户只能归属一个租户
  - 用户不能有未处理的变更申请
  - 租户管理员不能申请退出租户
  - 退出申请自动设置目标为默认系统租户

**步骤2: 系统验证申请信息**
- **参与者**: 系统
- **输入**: 申请表单数据
- **处理**:
  - 验证目标租户ID有效性
  - 验证申请原因格式
  - 检查用户当前状态
  - 检查目标租户状态
- **输出**: 验证结果
- **异常处理**:
  - 验证失败：返回具体错误信息
  - 目标租户不存在：提示用户选择其他租户
  - 用户状态异常：提示用户联系管理员

**步骤3: 申请进入待审核状态**
- **参与者**: 系统
- **输入**: 验证通过的申请数据
- **处理**:
  - 创建租户变更申请记录
  - 设置申请状态为"待审核"
  - 记录申请提交时间
  - 生成申请ID
- **输出**: 申请记录
- **业务规则**:
  - 申请状态初始为"待审核"
  - 申请提交时间自动记录
  - 申请ID全局唯一

**步骤4: 租户管理员审核申请**
- **参与者**: 目标租户管理员（加入时）/ 原租户管理员（退出时）
- **输入**: 租户加入/退出申请详情
- **处理**:
  - 查看申请详细信息
  - 进行审核决策（通过/拒绝）
  - 填写审核意见（可选）
  - 记录审核人和审核时间
- **输出**: 审核结果
- **业务规则**:
  - 租户加入：只有目标租户管理员可以审核
  - 租户退出：只有原租户管理员可以审核
  - 审核通过后系统自动执行变更
  - 审核操作必须记录审核人
  - 审核拒绝必须提供原因

**步骤5: 系统执行租户变更**
- **参与者**: 系统
- **输入**: 审核通过的申请数据
- **处理**:
  - 根据申请类型执行相应操作
  - 更新用户租户归属
  - 调整用户权限
  - 记录变更时间
- **输出**: 变更结果
- **业务规则**:
  - 租户退出：用户归属默认系统租户，失去原租户权限
  - 租户加入：用户归属目标租户，获得目标租户权限
  - 变更必须原子性执行

**步骤6: 记录变更历史**
- **参与者**: 系统
- **输入**: 变更操作信息
- **处理**:
  - 更新用户租户归属
  - 清除原租户权限
  - 根据申请类型分配权限
- **输出**: 变更结果
- **业务规则**:
  - 租户变更必须原子性执行
  - 变更后用户失去原租户所有权限
  - 租户变更：用户获得新租户基础权限
  - 租户退出：用户获得默认系统租户基础权限

**步骤7: 记录变更历史**
- **参与者**: 系统
- **输入**: 变更操作信息
- **处理**:
  - 创建变更记录
  - 记录原租户和目标租户
  - 记录变更时间和原因
  - 记录操作人员信息
- **输出**: 变更记录
- **业务规则**:
  - 每次变更都必须记录
  - 变更记录不可删除
  - 变更记录用于审计

**步骤8: 通知相关人员**
- **参与者**: 系统
- **输入**: 变更结果和用户信息
- **处理**:
  - 通知申请人变更结果
  - 通知原租户管理员
  - 记录通知发送时间
- **输出**: 通知发送结果
- **业务规则**:
  - 变更结果必须及时通知
  - 通知内容包含变更详情
  - 通知发送记录日志

#### 4.5 加入租户详细步骤说明

**步骤1: 用户提交加入租户申请**
- **参与者**: 默认系统租户用户
- **输入**: 加入租户申请表单数据
- **处理**: 
  - 验证申请信息完整性
  - 检查用户是否归属默认系统租户
  - 检查目标租户是否存在且状态正常
  - 检查用户是否有未处理申请
  - 检查用户是否为租户管理员
- **输出**: 申请提交结果
- **业务规则**:
  - 只有默认系统租户用户才能申请加入其他租户
  - 租户管理员不能申请加入其他租户
  - 用户不能有未处理的变更申请
  - 目标租户必须存在且状态正常

**步骤2: 系统验证申请信息**
- **参与者**: 系统
- **输入**: 申请表单数据
- **处理**:
  - 验证目标租户ID有效性
  - 验证申请原因格式
  - 检查用户当前状态
  - 检查目标租户状态
- **输出**: 验证结果
- **异常处理**:
  - 验证失败：返回具体错误信息
  - 目标租户不存在：提示用户选择其他租户
  - 用户状态异常：提示用户联系管理员

**步骤3: 申请进入待审核状态**
- **参与者**: 系统
- **输入**: 验证通过的申请数据
- **处理**:
  - 创建租户加入申请记录
  - 设置申请状态为"待审核"
  - 记录申请提交时间
  - 生成申请ID
- **输出**: 申请记录
- **业务规则**:
  - 申请状态初始为"待审核"
  - 申请提交时间自动记录
  - 申请ID全局唯一

**步骤4: 目标租户管理员审核申请**
- **参与者**: 目标租户管理员
- **输入**: 租户加入申请详情
- **处理**:
  - 查看申请详细信息
  - 进行审核决策（通过/拒绝）
  - 填写审核意见（可选）
  - 记录审核人和审核时间
- **输出**: 审核结果
- **业务规则**:
  - 只有目标租户管理员可以审核
  - 审核操作必须记录审核人
  - 审核拒绝必须提供原因

**步骤5: 系统管理员最终审批**
- **参与者**: 系统管理员
- **输入**: 审核通过的申请
- **处理**:
  - 查看申请详细信息
  - 进行最终审批决策
  - 填写审批意见（可选）
  - 记录审批人和审批时间
- **输出**: 审批结果
- **业务规则**:
  - 只有系统管理员可以最终审批
  - 审批操作必须记录审批人
  - 审批拒绝必须提供原因

**步骤6: 系统执行租户加入**
- **参与者**: 系统
- **输入**: 审批通过的申请数据
- **处理**:
  - 更新用户租户归属为目标租户
  - 分配目标租户权限
  - 记录变更时间
- **输出**: 变更结果
- **业务规则**:
  - 租户加入必须原子性执行
  - 加入后用户获得目标租户基础权限

**步骤7: 记录变更历史**
- **参与者**: 系统
- **输入**: 变更操作信息
- **处理**:
  - 创建变更记录
  - 记录原租户（默认系统租户）和目标租户
  - 记录变更时间和原因
  - 记录操作人员信息
- **输出**: 变更记录
- **业务规则**:
  - 每次变更都必须记录
  - 变更记录不可删除
  - 变更记录用于审计

**步骤8: 通知相关人员**
- **参与者**: 系统
- **输入**: 变更结果和用户信息
- **处理**:
  - 通知申请人变更结果
  - 通知目标租户管理员
  - 记录通知发送时间
- **输出**: 通知发送结果
- **业务规则**:
  - 变更结果必须及时通知
  - 通知内容包含变更详情
  - 通知发送记录日志

#### 4.6 异常处理

**异常1: 申请信息验证失败**
- **触发条件**: 申请信息不符合要求
- **处理方式**: 返回具体错误信息，要求用户修改
- **恢复方式**: 用户修改后重新提交

**异常2: 目标租户不存在**
- **触发条件**: 目标租户ID无效
- **处理方式**: 提示用户选择其他租户
- **恢复方式**: 用户选择有效租户后重新提交

**异常3: 用户有未处理申请**
- **触发条件**: 用户已有待处理申请
- **处理方式**: 提示用户等待现有申请处理完成
- **恢复方式**: 等待现有申请处理完成后再提交

**异常4: 审核拒绝**
- **触发条件**: 目标租户管理员拒绝申请
- **处理方式**: 发送拒绝通知，说明拒绝原因
- **恢复方式**: 用户根据反馈修改后重新申请

**异常5: 审批拒绝**
- **触发条件**: 系统管理员拒绝申请
- **处理方式**: 发送拒绝通知，说明拒绝原因
- **恢复方式**: 用户根据反馈修改后重新申请

### 4. 租户管理员更换申请流程

#### 4.1 流程概述
租户管理员更换申请流程确保租户管理员不能自行变更，必须通过系统管理员审核和执行更换操作。

#### 4.2 流程图
```
开始
  ↓
租户管理员提交更换申请
  ↓
系统验证申请信息
  ↓
[验证通过?]
  ↓ 是
系统管理员审核申请
  ↓
[审核通过?]
  ↓ 是
系统执行管理员更换
  ↓
原管理员降级为普通用户
  ↓
新管理员获得管理权限
  ↓
记录操作日志
  ↓
通知相关用户
  ↓
流程结束
```

#### 4.3 详细步骤说明

**步骤1: 租户管理员提交更换申请**
- **参与者**: 租户管理员
- **输入**: 更换申请表单数据
- **处理**: 
  - 验证申请信息完整性
  - 检查新管理员候选人的有效性
  - 检查新管理员候选人是否属于该租户
- **输出**: 申请提交结果
- **业务规则**:
  - 申请必须指定新的管理员候选人
  - 新管理员候选人必须是该租户的现有用户
  - 申请需要说明更换原因

**步骤2: 系统验证申请信息**
- **参与者**: 系统
- **输入**: 更换申请数据
- **处理**: 
  - 验证申请信息完整性
  - 检查新管理员候选人的状态
  - 检查新管理员候选人是否属于该租户
- **输出**: 验证结果
- **业务规则**:
  - 新管理员候选人状态必须正常
  - 新管理员候选人必须属于该租户
  - 申请信息必须完整

**步骤3: 系统管理员审核申请**
- **参与者**: 系统管理员
- **输入**: 待审核的更换申请
- **处理**: 
  - 查看申请详情和更换原因
  - 评估更换的必要性
  - 决定通过或拒绝
- **输出**: 审核结果
- **业务规则**:
  - 只有系统管理员可以审核
  - 审核通过后系统自动执行更换
  - 审核拒绝需要说明原因

**步骤4: 系统执行管理员更换**
- **参与者**: 系统
- **输入**: 审核通过的申请
- **处理**: 
  - 原管理员降级为普通用户
  - 新管理员获得租户管理权限
  - 更新租户管理员信息
- **输出**: 更换结果
- **业务规则**:
  - 更换后原管理员失去管理权限
  - 更换后新管理员获得管理权限
  - 更换操作必须记录日志

#### 4.4 异常处理

**异常1: 新管理员候选人不属于该租户**
- **触发条件**: 新管理员候选人不是该租户的用户
- **处理方式**: 拒绝申请，提示候选人必须属于该租户
- **恢复方式**: 租户管理员选择该租户内的其他用户

**异常2: 新管理员候选人状态异常**
- **触发条件**: 新管理员候选人账号状态不是激活状态
- **处理方式**: 拒绝申请，提示候选人状态异常
- **恢复方式**: 租户管理员选择状态正常的用户

**异常3: 申请信息不完整**
- **触发条件**: 申请缺少必要信息
- **处理方式**: 要求补充完整信息
- **恢复方式**: 租户管理员补充信息后重新提交

**异常4: 审核拒绝**
- **触发条件**: 系统管理员拒绝申请
- **处理方式**: 发送拒绝通知，说明拒绝原因
- **恢复方式**: 租户管理员根据反馈修改后重新申请

### 5. 租户域名变更申请流程

#### 5.1 流程概述
租户域名变更申请流程确保租户域名由系统管理员统一管理，租户管理员不能自行变更域名。

#### 5.2 流程图
```
开始
  ↓
租户管理员提交域名变更申请
  ↓
系统验证新域名格式
  ↓
[格式正确?]
  ↓ 是
系统检查域名唯一性
  ↓
[域名唯一?]
  ↓ 是
系统管理员审核申请
  ↓
[审核通过?]
  ↓ 是
系统执行域名变更
  ↓
更新租户域名
  ↓
记录操作日志
  ↓
通知相关用户
  ↓
流程结束
```

#### 5.3 详细步骤说明

**步骤1: 租户管理员提交域名变更申请**
- **参与者**: 租户管理员
- **输入**: 域名变更申请表单数据
- **处理**: 
  - 验证申请信息完整性
  - 检查新域名格式
  - 检查新域名唯一性
- **输出**: 申请提交结果
- **业务规则**:
  - 申请必须指定新的域名
  - 申请需要说明变更原因
  - 新域名必须符合格式规范

**步骤2: 系统验证新域名格式**
- **参与者**: 系统
- **输入**: 新的域名
- **处理**: 
  - 验证域名长度（3-63字符）
  - 验证域名字符（字母、数字、连字符）
  - 验证域名格式（不以连字符开头或结尾）
- **输出**: 验证结果
- **业务规则**:
  - 域名长度必须在3-63个字符之间
  - 只能包含字母、数字、连字符
  - 不能以连字符开头或结尾
  - 不能包含连续连字符

**步骤3: 系统检查域名唯一性**
- **参与者**: 系统
- **输入**: 新的域名
- **处理**: 
  - 检查域名是否与其他租户重复
  - 检查域名是否与申请中的域名重复
- **输出**: 唯一性检查结果
- **业务规则**:
  - 域名必须全局唯一
  - 不能与其他租户域名重复
  - 不能与申请中的域名重复

**步骤4: 系统管理员审核申请**
- **参与者**: 系统管理员
- **输入**: 待审核的域名变更申请
- **处理**: 
  - 查看申请详情和变更原因
  - 评估域名变更的必要性
  - 决定通过或拒绝
- **输出**: 审核结果
- **业务规则**:
  - 只有系统管理员可以审核
  - 审核通过后系统自动执行变更
  - 审核拒绝需要说明原因

**步骤5: 系统执行域名变更**
- **参与者**: 系统
- **输入**: 审核通过的申请
- **处理**: 
  - 更新租户域名
  - 记录域名变更时间
  - 记录操作人员信息
- **输出**: 域名变更结果
- **业务规则**:
  - 域名变更必须原子性执行
  - 域名变更不影响其他配置
  - 变更操作必须记录日志

#### 5.4 异常处理

**异常1: 新域名格式不符合规范**
- **触发条件**: 新域名不符合格式要求
- **处理方式**: 拒绝申请，提示域名格式错误
- **恢复方式**: 租户管理员修改域名格式后重新提交

**异常2: 新域名已被其他租户使用**
- **触发条件**: 新域名与其他租户域名重复
- **处理方式**: 拒绝申请，提示域名已被使用
- **恢复方式**: 租户管理员选择其他域名

**异常3: 申请信息不完整**
- **触发条件**: 申请缺少必要信息
- **处理方式**: 要求补充完整信息
- **恢复方式**: 租户管理员补充信息后重新提交

**异常4: 审核拒绝**
- **触发条件**: 系统管理员拒绝申请
- **处理方式**: 发送拒绝通知，说明拒绝原因
- **恢复方式**: 租户管理员根据反馈修改后重新申请

### 6. 用户个人信息管理流程

#### 6.1 流程概述
用户个人信息管理流程确保用户能够安全地查看和编辑自己的个人信息，同时保证信息的准确性和安全性。

#### 6.2 流程图
```
开始
  ↓
用户查看个人信息
  ↓
用户选择编辑信息
  ↓
系统验证用户权限
  ↓
[权限验证通过?]
  ↓ 是
用户修改信息
  ↓
系统验证修改内容
  ↓
[验证通过?]
  ↓ 是
系统保存修改
  ↓
记录操作日志
  ↓
通知用户修改成功
  ↓
流程结束
```

#### 6.3 详细步骤说明

**步骤1: 用户查看个人信息**
- **参与者**: 用户
- **输入**: 用户请求
- **处理**: 
  - 验证用户身份
  - 获取用户个人信息
  - 过滤敏感信息
- **输出**: 个人信息显示
- **业务规则**:
  - 用户只能查看自己的信息
  - 敏感信息不直接显示
  - 信息显示格式清晰

**步骤2: 用户选择编辑信息**
- **参与者**: 用户
- **输入**: 编辑请求
- **处理**: 
  - 验证用户权限
  - 显示编辑表单
  - 预填充现有信息
- **输出**: 编辑界面
- **业务规则**:
  - 邮箱地址不可编辑
  - 其他字段可以编辑
  - 显示字段验证规则

**步骤3: 系统验证修改内容**
- **参与者**: 系统
- **输入**: 修改后的信息
- **处理**: 
  - 验证用户名格式
  - 检查昵称唯一性
  - 验证密码强度
  - 验证联系方式格式
- **输出**: 验证结果
- **业务规则**:
  - 用户名：2-20字符，字母数字下划线
  - 昵称：全局唯一，2-20字符
  - 密码：符合安全要求
  - 联系方式：格式正确

**步骤4: 系统保存修改**
- **参与者**: 系统
- **输入**: 验证通过的信息
- **处理**: 
  - 更新用户信息
  - 记录修改时间
  - 记录操作人员
- **输出**: 保存结果
- **业务规则**:
  - 修改必须原子性执行
  - 修改后立即生效
  - 修改必须记录日志

#### 6.4 异常处理

**异常1: 昵称已被其他用户使用**
- **触发条件**: 新昵称与其他用户重复
- **处理方式**: 提示用户选择其他昵称
- **恢复方式**: 用户修改昵称后重新提交

**异常2: 用户名格式不符合要求**
- **触发条件**: 用户名不符合格式规范
- **处理方式**: 提示用户修改格式
- **恢复方式**: 用户修改格式后重新提交

**异常3: 原密码验证失败**
- **触发条件**: 密码修改时原密码错误
- **处理方式**: 提示密码错误
- **恢复方式**: 用户输入正确原密码

**异常4: 新密码强度不够**
- **触发条件**: 新密码不符合安全要求
- **处理方式**: 提示加强密码
- **恢复方式**: 用户设置更强密码

### 7. 租户重命名流程

#### 7.1 流程概述
租户重命名流程确保租户管理员能够安全地重命名租户，同时保证租户名称的全局唯一性。

#### 7.2 流程图
```
开始
  ↓
租户管理员提交重命名申请
  ↓
系统验证新名称
  ↓
[验证通过?]
  ↓ 是
系统执行重命名
  ↓
更新租户名称
  ↓
记录操作日志
  ↓
通知租户内用户
  ↓
流程结束
```

#### 5.3 详细步骤说明

**步骤1: 租户管理员提交重命名申请**
- **参与者**: 租户管理员
- **输入**: 新的租户名称
- **处理**: 
  - 验证新名称格式
  - 检查重命名权限
  - 检查重命名频率限制
- **输出**: 重命名申请
- **业务规则**:
  - 只有租户管理员可以重命名本租户
  - 默认系统租户不能重命名
  - 重命名操作不能过于频繁

**步骤2: 系统验证新名称**
- **参与者**: 系统
- **输入**: 新的租户名称
- **处理**:
  - 验证新名称格式（2-50字符）
  - 检查新名称是否与其他租户重复
  - 检查新名称是否与申请中的租户名称重复
- **输出**: 验证结果
- **异常处理**:
  - 验证失败：返回具体错误信息
  - 名称重复：提示管理员选择其他名称

**步骤3: 系统执行重命名**
- **参与者**: 系统
- **输入**: 验证通过的新名称
- **处理**:
  - 更新租户记录中的名称
  - 记录重命名时间
  - 记录操作人员信息
- **输出**: 重命名结果
- **业务规则**:
  - 重命名必须原子性执行
  - 重命名不影响租户代码和其他配置

**步骤4: 记录操作日志**
- **参与者**: 系统
- **输入**: 重命名操作信息
- **处理**:
  - 记录原名称和新名称
  - 记录重命名时间和操作人
  - 记录重命名原因（可选）
- **输出**: 操作日志
- **业务规则**:
  - 每次重命名都必须记录
  - 日志包含完整的操作信息
  - 日志不可修改

**步骤5: 通知租户内用户**
- **参与者**: 系统
- **输入**: 重命名结果和用户信息
- **处理**:
  - 通知租户内所有用户
  - 记录通知发送时间
- **输出**: 通知发送结果
- **业务规则**:
  - 重命名结果必须通知所有用户
  - 通知内容包含新旧名称对比
  - 通知发送记录日志

#### 7.4 异常处理

**异常1: 新名称格式无效**
- **触发条件**: 新名称不符合格式要求
- **处理方式**: 返回具体错误信息，要求管理员修改
- **恢复方式**: 管理员修改后重新提交

**异常2: 新名称重复**
- **触发条件**: 新名称与其他租户或申请中的租户重复
- **处理方式**: 提示管理员选择其他名称
- **恢复方式**: 管理员选择其他名称后重新提交

**异常3: 重命名频率过高**
- **触发条件**: 重命名操作过于频繁
- **处理方式**: 提示管理员稍后再试
- **恢复方式**: 等待时间间隔后重新提交

### 6. 租户管理员更换流程

#### 6.1 流程概述
租户管理员更换流程确保租户管理权限的安全转移。

#### 4.2 流程图
```
开始
  ↓
系统管理员选择租户
  ↓
系统管理员选择新管理员
  ↓
系统验证新管理员
  ↓
[验证通过?]
  ↓ 是
原管理员降级
  ↓
新管理员升级
  ↓
更新租户管理员信息
  ↓
记录操作日志
  ↓
通知相关人员
  ↓
流程结束
```

#### 4.3 详细步骤说明

**步骤1: 系统管理员选择租户**
- **参与者**: 系统管理员
- **输入**: 租户列表
- **处理**:
  - 查看所有租户
  - 选择要更换管理员的租户
  - 查看当前管理员信息
- **输出**: 选中的租户
- **业务规则**:
  - 只有系统管理员可以更换租户管理员
  - 可以查看所有租户信息

**步骤2: 系统管理员选择新管理员**
- **参与者**: 系统管理员
- **输入**: 租户用户列表
- **处理**:
  - 查看租户下的所有用户
  - 选择新的租户管理员
  - 确认选择
- **输出**: 新管理员选择
- **业务规则**:
  - 新管理员必须是该租户的用户
  - 新管理员不能是当前管理员

**步骤3: 系统验证新管理员**
- **参与者**: 系统
- **输入**: 新管理员信息
- **处理**:
  - 验证用户存在性
  - 验证用户属于该租户
  - 验证用户状态
  - 检查用户权限
- **输出**: 验证结果
- **异常处理**:
  - 用户不存在：返回错误信息
  - 用户不属于该租户：返回错误信息
  - 用户状态异常：返回错误信息

**步骤4: 原管理员降级**
- **参与者**: 系统
- **输入**: 原管理员信息
- **处理**:
  - 移除租户管理员角色
  - 保留其他角色
  - 记录降级时间
- **输出**: 降级结果
- **业务规则**:
  - 原管理员降级为普通用户
  - 保留其他非管理角色
  - 降级操作记录日志

**步骤5: 新管理员升级**
- **参与者**: 系统
- **输入**: 新管理员信息
- **处理**:
  - 分配租户管理员角色
  - 授予管理权限
  - 记录升级时间
- **输出**: 升级结果
- **业务规则**:
  - 新管理员获得租户管理权限
  - 权限立即生效
  - 升级操作记录日志

**步骤6: 更新租户管理员信息**
- **参与者**: 系统
- **输入**: 新管理员ID
- **处理**:
  - 更新租户记录中的管理员ID
  - 更新管理员信息
  - 记录更新时间
- **输出**: 更新结果
- **业务规则**:
  - 租户记录中的管理员ID必须更新
  - 更新时间自动记录
  - 更新操作记录日志

**步骤7: 记录操作日志**
- **参与者**: 系统
- **输入**: 管理员更换操作信息
- **处理**:
  - 记录操作类型
  - 记录操作人
  - 记录操作时间
  - 记录操作详情
- **输出**: 操作日志
- **业务规则**:
  - 管理员更换必须记录详细日志
  - 日志包含原管理员和新管理员信息
  - 日志不可修改

**步骤8: 通知相关人员**
- **参与者**: 系统
- **输入**: 管理员更换信息
- **处理**:
  - 通知原管理员
  - 通知新管理员
  - 通知租户其他用户（可选）
- **输出**: 通知发送结果
- **业务规则**:
  - 管理员更换必须通知相关人员
  - 通知包含更换原因和时间
  - 通知发送记录日志

---

## 🚨 异常处理策略

### 1. 通用异常处理原则

#### 1.1 异常分类
- **业务异常**: 业务规则验证失败
- **系统异常**: 系统内部错误
- **网络异常**: 网络连接问题
- **数据异常**: 数据一致性问题

#### 1.2 异常处理策略
- **业务异常**: 返回具体错误信息，指导用户操作
- **系统异常**: 记录错误日志，返回通用错误信息
- **网络异常**: 重试机制，超时处理
- **数据异常**: 数据回滚，一致性检查

### 2. 具体异常处理

#### 2.1 租户申请异常
- **申请信息不完整**: 提示用户补充信息
- **申请人不归属默认系统租户**: 提示用户只有默认系统租户用户才能申请
- **租户名称重复**: 建议用户选择其他名称
- **租户代码重复**: 建议用户选择其他代码
- **申请人有未处理申请**: 提示用户等待处理
- **系统错误**: 记录错误，建议用户稍后重试

#### 2.2 用户注册异常
- **邮箱已注册**: 提示用户使用其他邮箱
- **密码强度不足**: 提示用户设置更强密码
- **激活链接失效**: 重新发送激活邮件
- **系统错误**: 记录错误，建议用户稍后重试

#### 2.3 角色管理异常
- **权限不足**: 提示用户联系管理员
- **用户不存在**: 返回错误信息
- **角色冲突**: 提示用户选择其他角色
- **系统错误**: 记录错误，回滚操作

#### 2.4 租户变更异常
- **目标租户不存在**: 提示用户选择其他租户
- **用户有未处理申请**: 提示用户等待处理
- **权限不足**: 提示用户联系管理员
- **系统错误**: 记录错误，回滚操作

#### 2.5 租户重命名异常
- **新名称格式无效**: 提示管理员修改名称格式
- **新名称重复**: 提示管理员选择其他名称
- **重命名频率过高**: 提示管理员稍后再试
- **权限不足**: 提示管理员联系系统管理员
- **系统错误**: 记录错误，回滚操作

---

## 📊 业务指标

### 1. 关键业务指标

#### 1.1 租户相关指标
- **租户申请成功率**: 目标 > 90%
- **租户申请处理时间**: 目标 < 24小时
- **租户活跃率**: 目标 > 80%
- **租户续费率**: 目标 > 85%

#### 1.2 用户相关指标
- **用户注册转化率**: 目标 > 70%
- **用户激活率**: 目标 > 80%
- **用户活跃率**: 目标 > 75%
- **用户满意度**: 目标 > 4.0/5.0

#### 1.3 系统相关指标
- **系统可用性**: 目标 > 99.9%
- **响应时间**: 目标 < 2秒
- **错误率**: 目标 < 0.1%
- **并发用户数**: 目标 > 1000

### 2. 监控指标

#### 2.1 业务监控
- 租户申请数量趋势
- 用户注册数量趋势
- 角色分配频率
- 管理员更换频率

#### 2.2 系统监控
- 系统响应时间
- 错误率统计
- 并发用户数
- 资源使用率

#### 2.3 安全监控
- 异常登录尝试
- 权限变更记录
- 数据访问日志
- 安全事件统计

---

## 📝 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | 2024-12 | 初始版本 | 产品团队 |

---

## 📞 联系方式

- **产品负责人**: [待填写]
- **技术负责人**: [待填写]
- **业务负责人**: [待填写]
- **邮箱**: [待填写]
