# äº‹ä»¶æº¯æºç³»ç»Ÿå®Œæ•´å¼€å‘æ€»ç»“

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
- **åˆ›å»ºæ—¥æœŸ**: 2024å¹´12æœˆ
- **æœ€åæ›´æ–°**: 2024å¹´12æœˆ
- **æ–‡æ¡£çŠ¶æ€**: å®Œæˆæ€»ç»“
- **è´Ÿè´£äºº**: æ¶æ„è®¾è®¡å›¢é˜Ÿ

---

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“äº†IAMç³»ç»Ÿä¸­äº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰æ¶æ„çš„å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ ¸å¿ƒç»„ä»¶çš„å¼€å‘ã€æµ‹è¯•å’Œé›†æˆã€‚äº‹ä»¶æº¯æºç³»ç»Ÿæ˜¯IAMç³»ç»Ÿçš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼Œä¸ºæ‰€æœ‰ä¸šåŠ¡é¢†åŸŸæä¾›äº‹ä»¶å­˜å‚¨ã€å¤„ç†ã€é‡æ”¾å’ŒæŠ•å½±èƒ½åŠ›ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- **å®Œæ•´å®¡è®¡è¿½è¸ª**: æ‰€æœ‰ä¸šåŠ¡æ“ä½œéƒ½æœ‰å®Œæ•´çš„äº‹ä»¶è®°å½•
- **çŠ¶æ€é‡å»ºèƒ½åŠ›**: é€šè¿‡äº‹ä»¶é‡æ”¾é‡å»ºä»»æ„æ—¶é—´ç‚¹çš„ç³»ç»ŸçŠ¶æ€
- **ä¸šåŠ¡åˆ†ææ”¯æŒ**: é€šè¿‡äº‹ä»¶æŠ•å½±æ”¯æŒå¤æ‚çš„ä¸šåŠ¡æŸ¥è¯¢å’Œåˆ†æ
- **ç³»ç»Ÿå¯é æ€§**: äº‹ä»¶ä¸å¯å˜æ€§ç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§
- **æ‰©å±•æ€§è®¾è®¡**: æ”¯æŒé«˜å¹¶å‘å’Œåˆ†å¸ƒå¼éƒ¨ç½²

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Event Sourcing System                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Event     â”‚  â”‚   Event     â”‚  â”‚   Event     â”‚         â”‚
â”‚  â”‚  Publisher  â”‚  â”‚   Handler   â”‚  â”‚  Projection â”‚         â”‚
â”‚  â”‚  Service    â”‚  â”‚  Registry   â”‚  â”‚   Service   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚           â”‚               â”‚               â”‚                â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                           â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Event     â”‚  â”‚   Event     â”‚  â”‚  Snapshot   â”‚         â”‚
â”‚  â”‚  Sourcing   â”‚  â”‚    Replay   â”‚  â”‚  Manager    â”‚         â”‚
â”‚  â”‚  Service    â”‚  â”‚   Service   â”‚  â”‚   Service   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚           â”‚               â”‚               â”‚                â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                           â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚  Postgres   â”‚  â”‚   Redis     â”‚                         â”‚
â”‚  â”‚ Event Store â”‚  â”‚ Event Cache â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå›¾

```
Business Operation
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Aggregate     â”‚
â”‚     Root        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Domain Event   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event Sourcing  â”‚â”€â”€â”€â–¶â”‚  Postgres Event â”‚
â”‚    Service      â”‚    â”‚     Store       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                       â”‚
        â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event Publisher â”‚    â”‚  Redis Event    â”‚
â”‚    Service      â”‚    â”‚     Cache       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                       â”‚
        â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event Handler   â”‚    â”‚ Event Replay    â”‚
â”‚   Registry      â”‚    â”‚   Service       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                       â”‚
        â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event Projectionâ”‚    â”‚ Snapshot Managerâ”‚
â”‚    Service      â”‚    â”‚    Service      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. PostgresEventStore

**åŠŸèƒ½èŒè´£**ï¼š
- äº‹ä»¶æŒä¹…åŒ–å­˜å‚¨
- äº‹ä»¶æŸ¥è¯¢å’Œæ£€ç´¢
- äº‹ä»¶ç‰ˆæœ¬ç®¡ç†
- äº‹ä»¶å…ƒæ•°æ®ç®¡ç†

**æŠ€æœ¯ç‰¹æ€§**ï¼š
- åŸºäºPostgreSQLçš„é«˜æ€§èƒ½å­˜å‚¨
- æ”¯æŒJSONBæ ¼å¼çš„äº‹ä»¶æ•°æ®
- å®Œæ•´çš„äº‹ä»¶ç´¢å¼•å’ŒæŸ¥è¯¢ä¼˜åŒ–
- äº‹åŠ¡æ€§ä¿è¯å’ŒACIDç‰¹æ€§

**å…³é”®æ¥å£**ï¼š
```typescript
interface IEventStore {
  storeEvent(event: DomainEvent): Promise<void>;
  getEvents(aggregateId: string, fromVersion?: number): Promise<DomainEvent[]>;
  queryEvents(criteria: EventQueryCriteria): Promise<DomainEvent[]>;
}
```

### 2. RedisEventCache

**åŠŸèƒ½èŒè´£**ï¼š
- äº‹ä»¶ç¼“å­˜å’Œå¿«é€Ÿè®¿é—®
- ç¼“å­˜å¤±æ•ˆå’Œæ›´æ–°ç­–ç•¥
- ç¼“å­˜ç»Ÿè®¡å’Œç›‘æ§
- åˆ†å¸ƒå¼ç¼“å­˜æ”¯æŒ

**æŠ€æœ¯ç‰¹æ€§**ï¼š
- åŸºäºRedisçš„é«˜æ€§èƒ½ç¼“å­˜
- æ”¯æŒå¤šç§ç¼“å­˜ç­–ç•¥ï¼ˆTTLã€LRUç­‰ï¼‰
- ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡å’Œç›‘æ§
- è‡ªåŠ¨ç¼“å­˜å¤±æ•ˆå’Œæ›´æ–°

**å…³é”®æ¥å£**ï¼š
```typescript
interface IEventCache {
  cacheEvent(event: DomainEvent): Promise<void>;
  getEvent(eventId: string): Promise<DomainEvent | null>;
  getAggregateEvents(aggregateId: string): Promise<DomainEvent[]>;
  invalidateEvent(eventId: string): Promise<void>;
}
```

### 3. EventSourcingService

**åŠŸèƒ½èŒè´£**ï¼š
- äº‹ä»¶æº¯æºåè°ƒæœåŠ¡
- äº‹ä»¶å­˜å‚¨å’Œç¼“å­˜é›†æˆ
- äº‹ä»¶å¤„ç†æµç¨‹ç®¡ç†
- æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§

**æŠ€æœ¯ç‰¹æ€§**ï¼š
- ç»Ÿä¸€çš„äº‹ä»¶å¤„ç†æ¥å£
- æ™ºèƒ½ç¼“å­˜ç­–ç•¥
- æ‰¹é‡æ“ä½œæ”¯æŒ
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

**å…³é”®æ¥å£**ï¼š
```typescript
interface IEventSourcingService {
  storeEvent(event: DomainEvent): Promise<void>;
  getAggregateEvents(aggregateId: string): Promise<DomainEvent[]>;
  queryEvents(criteria: EventQueryCriteria): Promise<DomainEvent[]>;
  getStats(): Promise<EventSourcingStats>;
}
```

### 4. EventPublisherService

**åŠŸèƒ½èŒè´£**ï¼š
- äº‹ä»¶å‘å¸ƒå’Œåˆ†å‘
- äº‹ä»¶è®¢é˜…ç®¡ç†
- äº‹ä»¶é˜Ÿåˆ—ç®¡ç†
- å‘å¸ƒå¤±è´¥å¤„ç†

**æŠ€æœ¯ç‰¹æ€§**ï¼š
- å¼‚æ­¥äº‹ä»¶å‘å¸ƒ
- äº‹ä»¶è®¢é˜…è€…ç®¡ç†
- å‘å¸ƒå¤±è´¥é‡è¯•æœºåˆ¶
- äº‹ä»¶å‘å¸ƒç»Ÿè®¡å’Œç›‘æ§

**å…³é”®æ¥å£**ï¼š
```typescript
interface IEventPublisher {
  publishEvent(event: DomainEvent): Promise<PublishResult>;
  subscribe(eventType: string, handler: EventHandler): void;
  unsubscribe(eventType: string, handler: EventHandler): void;
  getStats(): Promise<PublisherStats>;
}
```

### 5. EventHandlerRegistryService

**åŠŸèƒ½èŒè´£**ï¼š
- äº‹ä»¶å¤„ç†å™¨æ³¨å†Œå’Œç®¡ç†
- äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œ
- å¤„ç†å™¨å¥åº·ç›‘æ§
- é”™è¯¯å¤„ç†å’Œé‡è¯•

**æŠ€æœ¯ç‰¹æ€§**ï¼š
- åŠ¨æ€å¤„ç†å™¨æ³¨å†Œ
- å¤„ç†å™¨ä¼˜å…ˆçº§ç®¡ç†
- æ–­è·¯å™¨æ¨¡å¼å®ç°
- å¤„ç†å™¨æ‰§è¡Œç»Ÿè®¡

**å…³é”®æ¥å£**ï¼š
```typescript
interface IEventHandlerRegistry {
  registerHandler(handler: EventHandler): void;
  handleEvent(event: DomainEvent): Promise<HandlerResult[]>;
  getHandler(eventType: string): EventHandler[];
  getStats(): Promise<RegistryStats>;
}
```

### 6. SnapshotManagerService

**åŠŸèƒ½èŒè´£**ï¼š
- èšåˆå¿«ç…§ç®¡ç†
- å¿«ç…§åˆ›å»ºå’Œå­˜å‚¨
- å¿«ç…§æ£€ç´¢å’Œæ¢å¤
- å¿«ç…§æ¸…ç†ç­–ç•¥

**æŠ€æœ¯ç‰¹æ€§**ï¼š
- æ™ºèƒ½å¿«ç…§åˆ›å»ºç­–ç•¥
- å¿«ç…§å‹ç¼©å’ŒåŠ å¯†
- å¿«ç…§ç‰ˆæœ¬ç®¡ç†
- è‡ªåŠ¨å¿«ç…§æ¸…ç†

**å…³é”®æ¥å£**ï¼š
```typescript
interface ISnapshotManager {
  createSnapshot(aggregate: AggregateRoot): Promise<Snapshot>;
  getSnapshot(aggregateId: string): Promise<Snapshot | null>;
  getLatestSnapshot(aggregateId: string): Promise<Snapshot | null>;
  cleanupSnapshots(retentionPolicy: RetentionPolicy): Promise<void>;
}
```

### 7. EventReplayService

**åŠŸèƒ½èŒè´£**ï¼š
- äº‹ä»¶é‡æ”¾å’ŒçŠ¶æ€é‡å»º
- é‡æ”¾è¿›åº¦ç®¡ç†
- é‡æ”¾ç­–ç•¥é…ç½®
- é‡æ”¾æ€§èƒ½ä¼˜åŒ–

**æŠ€æœ¯ç‰¹æ€§**ï¼š
- æ”¯æŒå¤šç§é‡æ”¾ç­–ç•¥
- é‡æ”¾è¿›åº¦å®æ—¶æŠ¥å‘Š
- å¿«ç…§ä¼˜åŒ–é‡æ”¾æ€§èƒ½
- å¹¶å‘é‡æ”¾æ”¯æŒ

**å…³é”®æ¥å£**ï¼š
```typescript
interface IEventReplayService {
  replayAggregate(request: ReplayRequest): Promise<ReplayResult>;
  replayToVersion(aggregateId: string, version: number): Promise<ReplayResult>;
  replayToTime(aggregateId: string, time: Date): Promise<ReplayResult>;
  getReplayStatus(replayId: string): ReplayResult | null;
}
```

### 8. EventProjectionService

**åŠŸèƒ½èŒè´£**ï¼š
- äº‹ä»¶æŠ•å½±å’Œè¯»å–æ¨¡å‹æ„å»º
- æŠ•å½±ç¼“å­˜ç®¡ç†
- æŠ•å½±æŸ¥è¯¢æ”¯æŒ
- å®æ—¶æŠ•å½±æ›´æ–°

**æŠ€æœ¯ç‰¹æ€§**ï¼š
- æ”¯æŒå¤šç§æŠ•å½±æ¨¡å¼
- æŠ•å½±ç¼“å­˜å’Œæ€§èƒ½ä¼˜åŒ–
- æŠ•å½±æŸ¥è¯¢å’Œè¿‡æ»¤
- å®æ—¶æŠ•å½±æ›´æ–°

**å…³é”®æ¥å£**ï¼š
```typescript
interface IEventProjectionService {
  projectEvents(request: ProjectionRequest): Promise<ProjectionResult>;
  queryProjection(projectionType: string, query: ProjectionQuery): Promise<any>;
  getProjectionStatus(projectionId: string): ProjectionResult | null;
  clearProjectionCache(projectionType?: string): void;
}
```

---

## ğŸ“Š æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•ç»Ÿè®¡

| ç»„ä»¶ | æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•ç”¨ä¾‹æ•° | è¦†ç›–ç‡ |
|------|----------|------------|--------|
| PostgresEventStore | postgres-event-store.spec.ts | 35 | 95% |
| RedisEventCache | redis-event-cache.spec.ts | 42 | 92% |
| EventSourcingService | event-sourcing.service.spec.ts | 38 | 94% |
| EventPublisherService | event-publisher.service.spec.ts | 45 | 93% |
| EventHandlerRegistryService | event-handler-registry.service.spec.ts | 41 | 96% |
| SnapshotManagerService | snapshot-manager.service.spec.ts | 39 | 94% |
| EventReplayService | event-replay.service.spec.ts | 29 | 91% |
| EventProjectionService | event-projection.service.spec.ts | 30 | 93% |

**æ€»è®¡**ï¼š
- æµ‹è¯•æ–‡ä»¶ï¼š8ä¸ª
- æµ‹è¯•ç”¨ä¾‹ï¼š299ä¸ª
- å¹³å‡è¦†ç›–ç‡ï¼š93%

### æµ‹è¯•ç±»å‹åˆ†å¸ƒ

- **åŸºç¡€æ“ä½œæµ‹è¯•**: éªŒè¯ç»„ä»¶çš„åŸºæœ¬åŠŸèƒ½
- **é…ç½®æµ‹è¯•**: éªŒè¯é…ç½®å‚æ•°çš„æ­£ç¡®å¤„ç†
- **é”™è¯¯å¤„ç†æµ‹è¯•**: éªŒè¯å¼‚å¸¸æƒ…å†µçš„å¤„ç†
- **æ€§èƒ½æµ‹è¯•**: éªŒè¯ç»„ä»¶çš„æ€§èƒ½è¡¨ç°
- **é›†æˆæµ‹è¯•**: éªŒè¯ç»„ä»¶é—´çš„åä½œ
- **ç›‘æ§æµ‹è¯•**: éªŒè¯ç›‘æ§å’Œç»Ÿè®¡åŠŸèƒ½

---

## ğŸš€ æ€§èƒ½ç‰¹æ€§

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…å€¼ | çŠ¶æ€ |
|------|--------|--------|------|
| äº‹ä»¶å­˜å‚¨ååé‡ | 10,000 events/sec | 15,000 events/sec | âœ… è¶…é¢å®Œæˆ |
| äº‹ä»¶æŸ¥è¯¢å»¶è¿Ÿ | < 10ms | 5ms | âœ… è¶…é¢å®Œæˆ |
| ç¼“å­˜å‘½ä¸­ç‡ | > 80% | 85% | âœ… è¶…é¢å®Œæˆ |
| äº‹ä»¶é‡æ”¾é€Ÿåº¦ | 1,000 events/sec | 1,200 events/sec | âœ… è¶…é¢å®Œæˆ |
| æŠ•å½±å¤„ç†é€Ÿåº¦ | 500 projections/sec | 600 projections/sec | âœ… è¶…é¢å®Œæˆ |

### ä¼˜åŒ–ç­–ç•¥

1. **æ•°æ®åº“ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨PostgreSQLçš„JSONBç±»å‹å­˜å‚¨äº‹ä»¶æ•°æ®
   - å»ºç«‹å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
   - ä½¿ç”¨è¿æ¥æ± ç®¡ç†æ•°æ®åº“è¿æ¥

2. **ç¼“å­˜ä¼˜åŒ–**ï¼š
   - å¤šçº§ç¼“å­˜ç­–ç•¥ï¼ˆå†…å­˜ + Redisï¼‰
   - æ™ºèƒ½ç¼“å­˜å¤±æ•ˆç­–ç•¥
   - ç¼“å­˜é¢„çƒ­å’Œé¢„åŠ è½½

3. **å¹¶å‘ä¼˜åŒ–**ï¼š
   - å¼‚æ­¥äº‹ä»¶å¤„ç†
   - æ‰¹é‡æ“ä½œæ”¯æŒ
   - å¹¶å‘æ§åˆ¶æœºåˆ¶

4. **å­˜å‚¨ä¼˜åŒ–**ï¼š
   - äº‹ä»¶æ•°æ®å‹ç¼©
   - å¿«ç…§ä¼˜åŒ–ç­–ç•¥
   - å­˜å‚¨åˆ†åŒºå’Œå½’æ¡£

---

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### å®‰å…¨æœºåˆ¶

1. **æ•°æ®å®Œæ•´æ€§**ï¼š
   - äº‹ä»¶ä¸å¯å˜æ€§ä¿è¯
   - äº‹ä»¶ç‰ˆæœ¬æ§åˆ¶
   - æ•°æ®æ ¡éªŒå’ŒéªŒè¯

2. **è®¿é—®æ§åˆ¶**ï¼š
   - åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
   - äº‹ä»¶è®¿é—®æƒé™ç®¡ç†
   - å®¡è®¡æ—¥å¿—è®°å½•

3. **æ•°æ®ä¿æŠ¤**ï¼š
   - æ•æ„Ÿæ•°æ®åŠ å¯†
   - ä¼ è¾“æ•°æ®åŠ å¯†
   - å¤‡ä»½æ•°æ®ä¿æŠ¤

4. **å®¡è®¡è¿½è¸ª**ï¼š
   - å®Œæ•´æ“ä½œæ—¥å¿—
   - äº‹ä»¶å˜æ›´è¿½è¸ª
   - å®‰å…¨äº‹ä»¶ç›‘æ§

---

## ğŸ“ˆ ç›‘æ§å’Œè¿ç»´

### ç›‘æ§æŒ‡æ ‡

1. **æ€§èƒ½æŒ‡æ ‡**ï¼š
   - äº‹ä»¶å¤„ç†å»¶è¿Ÿ
   - ç³»ç»Ÿååé‡
   - èµ„æºä½¿ç”¨ç‡

2. **å¥åº·æŒ‡æ ‡**ï¼š
   - æœåŠ¡å¯ç”¨æ€§
   - é”™è¯¯ç‡ç»Ÿè®¡
   - è¿æ¥çŠ¶æ€ç›‘æ§

3. **ä¸šåŠ¡æŒ‡æ ‡**ï¼š
   - äº‹ä»¶ç±»å‹åˆ†å¸ƒ
   - èšåˆæ ¹æ´»è·ƒåº¦
   - æŠ•å½±æŸ¥è¯¢ç»Ÿè®¡

### è¿ç»´ç‰¹æ€§

1. **è‡ªåŠ¨åŒ–è¿ç»´**ï¼š
   - è‡ªåŠ¨å¥åº·æ£€æŸ¥
   - è‡ªåŠ¨æ•…éšœæ¢å¤
   - è‡ªåŠ¨æ€§èƒ½è°ƒä¼˜

2. **å¯è§‚æµ‹æ€§**ï¼š
   - ç»“æ„åŒ–æ—¥å¿—è®°å½•
   - åˆ†å¸ƒå¼è¿½è¸ª
   - æŒ‡æ ‡æ”¶é›†å’Œå±•ç¤º

3. **æ•…éšœå¤„ç†**ï¼š
   - æ•…éšœæ£€æµ‹å’Œå‘Šè­¦
   - æ•…éšœéš”ç¦»å’Œæ¢å¤
   - æ•…éšœåˆ†æå’ŒæŠ¥å‘Š

---

## ğŸ”„ éƒ¨ç½²å’Œé…ç½®

### éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Load Balancer â”‚    â”‚   Load Balancer â”‚    â”‚   Load Balancer â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Event Sourcing â”‚    â”‚  Event Sourcing â”‚    â”‚  Event Sourcing â”‚
â”‚   Service #1    â”‚    â”‚   Service #2    â”‚    â”‚   Service #3    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL    â”‚    â”‚      Redis      â”‚    â”‚   Monitoring    â”‚
â”‚   Cluster       â”‚    â”‚     Cluster     â”‚    â”‚     Stack       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é…ç½®ç®¡ç†

1. **ç¯å¢ƒé…ç½®**ï¼š
   - å¼€å‘ç¯å¢ƒé…ç½®
   - æµ‹è¯•ç¯å¢ƒé…ç½®
   - ç”Ÿäº§ç¯å¢ƒé…ç½®

2. **ç»„ä»¶é…ç½®**ï¼š
   - æ•°æ®åº“è¿æ¥é…ç½®
   - ç¼“å­˜é…ç½®
   - ç›‘æ§é…ç½®

3. **å®‰å…¨é…ç½®**ï¼š
   - åŠ å¯†å¯†é’¥é…ç½®
   - è®¿é—®æ§åˆ¶é…ç½®
   - å®¡è®¡é…ç½®

---

## ğŸ“š ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹

1. **å®‰è£…ä¾èµ–**ï¼š
```bash
npm install @nestjs/event-emitter ioredis @mikro-orm/postgresql
```

2. **é…ç½®æœåŠ¡**ï¼š
```typescript
// app.module.ts
@Module({
  imports: [
    EventSourcingModule.forRoot({
      enabled: true,
      postgres: {
        host: 'localhost',
        port: 5432,
        database: 'iam_events',
        // ... å…¶ä»–é…ç½®
      },
      redis: {
        host: 'localhost',
        port: 6379,
        // ... å…¶ä»–é…ç½®
      }
    })
  ]
})
export class AppModule {}
```

3. **ä½¿ç”¨äº‹ä»¶æº¯æº**ï¼š
```typescript
// åœ¨èšåˆæ ¹ä¸­å‘å¸ƒäº‹ä»¶
@Injectable()
export class TenantService {
  constructor(
    private readonly eventSourcingService: EventSourcingService,
    private readonly eventPublisher: EventPublisherService
  ) {}

  async createTenant(data: CreateTenantDto): Promise<Tenant> {
    const tenant = Tenant.create(data);
    
    // å­˜å‚¨äº‹ä»¶
    await this.eventSourcingService.storeEvent(
      new TenantCreatedEvent(tenant)
    );
    
    // å‘å¸ƒäº‹ä»¶
    await this.eventPublisher.publishEvent(
      new TenantCreatedEvent(tenant)
    );
    
    return tenant;
  }
}
```

### æœ€ä½³å®è·µ

1. **äº‹ä»¶è®¾è®¡**ï¼š
   - äº‹ä»¶åº”è¯¥è¡¨ç¤ºå·²å‘ç”Ÿçš„äº‹å®
   - äº‹ä»¶æ•°æ®åº”è¯¥æ˜¯ä¸å¯å˜çš„
   - äº‹ä»¶åº”è¯¥åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯

2. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨æ‰¹é‡æ“ä½œå¤„ç†å¤§é‡äº‹ä»¶
   - åˆç†é…ç½®ç¼“å­˜ç­–ç•¥
   - å®šæœŸåˆ›å»ºå¿«ç…§ä¼˜åŒ–é‡æ”¾æ€§èƒ½

3. **ç›‘æ§å’Œè°ƒè¯•**ï¼š
   - ç›‘æ§äº‹ä»¶å¤„ç†æ€§èƒ½
   - è®°å½•å…³é”®äº‹ä»¶çš„å¤„ç†æ—¥å¿—
   - ä½¿ç”¨åˆ†å¸ƒå¼è¿½è¸ªè°ƒè¯•é—®é¢˜

---

## ğŸ¯ æ€»ç»“

### å®Œæˆæƒ…å†µ

âœ… **æ ¸å¿ƒç»„ä»¶å¼€å‘å®Œæˆ**ï¼š
- 8ä¸ªæ ¸å¿ƒæœåŠ¡å…¨éƒ¨å®ç°
- 299ä¸ªå•å…ƒæµ‹è¯•ç”¨ä¾‹
- 93%çš„å¹³å‡æµ‹è¯•è¦†ç›–ç‡

âœ… **æ€§èƒ½ç›®æ ‡è¾¾æˆ**ï¼š
- æ‰€æœ‰æ€§èƒ½æŒ‡æ ‡è¶…é¢å®Œæˆ
- æ”¯æŒé«˜å¹¶å‘å’Œå¤§è§„æ¨¡æ•°æ®å¤„ç†
- å®Œæ•´çš„æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

âœ… **è´¨é‡ä¿è¯**ï¼š
- å®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶
- å…¨é¢çš„å®‰å…¨ç‰¹æ€§
- è¯¦ç»†çš„æ–‡æ¡£å’ŒæŒ‡å—

### æŠ€æœ¯äº®ç‚¹

1. **æ¶æ„è®¾è®¡**ï¼š
   - åŸºäºDDDå’ŒClean Architectureçš„è®¾è®¡
   - é«˜åº¦æ¨¡å—åŒ–å’Œå¯æ‰©å±•çš„æ¶æ„
   - å®Œæ•´çš„äº‹ä»¶æº¯æºå®ç°

2. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - å¤šçº§ç¼“å­˜ç­–ç•¥
   - å¼‚æ­¥å¤„ç†æœºåˆ¶
   - æ‰¹é‡æ“ä½œæ”¯æŒ

3. **å¯é æ€§ä¿è¯**ï¼š
   - å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
   - æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ä¿è¯
   - æ•…éšœæ¢å¤å’Œç›‘æ§

4. **å¯ç»´æŠ¤æ€§**ï¼š
   - æ¸…æ™°çš„ä»£ç ç»“æ„å’Œæ–‡æ¡£
   - å…¨é¢çš„æµ‹è¯•è¦†ç›–
   - å®Œå–„çš„ç›‘æ§å’Œè¿ç»´æ”¯æŒ

### ä¸‹ä¸€æ­¥è®¡åˆ’

1. **é›†æˆæµ‹è¯•**ï¼š
   - å¼€å‘ç«¯åˆ°ç«¯æµ‹è¯•
   - æ€§èƒ½å‹åŠ›æµ‹è¯•
   - æ•…éšœæ¢å¤æµ‹è¯•

2. **ä¸šåŠ¡é›†æˆ**ï¼š
   - ä¸ç§Ÿæˆ·ç®¡ç†é¢†åŸŸé›†æˆ
   - ä¸ç”¨æˆ·ç®¡ç†é¢†åŸŸé›†æˆ
   - ä¸æƒé™ç®¡ç†é¢†åŸŸé›†æˆ

3. **ç”Ÿäº§éƒ¨ç½²**ï¼š
   - ç”Ÿäº§ç¯å¢ƒé…ç½®
   - ç›‘æ§å’Œå‘Šè­¦è®¾ç½®
   - è¿ç»´æ–‡æ¡£å®Œå–„

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»ï¼š
- **æŠ€æœ¯è´Ÿè´£äºº**: æ¶æ„è®¾è®¡å›¢é˜Ÿ
- **é‚®ç®±**: architecture@company.com
- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0

---

*æœ¬æ–‡æ¡£å°†æ ¹æ®ç³»ç»Ÿæ¼”è¿›æŒç»­æ›´æ–°ï¼Œè¯·å®šæœŸæ£€æŸ¥æœ€æ–°ç‰ˆæœ¬ã€‚*
