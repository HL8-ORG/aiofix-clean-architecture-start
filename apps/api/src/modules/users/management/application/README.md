# ç”¨æˆ·ç®¡ç†åº”ç”¨å±‚ - CQRSæ¶æ„

## ğŸ“‹ æ¦‚è¿°

ç”¨æˆ·ç®¡ç†åº”ç”¨å±‚é‡‡ç”¨CQRSï¼ˆCommand Query Responsibility Segregationï¼‰æ¶æ„æ¨¡å¼ï¼Œå°†è¯»å†™æ“ä½œåˆ†ç¦»ï¼Œæé«˜ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œç»´æŠ¤æ€§ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

1. **å‘½ä»¤ï¼ˆCommandsï¼‰**: è¡¨ç¤ºå†™æ“ä½œï¼Œå¦‚åˆ›å»ºç”¨æˆ·ã€æ›´æ–°ç”¨æˆ·ç­‰
2. **æŸ¥è¯¢ï¼ˆQueriesï¼‰**: è¡¨ç¤ºè¯»æ“ä½œï¼Œå¦‚è·å–ç”¨æˆ·ä¿¡æ¯ã€è·å–ç”¨æˆ·åˆ—è¡¨ç­‰
3. **å‘½ä»¤å¤„ç†å™¨ï¼ˆCommand Handlersï¼‰**: å¤„ç†å‘½ä»¤çš„ä¸šåŠ¡é€»è¾‘
4. **æŸ¥è¯¢å¤„ç†å™¨ï¼ˆQuery Handlersï¼‰**: å¤„ç†æŸ¥è¯¢çš„ä¸šåŠ¡é€»è¾‘
5. **å‘½ä»¤æ€»çº¿ï¼ˆCommand Busï¼‰**: è´Ÿè´£è·¯ç”±å‘½ä»¤åˆ°å¯¹åº”çš„å¤„ç†å™¨
6. **æŸ¥è¯¢æ€»çº¿ï¼ˆQuery Busï¼‰**: è´Ÿè´£è·¯ç”±æŸ¥è¯¢åˆ°å¯¹åº”çš„å¤„ç†å™¨

### ç›®å½•ç»“æ„

```
application/
â”œâ”€â”€ commands/                 # å‘½ä»¤å®šä¹‰
â”‚   â”œâ”€â”€ base-command.ts      # åŸºç¡€å‘½ä»¤æ¥å£
â”‚   â”œâ”€â”€ create-user.command.ts
â”‚   â”œâ”€â”€ update-user.command.ts
â”‚   â”œâ”€â”€ change-password.command.ts
â”‚   â”œâ”€â”€ activate-user.command.ts
â”‚   â”œâ”€â”€ deactivate-user.command.ts
â”‚   â””â”€â”€ reset-password.command.ts
â”œâ”€â”€ queries/                  # æŸ¥è¯¢å®šä¹‰
â”‚   â”œâ”€â”€ base-query.ts        # åŸºç¡€æŸ¥è¯¢æ¥å£
â”‚   â”œâ”€â”€ get-user.query.ts
â”‚   â”œâ”€â”€ get-users.query.ts
â”‚   â”œâ”€â”€ get-user-by-email.query.ts
â”‚   â””â”€â”€ get-user-by-username.query.ts
â”œâ”€â”€ handlers/                 # å¤„ç†å™¨
â”‚   â”œâ”€â”€ command-handler.interface.ts
â”‚   â”œâ”€â”€ query-handler.interface.ts
â”‚   â”œâ”€â”€ commands/            # å‘½ä»¤å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ create-user.handler.ts
â”‚   â”‚   â””â”€â”€ update-user.handler.ts
â”‚   â””â”€â”€ queries/             # æŸ¥è¯¢å¤„ç†å™¨
â”‚       â”œâ”€â”€ get-user.handler.ts
â”‚       â””â”€â”€ get-users.handler.ts
â”œâ”€â”€ bus/                     # æ€»çº¿
â”‚   â”œâ”€â”€ command-bus.interface.ts
â”‚   â”œâ”€â”€ query-bus.interface.ts
â”‚   â”œâ”€â”€ command-bus.ts
â”‚   â””â”€â”€ query-bus.ts
â”œâ”€â”€ services/                # åº”ç”¨æœåŠ¡
â”‚   â””â”€â”€ user-application.service.ts
â”œâ”€â”€ interfaces/              # æ¥å£å®šä¹‰
â”‚   â””â”€â”€ user-application.interface.ts
â”œâ”€â”€ dto/                     # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ user.dto.ts
â”‚   â”œâ”€â”€ create-user.dto.ts
â”‚   â”œâ”€â”€ update-user.dto.ts
â”‚   â”œâ”€â”€ change-password.dto.ts
â”‚   â””â”€â”€ user-list.dto.ts
â”œâ”€â”€ application.module.ts    # åº”ç”¨å±‚æ¨¡å—
â””â”€â”€ index.ts                 # å¯¼å‡ºæ–‡ä»¶
```

## ğŸ”„ å·¥ä½œæµç¨‹

### å‘½ä»¤å¤„ç†æµç¨‹

1. å®¢æˆ·ç«¯è°ƒç”¨åº”ç”¨æœåŠ¡æ–¹æ³•
2. åº”ç”¨æœåŠ¡åˆ›å»ºå‘½ä»¤å¯¹è±¡
3. åº”ç”¨æœåŠ¡é€šè¿‡å‘½ä»¤æ€»çº¿å‘é€å‘½ä»¤
4. å‘½ä»¤æ€»çº¿æ ¹æ®å‘½ä»¤ç±»å‹è·¯ç”±åˆ°å¯¹åº”çš„å¤„ç†å™¨
5. å‘½ä»¤å¤„ç†å™¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘
6. è¿”å›å¤„ç†ç»“æœ

### æŸ¥è¯¢å¤„ç†æµç¨‹

1. å®¢æˆ·ç«¯è°ƒç”¨åº”ç”¨æœåŠ¡æ–¹æ³•
2. åº”ç”¨æœåŠ¡åˆ›å»ºæŸ¥è¯¢å¯¹è±¡
3. åº”ç”¨æœåŠ¡é€šè¿‡æŸ¥è¯¢æ€»çº¿å‘é€æŸ¥è¯¢
4. æŸ¥è¯¢æ€»çº¿æ ¹æ®æŸ¥è¯¢ç±»å‹è·¯ç”±åˆ°å¯¹åº”çš„å¤„ç†å™¨
5. æŸ¥è¯¢å¤„ç†å™¨æ‰§è¡ŒæŸ¥è¯¢é€»è¾‘
6. è¿”å›æŸ¥è¯¢ç»“æœ

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºç”¨æˆ·

```typescript
// åœ¨åº”ç”¨æœåŠ¡ä¸­
async createUser(createUserDto: CreateUserDto): Promise<UserDto> {
  const command = new CreateUserCommand(createUserDto);
  return await this.commandBus.execute(command);
}
```

### è·å–ç”¨æˆ·

```typescript
// åœ¨åº”ç”¨æœåŠ¡ä¸­
async getUser(userId: string): Promise<UserDto> {
  const query = new GetUserQuery(userId);
  return await this.queryBus.execute(query);
}
```

## ğŸ¯ ä¼˜åŠ¿

1. **èŒè´£åˆ†ç¦»**: è¯»å†™æ“ä½œå®Œå…¨åˆ†ç¦»ï¼ŒèŒè´£æ¸…æ™°
2. **å¯æ‰©å±•æ€§**: å¯ä»¥ç‹¬ç«‹æ‰©å±•è¯»å†™æ“ä½œ
3. **å¯ç»´æŠ¤æ€§**: æ¯ä¸ªå¤„ç†å™¨èŒè´£å•ä¸€ï¼Œæ˜“äºç»´æŠ¤
4. **å¯æµ‹è¯•æ€§**: æ¯ä¸ªç»„ä»¶éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•
5. **æ€§èƒ½ä¼˜åŒ–**: å¯ä»¥ä¸ºè¯»å†™æ“ä½œä½¿ç”¨ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥

## ğŸ”§ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°å‘½ä»¤

1. åˆ›å»ºå‘½ä»¤ç±»ï¼Œç»§æ‰¿ `BaseCommand`
2. åˆ›å»ºå‘½ä»¤å¤„ç†å™¨ï¼Œå®ç° `ICommandHandler`
3. åœ¨ `application.module.ts` ä¸­æ³¨å†Œå¤„ç†å™¨
4. åœ¨åº”ç”¨æœåŠ¡ä¸­æ·»åŠ å¯¹åº”æ–¹æ³•

### æ·»åŠ æ–°æŸ¥è¯¢

1. åˆ›å»ºæŸ¥è¯¢ç±»ï¼Œç»§æ‰¿ `BaseQuery`
2. åˆ›å»ºæŸ¥è¯¢å¤„ç†å™¨ï¼Œå®ç° `IQueryHandler`
3. åœ¨ `application.module.ts` ä¸­æ³¨å†Œå¤„ç†å™¨
4. åœ¨åº”ç”¨æœåŠ¡ä¸­æ·»åŠ å¯¹åº”æ–¹æ³•

## ğŸ“Š æ€§èƒ½è€ƒè™‘

1. **å‘½ä»¤å¤„ç†**: é€šå¸¸æ¶‰åŠä¸šåŠ¡é€»è¾‘å’ŒæŒä¹…åŒ–ï¼Œæ€§èƒ½è¦æ±‚ç›¸å¯¹è¾ƒä½
2. **æŸ¥è¯¢å¤„ç†**: é€šå¸¸æ¶‰åŠæ•°æ®è¯»å–ï¼Œæ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼Œå¯ä»¥è€ƒè™‘ç¼“å­˜ä¼˜åŒ–
3. **æ€»çº¿è·¯ç”±**: ä½¿ç”¨Mapè¿›è¡Œè·¯ç”±ï¼Œæ€§èƒ½å¼€é”€å¾ˆå°
4. **ä¾èµ–æ³¨å…¥**: åˆ©ç”¨NestJSçš„ä¾èµ–æ³¨å…¥å®¹å™¨ï¼Œé¿å…æ‰‹åŠ¨ç®¡ç†ä¾èµ–

## ğŸ”’ å®‰å…¨è€ƒè™‘

1. **å‘½ä»¤éªŒè¯**: åœ¨å‘½ä»¤å¤„ç†å™¨ä¸­è¿›è¡Œä¸šåŠ¡è§„åˆ™éªŒè¯
2. **æƒé™æ£€æŸ¥**: åœ¨åº”ç”¨æœåŠ¡å±‚è¿›è¡Œæƒé™éªŒè¯
3. **æ•°æ®éªŒè¯**: ä½¿ç”¨DTOè¿›è¡Œè¾“å…¥æ•°æ®éªŒè¯
4. **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰å‘½ä»¤å’ŒæŸ¥è¯¢çš„æ‰§è¡Œæ—¥å¿—
