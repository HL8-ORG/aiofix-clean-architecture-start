# E2E测试文档

## 概述

本目录包含IAM系统的端到端测试，主要用于测试事件溯源系统的核心功能。

## 测试结构

```
test/e2e/
├── jest-e2e.json              # E2E测试Jest配置
├── jest-e2e.setup.ts          # E2E测试设置文件
├── README.md                  # 本文档
└── event-sourcing/            # 事件溯源系统测试
    ├── event-sourcing-system.e2e-spec.ts    # 完整的事件溯源系统测试
    └── event-sourcing-basic.e2e-spec.ts     # 基础事件溯源测试
```

## 运行测试

### 运行所有E2E测试

```bash
# 在apps/api目录下
pnpm test:e2e

# 或者使用npm
npm run test:e2e

# 或者使用yarn
yarn test:e2e
```

### 运行特定测试文件

```bash
# 运行基础事件溯源测试
pnpm test:e2e event-sourcing-basic.e2e-spec.ts

# 运行完整事件溯源测试
pnpm test:e2e event-sourcing-system.e2e-spec.ts
```

### 运行测试并生成覆盖率报告

```bash
pnpm test:e2e --coverage
```

## 测试场景

### 事件溯源基础测试 (event-sourcing-basic.e2e-spec.ts)

1. **事件存储测试**
   - 单个事件存储
   - 多个事件存储
   - 事件存储结果验证

2. **事件查询测试**
   - 聚合事件查询
   - 事件数据验证

3. **服务健康检查测试**
   - 服务健康状态检查
   - 系统统计信息收集

4. **性能测试**
   - 并发事件存储
   - 性能指标验证

### 事件溯源完整测试 (event-sourcing-system.e2e-spec.ts)

1. **事件存储和查询测试**
   - 事件存储和查询
   - 多事件序列管理

2. **事件发布测试**
   - 事件发布功能
   - 发布结果验证

3. **事件重放测试**
   - 聚合状态重建
   - 状态构建器验证

4. **事件投影测试**
   - 事件投影执行
   - 投影数据查询

5. **快照管理测试**
   - 快照创建和查询
   - 快照数据验证

6. **性能测试**
   - 并发事件处理
   - 性能指标监控

7. **监控和统计测试**
   - 系统统计信息
   - 健康状态监控

## 测试配置

### Jest配置 (jest-e2e.json)

- **测试环境**: Node.js
- **测试超时**: 60秒
- **测试文件匹配**: `*.e2e-spec.ts`
- **覆盖率**: 可选生成
- **详细输出**: 启用

### 测试设置 (jest-e2e.setup.ts)

- **全局超时设置**: 60秒
- **错误处理**: 未处理异常和拒绝
- **测试生命周期**: 全局设置和清理

## 测试数据

### 模拟事件数据

测试使用模拟的业务事件数据，包括：

- **租户事件**: 租户创建、更新等
- **用户事件**: 用户创建、激活等
- **系统事件**: 系统启动、维护等

### 测试聚合根

- **Tenant**: 租户聚合根
- **User**: 用户聚合根
- **System**: 系统聚合根

## 注意事项

### 环境要求

1. **数据库**: 需要可用的PostgreSQL数据库
2. **Redis**: 需要可用的Redis缓存服务
3. **网络**: 确保数据库和缓存服务可访问

### 测试隔离

- 每个测试用例使用独立的聚合根ID
- 测试完成后自动清理资源
- 避免测试间的数据干扰

### 性能考虑

- 测试超时设置为60秒
- 并发测试限制在合理范围内
- 大量数据测试使用较小的数据集

## 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查数据库服务是否运行
   - 验证连接配置是否正确

2. **Redis连接失败**
   - 检查Redis服务是否运行
   - 验证Redis配置是否正确

3. **测试超时**
   - 检查网络连接
   - 增加测试超时时间
   - 检查系统资源使用情况

### 调试技巧

1. **启用详细日志**
   ```bash
   pnpm test:e2e --verbose
   ```

2. **运行单个测试**
   ```bash
   pnpm test:e2e --testNamePattern="应该能够存储单个事件"
   ```

3. **调试模式运行**
   ```bash
   pnpm test:debug
   ```

## 扩展测试

### 添加新的测试场景

1. 在相应目录下创建新的测试文件
2. 遵循命名规范：`*.e2e-spec.ts`
3. 使用描述性的测试用例名称
4. 添加适当的超时设置

### 测试最佳实践

1. **测试独立性**: 每个测试应该独立运行
2. **数据清理**: 测试完成后清理测试数据
3. **错误处理**: 适当处理异常情况
4. **性能监控**: 监控测试执行时间
5. **文档化**: 为复杂测试添加注释

## 持续集成

### CI/CD集成

E2E测试可以集成到CI/CD流程中：

```yaml
# GitHub Actions示例
- name: Run E2E Tests
  run: |
    cd apps/api
    pnpm test:e2e
```

### 测试报告

- 测试结果自动生成报告
- 失败测试提供详细错误信息
- 性能指标记录和趋势分析
